<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="B√ºt√ße">
<meta name="theme-color" content="#6c5ce7">
<title>B√ºt√ße Takip</title>

<!-- PWA Icons -->
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%236c5ce7' width='100' height='100' rx='20'/><text x='50' y='62' text-anchor='middle' font-size='45' fill='white'>üí∞</text></svg>">


<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>


<style>
:root {
--bg-primary: #f5f7fa;
--bg-secondary: #ffffff;
--bg-card: #ffffff;
--text-primary: #1a202c;
--text-secondary: #64748b;
--accent-income: #10b981;
--accent-income-light: #ecfdf5;
--accent-expense: #f43f5e;
--accent-expense-light: #fff1f2;
--accent-main: #0891b2;
--accent-main-light: #ecfeff;
--accent-main-dark: #0e7490;
--accent-warning: #f59e0b;
--accent-warning-light: #fffbeb;
--border-color: #e2e8f0;
--shadow: 0 4px 24px rgba(0,0,0,0.06);
--shadow-lg: 0 10px 40px rgba(0,0,0,0.1);
--safe-top: env(safe-area-inset-top);
--safe-bottom: env(safe-area-inset-bottom);
}

.dark {
--bg-primary: #0f172a;
--bg-secondary: #1e293b;
--bg-card: #1e293b;
--text-primary: #f1f5f9;
--text-secondary: #94a3b8;
--accent-income: #34d399;
--accent-income-light: rgba(52, 211, 153, 0.15);
--accent-expense: #fb7185;
--accent-expense-light: rgba(251, 113, 133, 0.15);
--accent-main: #22d3ee;
--accent-main-light: rgba(34, 211, 238, 0.15);
--accent-main-dark: #06b6d4;
--accent-warning: #fbbf24;
--accent-warning-light: rgba(251, 191, 36, 0.15);
--border-color: #334155;
--shadow: 0 4px 24px rgba(0,0,0,0.4);
--shadow-lg: 0 10px 40px rgba(0,0,0,0.5);
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
-webkit-tap-highlight-color: transparent;
}

body {
font-family: 'Nunito', -apple-system, sans-serif;
background: var(--bg-primary);
color: var(--text-primary);
min-height: 100vh;
min-height: -webkit-fill-available;
padding-bottom: calc(100px + var(--safe-bottom));
overscroll-behavior: none;
}

.header {
background: linear-gradient(135deg, #0891b2 0%, #0ea5e9 50%, #38bdf8 100%);
padding: calc(12px + var(--safe-top)) 20px 16px;
color: white;
position: sticky;
top: 0;
z-index: 100;
box-shadow: 0 4px 20px rgba(8, 145, 178, 0.3);
}

.header-top {
display: flex;
justify-content: space-between;
align-items: center;
}

.header-brand {
display: flex;
flex-direction: column;
}

.header h1 {
font-size: 1.5rem;
font-weight: 800;
display: flex;
align-items: center;
gap: 10px;
letter-spacing: -0.5px;
}

.header h1 i {
font-size: 1.3rem;
background: rgba(255,255,255,0.2);
padding: 8px;
border-radius: 10px;
}

.header-credit {
font-size: 0.7rem;
opacity: 0.8;
font-weight: 500;
margin-top: 2px;
letter-spacing: 0.5px;
}

.header-actions {
display: flex;
gap: 6px;
}

.header-btn {
background: rgba(255,255,255,0.15);
backdrop-filter: blur(10px);
border: 1px solid rgba(255,255,255,0.2);
width: 38px;
height: 38px;
border-radius: 10px;
color: white;
font-size: 1rem;
cursor: pointer;
transition: all 0.2s ease;
}

.header-btn:hover {
background: rgba(255,255,255,0.25);
transform: translateY(-2px);
}

.header-btn:active {
background: rgba(255,255,255,0.35);
transform: scale(0.95);
}

.year-selector {
display: flex;
align-items: center;
justify-content: center;
gap: 16px;
padding: 16px;
background: var(--bg-card);
margin: -12px 16px 16px;
border-radius: 16px;
box-shadow: var(--shadow-lg);
border: 1px solid var(--border-color);
}

.year-btn {
background: var(--bg-secondary);
border: 2px solid var(--border-color);
width: 40px;
height: 40px;
border-radius: 12px;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
color: var(--text-secondary);
font-size: 1rem;
transition: all 0.2s;
}

.year-btn:active { transform: scale(0.95); }

.year-display {
font-size: 1.4rem;
font-weight: 800;
color: var(--accent-main);
}

.view-toggle {
display: flex;
margin: 0 16px 12px;
background: var(--bg-card);
border-radius: 12px;
padding: 4px;
box-shadow: var(--shadow);
}

.view-btn {
flex: 1;
padding: 10px;
text-align: center;
border-radius: 10px;
font-weight: 700;
font-size: 0.85rem;
cursor: pointer;
border: none;
background: transparent;
color: var(--text-secondary);
transition: all 0.2s;
}

.view-btn.active {
background: var(--accent-main);
color: white;
}

.month-selector {
display: flex;
align-items: center;
justify-content: center;
gap: 20px;
margin: 0 16px 12px;
}

.month-nav-btn {
background: var(--bg-card);
border: 2px solid var(--border-color);
width: 36px;
height: 36px;
border-radius: 10px;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
color: var(--text-secondary);
transition: all 0.2s;
}

.month-nav-btn:active { transform: scale(0.95); }

.month-display {
font-size: 1.1rem;
font-weight: 800;
color: var(--accent-main);
min-width: 80px;
text-align: center;
}

.chart-container {
padding: 0 16px 16px;
}

.chart-card {
background: var(--bg-card);
border-radius: 16px;
padding: 16px;
box-shadow: var(--shadow);
}

.chart-title {
font-size: 0.85rem;
font-weight: 700;
color: var(--text-secondary);
margin-bottom: 12px;
text-align: center;
}

.chart-card canvas {
max-height: 200px;
}

.summary-grid {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 12px;
padding: 0 16px 16px;
}

.summary-card {
background: var(--bg-card);
border-radius: 16px;
padding: 16px;
box-shadow: var(--shadow);
border: 1px solid var(--border-color);
position: relative;
overflow: hidden;
}

.summary-card::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
height: 3px;
background: var(--accent-main);
}

.summary-card.income::before { background: linear-gradient(90deg, #10b981, #34d399); }
.summary-card.expense::before { background: linear-gradient(90deg, #f43f5e, #fb7185); }

.summary-card.full { grid-column: 1 / -1; }
.summary-card.full::before { background: linear-gradient(90deg, var(--accent-main), #38bdf8); }

.summary-card .label {
font-size: 0.7rem;
color: var(--text-secondary);
text-transform: uppercase;
letter-spacing: 0.5px;
font-weight: 700;
margin-bottom: 6px;
display: flex;
align-items: center;
gap: 6px;
}

.summary-card .label i {
font-size: 0.8rem;
}

.summary-card .amount {
font-size: 1.4rem;
font-weight: 800;
letter-spacing: -0.5px;
}

.summary-card .sub-amount {
font-size: 0.75rem;
color: var(--text-secondary);
margin-top: 2px;
}

.fact-row {
display: flex;
justify-content: space-between;
font-size: 0.75rem;
color: var(--text-secondary);
margin-top: 8px;
padding-top: 8px;
border-top: 1px dashed var(--border-color);
}

.fact-row span:last-child {
font-weight: 700;
}

.summary-card.income .amount { color: var(--accent-income); }
.summary-card.expense .amount { color: var(--accent-expense); }
.summary-card .amount.positive { color: var(--accent-income); }
.summary-card .amount.negative { color: var(--accent-expense); }

.plan-fact-bar {
height: 6px;
background: var(--border-color);
border-radius: 3px;
margin-top: 10px;
overflow: hidden;
}

.plan-fact-fill {
height: 100%;
border-radius: 3px;
transition: width 0.4s ease;
}

.plan-fact-fill.under { background: linear-gradient(90deg, #10b981, #34d399); }
.plan-fact-fill.over { background: linear-gradient(90deg, #f43f5e, #fb7185); }
.plan-fact-fill.warning { background: linear-gradient(90deg, #f59e0b, #fbbf24); }

.tabs {
display: flex;
margin: 0 16px 16px;
background: var(--bg-card);
border-radius: 14px;
padding: 5px;
box-shadow: var(--shadow);
border: 1px solid var(--border-color);
}

.tab {
flex: 1;
padding: 12px 8px;
text-align: center;
border-radius: 10px;
font-weight: 700;
font-size: 0.85rem;
cursor: pointer;
transition: all 0.2s;
color: var(--text-secondary);
border: none;
background: transparent;
}

.tab.active {
background: linear-gradient(135deg, #0891b2, #0ea5e9);
color: white;
box-shadow: 0 2px 8px rgba(8, 145, 178, 0.3);
}

.section {
padding: 0 16px;
display: none;
}

.section.active { display: block; }

.section-title {
font-size: 0.95rem;
font-weight: 700;
margin-bottom: 12px;
color: var(--text-primary);
display: flex;
align-items: center;
justify-content: space-between;
}

.budget-item {
background: var(--bg-card);
border-radius: 16px;
padding: 16px;
margin-bottom: 12px;
box-shadow: var(--shadow);
}

.budget-header {
display: flex;
align-items: center;
justify-content: space-between;
margin-bottom: 12px;
}

.budget-left {
display: flex;
align-items: center;
gap: 12px;
}

.budget-icon {
width: 44px;
height: 44px;
border-radius: 12px;
display: flex;
align-items: center;
justify-content: center;
font-size: 1.2rem;
}

.budget-icon.income {
background: var(--accent-income-light);
color: var(--accent-income);
}

.budget-icon.expense {
background: var(--accent-expense-light);
color: var(--accent-expense);
}

.budget-info h3 {
font-size: 1rem;
font-weight: 700;
}

.budget-info span {
font-size: 0.75rem;
color: var(--text-secondary);
}

.budget-actions {
display: flex;
gap: 4px;
}

.budget-stats {
display: grid;
grid-template-columns: 1fr 1fr 1fr;
gap: 8px;
margin-bottom: 10px;
}

.stat-box {
text-align: center;
padding: 10px 8px;
background: var(--bg-secondary);
border-radius: 10px;
}

.stat-box .stat-label {
font-size: 0.65rem;
color: var(--text-secondary);
text-transform: uppercase;
font-weight: 700;
}

.stat-box .stat-value {
font-size: 0.9rem;
font-weight: 800;
margin-top: 2px;
}

.stat-box .stat-value.plan { color: var(--accent-main); }
.stat-box .stat-value.fact { color: var(--text-primary); }
.stat-box .stat-value.diff.positive { color: var(--accent-income); }
.stat-box .stat-value.diff.negative { color: var(--accent-expense); }

.stat-box .stat-sub {
font-size: 0.65rem;
color: var(--text-secondary);
margin-top: 2px;
opacity: 0.8;
}

.daily-budget-info {
background: var(--bg-secondary);
border-radius: 10px;
padding: 10px 12px;
margin-top: 10px;
border: 1px dashed var(--border-color);
}

.daily-item {
display: flex;
justify-content: space-between;
align-items: center;
padding: 4px 0;
font-size: 0.8rem;
}

.daily-item:not(:last-child) {
border-bottom: 1px dotted var(--border-color);
}

.daily-label {
color: var(--text-secondary);
}

.daily-value {
font-weight: 700;
color: var(--text-primary);
}

.daily-value.positive {
color: var(--accent-income);
}

.daily-value.negative {
color: var(--accent-expense);
}

.daily-value small {
font-weight: 400;
opacity: 0.7;
}

/* B√ºt√ße √ñzeti Stili */
.budget-summary-section {
margin: 16px;
background: var(--bg-card);
border-radius: 16px;
padding: 16px;
box-shadow: var(--shadow);
}

.summary-title {
font-weight: 700;
font-size: 1rem;
color: var(--text-primary);
margin-bottom: 12px;
padding-bottom: 8px;
border-bottom: 2px solid var(--accent-main);
}

.currency-summary-grid {
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 12px;
}

.currency-card {
background: var(--bg-secondary);
border-radius: 12px;
padding: 12px;
text-align: center;
border: 2px solid var(--border-color);
}

.currency-card.usd { border-color: #27ae60; }
.currency-card.try { border-color: #e74c3c; }
.currency-card.rub { border-color: #3498db; }

.currency-symbol {
font-size: 1.5rem;
font-weight: 800;
margin-bottom: 4px;
}

.currency-card.usd .currency-symbol { color: #27ae60; }
.currency-card.try .currency-symbol { color: #e74c3c; }
.currency-card.rub .currency-symbol { color: #3498db; }

.currency-label {
font-size: 0.7rem;
color: var(--text-secondary);
margin-bottom: 8px;
}

.currency-row {
display: flex;
justify-content: space-between;
font-size: 0.75rem;
padding: 3px 0;
border-bottom: 1px dotted var(--border-color);
}

.currency-row:last-child {
border-bottom: none;
padding-top: 6px;
font-weight: 700;
}

.currency-row.income { color: var(--accent-income); }
.currency-row.expense { color: var(--accent-expense); }
.currency-row.net.positive { color: var(--accent-income); }
.currency-row.net.negative { color: var(--accent-expense); }

.original-currency {
font-size: 0.7rem;
color: var(--accent-main);
font-weight: 600;
display: block;
margin-top: 2px;
}

/* Cash Flow Stili */
.cashflow-section {
margin: 16px;
background: var(--bg-card);
border-radius: 16px;
padding: 16px;
box-shadow: var(--shadow);
}

.cashflow-table-wrapper {
overflow-x: auto;
margin-bottom: 12px;
}

.cashflow-table {
width: 100%;
border-collapse: collapse;
font-size: 0.7rem;
min-width: 600px;
}

.cashflow-table th,
.cashflow-table td {
padding: 8px 6px;
text-align: right;
border-bottom: 1px solid var(--border-color);
}

.cashflow-table th {
background: var(--accent-main);
color: white;
font-weight: 700;
font-size: 0.65rem;
text-transform: uppercase;
position: sticky;
top: 0;
}

.cashflow-table th:first-child,
.cashflow-table td:first-child {
text-align: left;
font-weight: 700;
}

.cashflow-table tbody tr:nth-child(even) {
background: var(--bg-secondary);
}

.cashflow-table tbody tr:hover {
background: var(--accent-main-light);
}

.cashflow-table tbody tr.current-month {
background: var(--accent-warning-light);
font-weight: 700;
}

.cashflow-table .positive {
color: var(--accent-income);
}

.cashflow-table .negative {
color: var(--accent-expense);
}

.cashflow-table tfoot {
background: var(--bg-secondary);
font-weight: 700;
}

.cashflow-table tfoot td {
border-top: 2px solid var(--accent-main);
padding: 10px 6px;
}

.cashflow-summary {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 12px;
margin-top: 12px;
}

.cashflow-card {
background: var(--bg-secondary);
border-radius: 12px;
padding: 12px;
text-align: center;
}

.cashflow-card.savings {
border: 2px solid var(--accent-income);
}

.cashflow-card.spending {
border: 2px solid var(--accent-expense);
}

.cashflow-card-title {
font-size: 0.75rem;
color: var(--text-secondary);
margin-bottom: 6px;
}

.cashflow-card-value {
font-size: 1.1rem;
font-weight: 800;
}

.cashflow-card.savings .cashflow-card-value {
color: var(--accent-income);
}

.cashflow-card.spending .cashflow-card-value {
color: var(--accent-expense);
}

.cashflow-card-sub {
font-size: 0.7rem;
color: var(--text-secondary);
margin-top: 4px;
}

.action-btn {
background: none;
border: none;
color: var(--text-secondary);
padding: 10px;
cursor: pointer;
font-size: 0.9rem;
opacity: 0.6;
transition: opacity 0.2s, color 0.2s;
border-radius: 8px;
}

.action-btn:active { opacity: 1; }
.action-btn.delete:active { color: var(--accent-expense); }
.action-btn.edit:active { color: var(--accent-main); }

.transaction-item {
background: var(--bg-card);
border-radius: 14px;
padding: 14px 16px;
margin-bottom: 10px;
box-shadow: var(--shadow);
}

.transaction-header {
display: flex;
justify-content: space-between;
align-items: center;
}

.transaction-category {
font-size: 0.9rem;
font-weight: 700;
}

.transaction-date {
font-size: 0.75rem;
color: var(--text-secondary);
}

.transaction-details {
display: flex;
justify-content: space-between;
align-items: center;
margin-top: 8px;
}

.transaction-note {
font-size: 0.85rem;
color: var(--text-secondary);
flex: 1;
}

.transaction-amounts { text-align: right; }

.transaction-amount {
font-weight: 800;
font-size: 1.05rem;
}

.transaction-amount.income { color: var(--accent-income); }
.transaction-amount.expense { color: var(--accent-expense); }

.transaction-usd {
font-size: 0.7rem;
color: var(--text-secondary);
}

.transaction-rate {
font-size: 0.65rem;
color: var(--text-secondary);
opacity: 0.7;
}

.add-btn {
background: var(--accent-main);
color: white;
border: none;
padding: 10px 16px;
border-radius: 10px;
font-weight: 700;
font-size: 0.85rem;
cursor: pointer;
display: flex;
align-items: center;
gap: 6px;
transition: transform 0.2s;
}

.add-btn:active { transform: scale(0.95); }

.fab {
position: fixed;
bottom: calc(24px + var(--safe-bottom));
right: 24px;
width: 60px;
height: 60px;
border-radius: 18px;
background: linear-gradient(135deg, #0891b2 0%, #0ea5e9 50%, #38bdf8 100%);
color: white;
border: none;
font-size: 1.5rem;
cursor: pointer;
box-shadow: 0 8px 30px rgba(8, 145, 178, 0.45);
display: flex;
align-items: center;
justify-content: center;
transition: all 0.3s ease;
z-index: 100;
}

.fab:hover {
transform: translateY(-4px);
box-shadow: 0 12px 40px rgba(8, 145, 178, 0.55);
}

.fab:active { transform: scale(0.9); }

.modal-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0,0,0,0.5);
display: none;
align-items: flex-end;
justify-content: center;
z-index: 200;
}

.modal-overlay.active { display: flex; }

.modal {
background: var(--bg-card);
width: 100%;
max-width: 500px;
border-radius: 24px 24px 0 0;
padding: 24px;
padding-bottom: calc(24px + var(--safe-bottom));
max-height: 90vh;
overflow-y: auto;
animation: slideUp 0.3s ease;
}

@keyframes slideUp {
from { transform: translateY(100%); }
to { transform: translateY(0); }
}

.modal-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
}

.modal-header h2 {
font-size: 1.2rem;
font-weight: 800;
}

.modal-close {
background: var(--bg-secondary);
border: none;
font-size: 1.3rem;
cursor: pointer;
color: var(--text-secondary);
width: 36px;
height: 36px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
}

.form-group {
margin-bottom: 18px;
}

.form-group label {
display: block;
font-size: 0.85rem;
font-weight: 700;
margin-bottom: 8px;
color: var(--text-secondary);
}

.form-group input, .form-group select {
width: 100%;
padding: 16px;
border: 2px solid var(--border-color);
border-radius: 14px;
font-size: 16px;
font-family: 'Nunito', sans-serif;
background: var(--bg-secondary);
color: var(--text-primary);
transition: border-color 0.2s;
}

.form-group input:focus, .form-group select:focus {
outline: none;
border-color: var(--accent-main);
}

.type-toggle {
display: flex;
gap: 10px;
margin-bottom: 18px;
}

.type-btn {
flex: 1;
padding: 16px;
border: 2px solid var(--border-color);
border-radius: 14px;
background: var(--bg-secondary);
font-weight: 700;
font-size: 0.95rem;
cursor: pointer;
transition: all 0.2s;
color: var(--text-secondary);
}

.type-btn.income.active {
border-color: var(--accent-income);
background: var(--accent-income-light);
color: var(--accent-income);
}

.type-btn.expense.active {
border-color: var(--accent-expense);
background: var(--accent-expense-light);
color: var(--accent-expense);
}

.currency-toggle {
display: flex;
gap: 8px;
}

.currency-btn {
flex: 1;
padding: 14px 8px;
border: 2px solid var(--border-color);
border-radius: 12px;
background: var(--bg-secondary);
font-weight: 700;
font-size: 0.9rem;
cursor: pointer;
transition: all 0.2s;
color: var(--text-secondary);
}

.currency-btn.active {
border-color: var(--accent-main);
background: var(--accent-main-light);
color: var(--accent-main);
}

/* Toggle Switch */
.toggle-switch {
position: relative;
display: inline-block;
width: 52px;
height: 28px;
}
.toggle-switch input {
opacity: 0;
width: 0;
height: 0;
}
.toggle-slider {
position: absolute;
cursor: pointer;
top: 0;
left: 0;
right: 0;
bottom: 0;
background-color: var(--border-color);
transition: 0.3s;
border-radius: 28px;
}
.toggle-slider:before {
position: absolute;
content: "";
height: 22px;
width: 22px;
left: 3px;
bottom: 3px;
background-color: white;
transition: 0.3s;
border-radius: 50%;
box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.toggle-switch input:checked + .toggle-slider {
background: linear-gradient(135deg, var(--accent-main) 0%, #a29bfe 100%);
}
.toggle-switch input:checked + .toggle-slider:before {
transform: translateX(24px);
}

.submit-btn {
width: 100%;
padding: 16px;
border: none;
border-radius: 12px;
background: linear-gradient(135deg, #0891b2 0%, #0ea5e9 100%);
color: white;
font-size: 1rem;
font-weight: 700;
cursor: pointer;
transition: all 0.2s ease;
margin-top: 12px;
box-shadow: 0 4px 16px rgba(8, 145, 178, 0.3);
}

.submit-btn:hover {
transform: translateY(-2px);
box-shadow: 0 6px 20px rgba(8, 145, 178, 0.4);
}

.submit-btn:active { transform: scale(0.98); }

.monthly-grid {
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 8px;
}

.monthly-input {
display: flex;
flex-direction: column;
gap: 4px;
}

.monthly-input label {
font-size: 0.7rem;
color: var(--text-secondary);
margin: 0;
text-align: center;
}

.monthly-input input {
padding: 10px 8px;
text-align: center;
font-size: 14px;
}

.fill-equal-btn {
background: var(--accent-main-light);
color: var(--accent-main);
border: none;
padding: 4px 10px;
border-radius: 6px;
font-size: 0.75rem;
font-weight: 700;
cursor: pointer;
margin-left: 8px;
}

.fill-equal-btn:active {
transform: scale(0.95);
}

.icon-grid {
display: grid;
grid-template-columns: repeat(6, 1fr);
gap: 8px;
max-height: 140px;
overflow-y: auto;
padding: 10px;
background: var(--bg-secondary);
border-radius: 14px;
border: 2px solid var(--border-color);
}

.icon-option {
width: 100%;
aspect-ratio: 1;
border: none;
border-radius: 10px;
background: var(--bg-card);
cursor: pointer;
font-size: 1.2rem;
display: flex;
align-items: center;
justify-content: center;
transition: all 0.2s;
}

.icon-option.selected {
background: var(--accent-main-light);
box-shadow: 0 0 0 2px var(--accent-main);
}

.empty-state {
text-align: center;
padding: 50px 20px;
color: var(--text-secondary);
}

.empty-state i {
font-size: 3.5rem;
margin-bottom: 16px;
opacity: 0.4;
}

.empty-state p { font-size: 0.95rem; }

.category-select-grid {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 10px;
max-height: 180px;
overflow-y: auto;
}

.category-select-item {
padding: 14px;
border: 2px solid var(--border-color);
border-radius: 12px;
background: var(--bg-secondary);
cursor: pointer;
text-align: center;
transition: all 0.2s;
}

.category-select-item.selected {
border-color: var(--accent-main);
background: var(--accent-main-light);
}

.category-select-item i {
display: block;
font-size: 1.4rem;
margin-bottom: 6px;
}

.category-select-item span {
font-size: 0.85rem;
font-weight: 600;
}

.confirm-modal {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0,0,0,0.5);
display: none;
align-items: center;
justify-content: center;
z-index: 300;
padding: 20px;
}

.confirm-modal.active { display: flex; }

.confirm-box {
background: var(--bg-card);
border-radius: 20px;
padding: 28px;
max-width: 320px;
width: 100%;
text-align: center;
animation: scaleIn 0.2s ease;
}

@keyframes scaleIn {
from { transform: scale(0.9); opacity: 0; }
to { transform: scale(1); opacity: 1; }
}

.confirm-box h3 {
margin-bottom: 12px;
font-size: 1.1rem;
}

.confirm-box p {
color: var(--text-secondary);
font-size: 0.9rem;
margin-bottom: 24px;
}

.confirm-buttons {
display: flex;
gap: 12px;
}

.confirm-buttons button {
flex: 1;
padding: 14px;
border: none;
border-radius: 12px;
font-weight: 700;
font-size: 0.95rem;
cursor: pointer;
}

.confirm-buttons button:active { transform: scale(0.95); }

.confirm-cancel {
background: var(--bg-secondary);
color: var(--text-primary);
border: 2px solid var(--border-color) !important;
}

.confirm-delete {
background: var(--accent-expense);
color: white;
}

.rates-display {
display: flex;
gap: 8px;
flex-wrap: wrap;
margin-top: 10px;
}

.rate-chip {
background: var(--bg-secondary);
padding: 6px 12px;
border-radius: 20px;
font-size: 0.8rem;
font-weight: 600;
color: var(--text-secondary);
}

.month-filter {
display: flex;
gap: 8px;
overflow-x: auto;
padding: 10px 0;
margin-bottom: 14px;
-webkit-overflow-scrolling: touch;
}

.month-chip {
padding: 10px 16px;
background: var(--bg-card);
border: 2px solid var(--border-color);
border-radius: 20px;
font-size: 0.85rem;
font-weight: 700;
cursor: pointer;
white-space: nowrap;
transition: all 0.2s;
color: var(--text-secondary);
}

.month-chip.active {
background: var(--accent-main);
border-color: var(--accent-main);
color: white;
}

.toast {
position: fixed;
bottom: calc(100px + var(--safe-bottom));
left: 50%;
transform: translateX(-50%);
background: linear-gradient(135deg, #1e293b, #334155);
color: white;
padding: 14px 24px;
border-radius: 12px;
font-weight: 600;
font-size: 0.9rem;
z-index: 400;
animation: fadeInUp 0.3s ease;
box-shadow: 0 8px 30px rgba(0,0,0,0.2);
border: 1px solid rgba(255,255,255,0.1);
}

@keyframes fadeInUp {
from { opacity: 0; transform: translateX(-50%) translateY(20px); }
to { opacity: 1; transform: translateX(-50%) translateY(0); }
}

.install-banner {
position: fixed;
bottom: calc(100px + var(--safe-bottom));
left: 16px;
right: 16px;
background: var(--bg-card);
border-radius: 16px;
padding: 16px;
box-shadow: 0 8px 30px rgba(0,0,0,0.2);
z-index: 150;
display: none;
animation: slideUp 0.3s ease;
}

.install-banner.show { display: block; }

.install-banner h3 {
font-size: 1rem;
margin-bottom: 8px;
}

.install-banner p {
font-size: 0.85rem;
color: var(--text-secondary);
margin-bottom: 12px;
}

.install-banner .steps {
font-size: 0.8rem;
color: var(--text-secondary);
background: var(--bg-secondary);
padding: 12px;
border-radius: 10px;
margin-bottom: 12px;
}

.install-banner button {
width: 100%;
padding: 12px;
border: none;
border-radius: 10px;
font-weight: 700;
cursor: pointer;
}

.install-banner .install-close {
background: var(--bg-secondary);
color: var(--text-primary);
}
</style>
</head>
<body>
<header class="header">
<div class="header-top">
<div class="header-brand">
<h1><i class="fas fa-wallet"></i> B√ºt√ße Takip</h1>
<span class="header-credit">made by Da≈üdemir</span>
</div>
<div class="header-actions">
<button class="header-btn" onclick="generatePDFReport()" title="PDF Rapor">
<i class="fas fa-file-pdf"></i>
</button>
<button class="header-btn" onclick="generateExcelReport()" title="Excel Rapor">
<i class="fas fa-file-excel"></i>
</button>
<button class="header-btn" onclick="openDataModal()" title="Veri Y√∂netimi">
<i class="fas fa-database"></i>
</button>
<button class="header-btn" onclick="openRatesModal()" title="D√∂viz Kurlarƒ±">
<i class="fas fa-coins"></i>
</button>
<button class="header-btn" onclick="showInstallBanner()" title="Y√ºkle">
<i class="fas fa-download"></i>
</button>
</div>
</div>
</header>

<div class="year-selector">
<button class="year-btn" onclick="changeYear(-1)"><i class="fas fa-chevron-left"></i></button>
<span class="year-display" id="yearDisplay">2025</span>
<button class="year-btn" onclick="changeYear(1)"><i class="fas fa-chevron-right"></i></button>
</div>

<!-- Aylƒ±k/Yƒ±llƒ±k Toggle -->
<div class="view-toggle" id="viewToggle">
<button class="view-btn active" data-view="monthly">Aylƒ±k</button>
<button class="view-btn" data-view="yearly">Yƒ±llƒ±k</button>
</div>

<!-- Ay Se√ßici (Aylƒ±k g√∂r√ºn√ºmde) -->
<div class="month-selector" id="monthSelector">
<button class="month-nav-btn" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
<span class="month-display" id="monthDisplay">Ocak</span>
<button class="month-nav-btn" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
</div>

<div class="summary-grid">
<div class="summary-card income">
<div class="label" id="incomeLabel">Aylƒ±k Gelir Planƒ±</div>
<div class="amount" id="planIncome">$0</div>
<div class="sub-amount" id="planIncomeSub">‚Ç∫0 / ‚ÇΩ0</div>
<div class="fact-row" id="factIncomeRow">
<span id="factIncome">Ger√ßekle≈üen: $0</span>
<span id="factIncomeSub">‚Ç∫0 / ‚ÇΩ0</span>
</div>
<div class="plan-fact-bar">
<div class="plan-fact-fill under" id="incomeBar" style="width: 0%"></div>
</div>
</div>
<div class="summary-card expense">
<div class="label" id="expenseLabel">Aylƒ±k Gider Planƒ±</div>
<div class="amount" id="planExpense">$0</div>
<div class="sub-amount" id="planExpenseSub">‚Ç∫0 / ‚ÇΩ0</div>
<div class="fact-row" id="factExpenseRow">
<span id="factExpense">Ger√ßekle≈üen: $0</span>
<span id="factExpenseSub">‚Ç∫0 / ‚ÇΩ0</span>
</div>
<div class="plan-fact-bar">
<div class="plan-fact-fill under" id="expenseBar" style="width: 0%"></div>
</div>
</div>
<div class="summary-card full">
<div class="label">Net Durum (Ger√ßekle≈üen)</div>
<div class="amount positive" id="netBalance">$0</div>
<div class="sub-amount" id="netBalanceSub">‚Ç∫0 / ‚ÇΩ0</div>
</div>
</div>

<!-- B√ºt√ße √ñzeti - Para Birimi Bazƒ±nda -->
<div class="budget-summary-section" id="budgetSummarySection">
<div class="summary-title">üìä B√ºt√ße √ñzeti (Para Birimi Bazƒ±nda)</div>
<div class="currency-summary-grid" id="currencySummaryGrid"></div>
</div>

<!-- Aylƒ±k Cash Flow -->
<div class="cashflow-section" id="cashflowSection">
<div class="summary-title">üí∞ Aylƒ±k Nakit Akƒ±≈üƒ± (Cash Flow)</div>
<div class="cashflow-table-wrapper">
<table class="cashflow-table" id="cashflowTable">
<thead>
<tr>
<th>Ay</th>
<th>Gelir Plan</th>
<th>Gelir Ger√ß.</th>
<th>Gider Plan</th>
<th>Gider Ger√ß.</th>
<th>Net Plan</th>
<th>Net Ger√ß.</th>
<th>K√ºm√ºlatif</th>
</tr>
</thead>
<tbody id="cashflowBody"></tbody>
<tfoot id="cashflowFoot"></tfoot>
</table>
</div>
<div class="cashflow-summary" id="cashflowSummary"></div>
</div>

<!-- Grafikler -->
<div class="chart-container">
<div class="chart-card">
<div class="chart-title">Aylƒ±k B√ºt√ße vs Ger√ßekle≈üen</div>
<canvas id="monthlyChart"></canvas>
</div>
</div>

<div class="tabs">
<div class="tab active" data-tab="budget">B√ºt√ße</div>
<div class="tab" data-tab="transactions">ƒ∞≈ülemler</div>
</div>

<section class="section active" id="budget-section">
<div class="section-title">
<span>Gelir Kalemleri</span>
<button class="add-btn" onclick="openCategoryModal('income')">
<i class="fas fa-plus"></i> Ekle
</button>
</div>
<div id="incomeBudgets"></div>

<div class="section-title" style="margin-top: 24px;">
<span>Gider Kalemleri</span>
<button class="add-btn" onclick="openCategoryModal('expense')">
<i class="fas fa-plus"></i> Ekle
</button>
</div>
<div id="expenseBudgets"></div>
</section>

<section class="section" id="transactions-section">
<div class="month-filter" id="monthFilter"></div>
<div id="transactionsList"></div>
</section>

<button class="fab" onclick="openTransactionModal()">
<i class="fas fa-plus"></i>
</button>

<!-- Install Banner -->
<div class="install-banner" id="installBanner">
<h3>üì± iPhone'a Y√ºkle</h3>
<p>Bu uygulamayƒ± ana ekranƒ±nƒ±za ekleyebilirsiniz:</p>
<div class="steps">
1Ô∏è‚É£ Safari'de <strong>Payla≈ü</strong> butonuna tƒ±klayƒ±n <i class="fas fa-share-square"></i><br>
2Ô∏è‚É£ <strong>"Ana Ekrana Ekle"</strong> se√ßin<br>
3Ô∏è‚É£ <strong>"Ekle"</strong> butonuna tƒ±klayƒ±n
</div>
<button class="install-close" onclick="hideInstallBanner()">Anladƒ±m</button>
</div>

<!-- Transaction Modal -->
<div class="modal-overlay" id="transactionModal">
<div class="modal">
<div class="modal-header">
<h2>Yeni ƒ∞≈ülem</h2>
<button class="modal-close" onclick="closeModal('transactionModal')">√ó</button>
</div>
<div class="type-toggle">
<button class="type-btn income active" onclick="setTransactionType('income')">
<i class="fas fa-arrow-down"></i> Gelir
</button>
<button class="type-btn expense" onclick="setTransactionType('expense')">
<i class="fas fa-arrow-up"></i> Gider
</button>
</div>
<div class="form-group">
<label>Kategori</label>
<div class="category-select-grid" id="categorySelectGrid"></div>
</div>
<div class="form-group">
<label>Para Birimi</label>
<div class="currency-toggle" id="currencyToggle">
<button class="currency-btn active" data-currency="USD" onclick="selectTransactionCurrency('USD')">$ USD</button>
<button class="currency-btn" data-currency="TRY" onclick="selectTransactionCurrency('TRY')">‚Ç∫ TRY</button>
<button class="currency-btn" data-currency="RUB" onclick="selectTransactionCurrency('RUB')">‚ÇΩ RUB</button>
</div>
<div id="liveRateBox" style="background: var(--accent-main-light); padding: 10px 14px; border-radius: 10px; margin-top: 10px; display: none;">
<div style="display: flex; justify-content: space-between; align-items: center;">
<div>
<span style="font-size: 0.75rem; color: var(--text-secondary);">üì° G√ºncel Kur</span>
<div style="font-weight: 700; color: var(--accent-main); font-size: 1.1rem;" id="liveRateValue">-</div>
</div>
<div style="text-align: right;">
<span style="font-size: 0.75rem; color: var(--text-secondary);">‚âà Dolar Kar≈üƒ±lƒ±ƒüƒ±</span>
<div style="font-weight: 700; color: var(--text-primary); font-size: 1.1rem;" id="liveUsdEquivalent">$0</div>
</div>
</div>
<div style="font-size: 0.65rem; color: var(--text-secondary); margin-top: 6px; text-align: center;" id="liveRateTime"></div>
</div>
<div class="rates-display" id="currentRates"></div>
</div>
<div class="form-group">
<label>Tutar</label>
<input type="number" id="transactionAmount" placeholder="0.00" step="0.01" inputmode="decimal" oninput="updateUsdEquivalent()">
</div>
<div class="form-group">
<label>Not (Opsiyonel)</label>
<input type="text" id="transactionNote" placeholder="A√ßƒ±klama...">
</div>
<div class="form-group">
<label>Tarih</label>
<input type="date" id="transactionDate">
</div>
<button class="submit-btn" onclick="saveTransaction()">Kaydet</button>
</div>
</div>

<!-- Category Modal -->
<div class="modal-overlay" id="categoryModal">
<div class="modal">
<div class="modal-header">
<h2 id="categoryModalTitle">Yeni Kategori</h2>
<button class="modal-close" onclick="closeModal('categoryModal')">√ó</button>
</div>
<div class="form-group">
<label>Kategori Adƒ±</label>
<input type="text" id="categoryName" placeholder="√ñrn: Maa≈ü, Kira...">
</div>
<div class="form-group">
<label>B√ºt√ße Para Birimi</label>
<div class="currency-toggle" id="categoryCurrencyToggle">
<button type="button" class="currency-btn active" data-currency="USD" onclick="setCategoryCurrency('USD')">$ USD</button>
<button type="button" class="currency-btn" data-currency="TRY" onclick="setCategoryCurrency('TRY')">‚Ç∫ TRY</button>
<button type="button" class="currency-btn" data-currency="RUB" onclick="setCategoryCurrency('RUB')">‚ÇΩ RUB</button>
</div>
<div class="rates-display" id="categoryRatesDisplay"></div>
</div>
<div class="form-group">
<label id="yearlyBudgetLabel">Yƒ±llƒ±k B√ºt√ße ($)</label>
<input type="number" id="categoryYearlyBudget" placeholder="0.00" step="0.01" inputmode="decimal">
</div>
<div class="form-group">
<label id="monthlyBudgetLabel">Aylƒ±k B√ºt√ßeler ($) <button type="button" class="fill-equal-btn" onclick="fillEqualMonthly()">E≈üit Daƒüƒ±t</button></label>
<div class="monthly-grid" id="monthlyBudgetGrid"></div>
</div>
<div class="form-group">
<label>ƒ∞kon</label>
<div class="icon-grid" id="iconGrid"></div>
</div>
<button class="submit-btn" onclick="saveCategory()">Kaydet</button>
</div>
</div>

<!-- Edit Budget Modal -->
<div class="modal-overlay" id="editBudgetModal">
<div class="modal">
<div class="modal-header">
<h2>D√ºzenle</h2>
<button class="modal-close" onclick="closeModal('editBudgetModal')">√ó</button>
</div>
<div class="form-group">
<label>Kategori Adƒ±</label>
<input type="text" id="editCategoryName">
</div>
<div class="form-group">
<label>B√ºt√ße Para Birimi</label>
<div class="currency-toggle" id="editCategoryCurrencyToggle">
<button type="button" class="currency-btn active" data-currency="USD" onclick="setEditCategoryCurrency('USD')">$ USD</button>
<button type="button" class="currency-btn" data-currency="TRY" onclick="setEditCategoryCurrency('TRY')">‚Ç∫ TRY</button>
<button type="button" class="currency-btn" data-currency="RUB" onclick="setEditCategoryCurrency('RUB')">‚ÇΩ RUB</button>
</div>
<div class="rates-display" id="editCategoryRatesDisplay"></div>
</div>
<div class="form-group">
<label id="editYearlyBudgetLabel">Yƒ±llƒ±k B√ºt√ße ($)</label>
<input type="number" id="editCategoryYearlyBudget" step="0.01" inputmode="decimal">
</div>
<div class="form-group">
<label id="editMonthlyBudgetLabel">Aylƒ±k B√ºt√ßeler ($) <button type="button" class="fill-equal-btn" onclick="fillEqualMonthlyEdit()">E≈üit Daƒüƒ±t</button></label>
<div class="monthly-grid" id="editMonthlyBudgetGrid"></div>
</div>
<div class="form-group">
<label class="toggle-label">
<span>üìÖ G√ºnl√ºk Takip</span>
<small style="display: block; color: var(--text-secondary); font-weight: normal; font-size: 0.8rem; margin-top: 4px;">Yemek, ula≈üƒ±m gibi g√ºnl√ºk harcamalar i√ßin a√ßƒ±n. Kira, fatura gibi tek seferlik √∂demeler i√ßin kapalƒ± bƒ±rakƒ±n.</small>
</label>
<div class="toggle-switch-container" style="display: flex; align-items: center; margin-top: 8px;">
<label class="toggle-switch">
<input type="checkbox" id="editDailyTracking" onchange="updateDailyTrackingStatus()">
<span class="toggle-slider"></span>
</label>
<span id="dailyTrackingStatus" style="margin-left: 12px; font-size: 0.9rem;">Kapalƒ±</span>
</div>
</div>
<button class="submit-btn" onclick="updateCategory()">G√ºncelle</button>
</div>
</div>

<!-- Data Management Modal -->
<div class="modal-overlay" id="dataModal">
<div class="modal">
<div class="modal-header">
<h2><i class="fas fa-database"></i> Veri Y√∂netimi</h2>
<button class="modal-close" onclick="closeModal('dataModal')">√ó</button>
</div>
<div class="data-info">
<p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 16px; padding: 12px; background: var(--accent-warning-light); border-radius: 10px; border-left: 4px solid var(--accent-warning);">
‚ö†Ô∏è Uygulama g√ºncellendiƒüinde veriler kaybolabilir. Verilerinizi d√ºzenli olarak dƒ±≈üa aktarƒ±n!
</p>
</div>
<div class="data-stats" style="margin-bottom: 20px;">
<div style="display: flex; gap: 10px; flex-wrap: wrap;">
<span class="rate-chip" id="statCategories">0 kategori</span>
<span class="rate-chip" id="statTransactions">0 i≈ülem</span>
</div>
</div>
<div class="form-group">
<label>Dƒ±≈üa Aktar</label>
<button class="submit-btn" onclick="exportData()" style="background: var(--accent-income); margin-top: 0;">
<i class="fas fa-download"></i> JSON ƒ∞ndir
</button>
</div>
<div class="form-group">
<label>ƒ∞√ße Aktar</label>
<input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
<button class="submit-btn" onclick="document.getElementById('importFile').click()" style="background: var(--accent-main); margin-top: 0;">
<i class="fas fa-upload"></i> JSON Y√ºkle
</button>
</div>
<div class="form-group">
<label>T√ºm Verileri Sil</label>
<button class="submit-btn" onclick="confirmClearAllData()" style="background: var(--accent-expense); margin-top: 0;">
<i class="fas fa-trash"></i> Verileri Temizle
</button>
</div>
</div>
</div>

<!-- Exchange Rates Modal -->
<div class="modal-overlay" id="ratesModal">
<div class="modal">
<div class="modal-header">
<h2><i class="fas fa-coins"></i> D√∂viz Kurlarƒ±</h2>
<button class="modal-close" onclick="closeModal('ratesModal')">√ó</button>
</div>
<p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 12px;">
Aylƒ±k kurlarƒ± girin (1 USD = ?)
</p>
<div style="display: flex; gap: 8px; margin-bottom: 16px;">
<button class="auto-rate-btn" onclick="fetchCurrentRates()" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #0984e3, #00b894); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;">
<i class="fas fa-sync-alt" id="fetchRateIcon"></i>
<span>G√ºncel Kurlarƒ± Al</span>
</button>
<button class="auto-rate-btn" onclick="fillAllMonthsWithCurrent()" style="padding: 10px 16px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; font-weight: 500;">
<i class="fas fa-fill"></i> T√ºm√ºne Uygula
</button>
</div>
<div id="currentRateDisplay" style="background: var(--bg-secondary); padding: 10px 14px; border-radius: 8px; margin-bottom: 16px; display: none;">
<div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px;">üì° G√ºncel Kurlar (Canlƒ±)</div>
<div style="display: flex; gap: 20px; font-weight: 600;">
<span>üáπüá∑ 1$ = <span id="liveRateTRY">-</span> ‚Ç∫</span>
<span>üá∑üá∫ 1$ = <span id="liveRateRUB">-</span> ‚ÇΩ</span>
</div>
<div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 4px;" id="rateUpdateTime"></div>
</div>
<div class="form-group">
<label>üáπüá∑ T√ºrk Lirasƒ± (TRY)</label>
<div class="monthly-grid" id="monthlyRatesTRY"></div>
</div>
<div class="form-group">
<label>üá∑üá∫ Rus Rublesi (RUB)</label>
<div class="monthly-grid" id="monthlyRatesRUB"></div>
</div>
<button class="submit-btn" onclick="saveRates()">Kaydet</button>
</div>
</div>

<!-- Confirm Modal -->
<div class="confirm-modal" id="confirmModal">
<div class="confirm-box">
<h3>Silmek istediƒüinize emin misiniz?</h3>
<p id="confirmMessage">Bu i≈ülem geri alƒ±namaz.</p>
<div class="confirm-buttons">
<button class="confirm-cancel" onclick="closeConfirm()">ƒ∞ptal</button>
<button class="confirm-delete" id="confirmDeleteBtn">Sil</button>
</div>
</div>
</div>

<script>
// ==================== DARK MODE ====================
if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
document.documentElement.classList.add('dark');
}
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
document.documentElement.classList.toggle('dark', e.matches);
});

// ==================== DATA STORAGE ====================
const STORAGE_KEY = 'budgetAppData';

function getStorage() {
try {
const testKey = '__test__';
window.localStorage.setItem(testKey, testKey);
window.localStorage.removeItem(testKey);
return window.localStorage;
} catch (e) {
return null;
}
}

let storage = null;
try {
storage = getStorage();
} catch (e) {
storage = null;
}

function saveData() {
if (!storage) return;
try {
const data = { categories, transactions, exchangeRates, monthlyRates, nextCategoryId };
storage.setItem(STORAGE_KEY, JSON.stringify(data));
} catch (e) {
// Storage not available
}
}

function loadData() {
if (!storage) return;
try {
const saved = storage.getItem(STORAGE_KEY);
if (saved) {
const data = JSON.parse(saved);
categories = data.categories || { income: [], expense: [] };
transactions = data.transactions || [];
exchangeRates = data.exchangeRates || { USD: 1, TRY: 38.50, RUB: 96.00 };
// Aylƒ±k kurlarƒ± y√ºkle, yoksa varsayƒ±lan deƒüerleri kullan
if (data.monthlyRates) {
monthlyRates = data.monthlyRates;
} else if (data.exchangeRates) {
// Eski formatƒ± aylƒ±k formata √ßevir
monthlyRates = {
TRY: Array(12).fill(data.exchangeRates.TRY || 38.50),
RUB: Array(12).fill(data.exchangeRates.RUB || 96.00)
};
}
nextCategoryId = data.nextCategoryId || 1;
}
} catch (e) {
// Could not load data
}
}

function getRateForMonth(currency, month) {
if (currency === 'USD') return 1;
return monthlyRates[currency]?.[month] || exchangeRates[currency] || 1;
}

async function getUsdPerUnit(currency) {
  if (currency === 'USD') return 1;

  try {
    const res = await fetch('https://open.er-api.com/v6/latest/USD');
    const data = await res.json();

    const perUSD = data?.rates?.[currency];
    if (!perUSD) throw new Error('Kur yok');

    return 1 / perUSD;
  } catch (e) {
    console.warn('Canlƒ± kur alƒ±namadƒ±, aylƒ±k kura d√º≈ü√ºld√º');
    return getRateForMonth(currency, new Date().getMonth());
  }
}
  
// ==================== APP STATE ====================
let categories = { income: [], expense: [] };
let transactions = [];
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth();
let selectedMonth = 'all';
let viewMode = 'monthly'; // 'monthly' or 'yearly'
let currentTransactionType = 'income';
let currentCategoryType = 'income';
let selectedCategoryId = null;
let selectedIcon = 'fa-tag';
let selectedCurrency = 'USD';
let selectedCategoryCurrency = 'USD';
let selectedEditCategoryCurrency = 'USD';
let editingCategoryId = null;
let nextCategoryId = 1;
let deleteCallback = null;
let monthlyChart = null;

// Aylƒ±k kurlar: her ay i√ßin ayrƒ± kur
let monthlyRates = {
TRY: [38.50, 38.50, 38.50, 38.50, 38.50, 38.50, 38.50, 38.50, 38.50, 38.50, 38.50, 38.50],
RUB: [96.00, 96.00, 96.00, 96.00, 96.00, 96.00, 96.00, 96.00, 96.00, 96.00, 96.00, 96.00]
};

// Geriye uyumluluk i√ßin eski format desteƒüi
let exchangeRates = { USD: 1, TRY: 38.50, RUB: 96.00 };
const currencySymbols = { USD: '$', TRY: '‚Ç∫', RUB: '‚ÇΩ' };
const monthNames = ['Oca', '≈ûub', 'Mar', 'Nis', 'May', 'Haz', 'Tem', 'Aƒüu', 'Eyl', 'Eki', 'Kas', 'Ara'];
const monthNamesFull = ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran', 'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'];
const icons = [
'fa-briefcase', 'fa-laptop', 'fa-chart-line', 'fa-money-bill',
'fa-shopping-cart', 'fa-file-invoice', 'fa-car', 'fa-utensils',
'fa-film', 'fa-heartbeat', 'fa-home', 'fa-graduation-cap',
'fa-plane', 'fa-gift', 'fa-music', 'fa-book',
'fa-gamepad', 'fa-coffee', 'fa-tshirt', 'fa-mobile',
'fa-bolt', 'fa-wifi', 'fa-dumbbell', 'fa-dog',
'fa-baby', 'fa-tools', 'fa-paint-brush', 'fa-camera',
'fa-piggy-bank', 'fa-coins'
];

// ==================== VIEW TOGGLE ====================
document.querySelectorAll('.view-btn').forEach(btn => {
btn.addEventListener('click', () => {
document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
btn.classList.add('active');
viewMode = btn.dataset.view;
document.getElementById('monthSelector').style.display = viewMode === 'monthly' ? 'flex' : 'none';
updateAll();
});
});

function changeMonth(delta) {
currentMonth += delta;
if (currentMonth < 0) { currentMonth = 11; currentYear--; }
if (currentMonth > 11) { currentMonth = 0; currentYear++; }
document.getElementById('yearDisplay').textContent = currentYear;
document.getElementById('monthDisplay').textContent = monthNamesFull[currentMonth];
updateAll();
}

// ==================== TABS ====================
document.querySelectorAll('.tab').forEach(tab => {
tab.addEventListener('click', () => {
document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
tab.classList.add('active');
document.getElementById(`${tab.dataset.tab}-section`).classList.add('active');
});
});

// ==================== HELPERS ====================
function formatCurrency(amount, currency = 'USD') {
const symbol = currencySymbols[currency] || '$';
return symbol + Math.abs(amount).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function changeYear(delta) {
currentYear += delta;
document.getElementById('yearDisplay').textContent = currentYear;
updateAll();
}

function getYearTransactions() {
return transactions.filter(t => new Date(t.date).getFullYear() === currentYear);
}

// ==================== SUMMARY ====================
function getCategoryYearlyPlan(cat, year = currentYear) {
// Yƒ±l bazƒ±nda b√ºt√ße kontrol√º
const yearBudget = cat.budgets && cat.budgets[year];
if (yearBudget) {
// Bu yƒ±l i√ßin b√ºt√ße objesi var
if (yearBudget.monthlyBudgets && Array.isArray(yearBudget.monthlyBudgets) && yearBudget.monthlyBudgets.length > 0) {
const sum = yearBudget.monthlyBudgets.reduce((a, b) => a + (b || 0), 0);
if (sum > 0) return sum;
}
if (typeof yearBudget.yearlyBudget === 'number' && yearBudget.yearlyBudget > 0) {
return yearBudget.yearlyBudget;
}
// Yeni formatta deƒüerler 0 ise, eski formata BAK (ge√ßi≈ü d√∂nemi desteƒüi)
}
// Eski format desteƒüi (geriye uyumluluk) - array uzunluƒüu ne olursa olsun topla
if (cat.monthlyBudgets && Array.isArray(cat.monthlyBudgets) && cat.monthlyBudgets.length > 0) {
const sum = cat.monthlyBudgets.reduce((a, b) => a + (b || 0), 0);
if (sum > 0) return sum;
}
if (cat.yearlyBudget) return cat.yearlyBudget;
return 0;
}

function getCategoryMonthlyPlan(cat, month, year = currentYear) {
// Yƒ±l bazƒ±nda b√ºt√ße kontrol√º
const yearBudget = cat.budgets && cat.budgets[year];
if (yearBudget) {
// Bu yƒ±l i√ßin b√ºt√ße objesi var
if (yearBudget.monthlyBudgets && Array.isArray(yearBudget.monthlyBudgets) && yearBudget.monthlyBudgets.length > 0) {
const sum = yearBudget.monthlyBudgets.reduce((a, b) => a + (b || 0), 0);
if (sum > 0) return yearBudget.monthlyBudgets[month] || 0;
}
if (typeof yearBudget.yearlyBudget === 'number' && yearBudget.yearlyBudget > 0) {
return yearBudget.yearlyBudget / 12;
}
// Yeni formatta deƒüerler 0 ise, eski formata BAK (ge√ßi≈ü d√∂nemi desteƒüi)
}
// Eski format desteƒüi (geriye uyumluluk) - array uzunluƒüu ne olursa olsun kullan
if (cat.monthlyBudgets && Array.isArray(cat.monthlyBudgets) && cat.monthlyBudgets.length > 0) {
const sum = cat.monthlyBudgets.reduce((a, b) => a + (b || 0), 0);
if (sum > 0) return cat.monthlyBudgets[month] || 0;
}
if (cat.yearlyBudget) return cat.yearlyBudget / 12;
return 0;
}

function getCategoryBudgetCurrency(cat, year = currentYear) {
// Yƒ±l bazƒ±nda b√ºt√ße para birimi
const yearBudget = cat.budgets && cat.budgets[year];
if (yearBudget && yearBudget.budgetCurrency) {
return yearBudget.budgetCurrency;
}
// Eski format desteƒüi
return cat.budgetCurrency || 'USD';
}

function updateSummary() {
const yearTx = getYearTransactions();

let planIncome, planExpense, factIncome, factExpense;
let avgTryRate, avgRubRate;
let txList;

if (viewMode === 'monthly') {
// Aylƒ±k modda
txList = yearTx.filter(t => new Date(t.date).getMonth() === currentMonth);

planIncome = categories.income.reduce((sum, c) => sum + getCategoryMonthlyPlan(c, currentMonth), 0);
planExpense = categories.expense.reduce((sum, c) => sum + getCategoryMonthlyPlan(c, currentMonth), 0);
factIncome = txList.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amountUSD, 0);
factExpense = txList.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amountUSD, 0);

// Aylƒ±k kur
avgTryRate = getRateForMonth('TRY', currentMonth);
avgRubRate = getRateForMonth('RUB', currentMonth);

document.getElementById('incomeLabel').textContent = 'Aylƒ±k Gelir Planƒ±';
document.getElementById('expenseLabel').textContent = 'Aylƒ±k Gider Planƒ±';
} else {
// Yƒ±llƒ±k modda
txList = yearTx;
planIncome = categories.income.reduce((sum, c) => sum + getCategoryYearlyPlan(c), 0);
planExpense = categories.expense.reduce((sum, c) => sum + getCategoryYearlyPlan(c), 0);
factIncome = yearTx.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amountUSD, 0);
factExpense = yearTx.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amountUSD, 0);

// Yƒ±llƒ±k ortalama kur
avgTryRate = monthlyRates.TRY.reduce((a, b) => a + b, 0) / 12;
avgRubRate = monthlyRates.RUB.reduce((a, b) => a + b, 0) / 12;

document.getElementById('incomeLabel').textContent = 'Yƒ±llƒ±k Gelir Planƒ±';
document.getElementById('expenseLabel').textContent = 'Yƒ±llƒ±k Gider Planƒ±';
}

const net = factIncome - factExpense;

// USD values
document.getElementById('planIncome').textContent = formatCurrency(planIncome);
document.getElementById('factIncome').textContent = `Ger√ßekle≈üen: ${formatCurrency(factIncome)}`;
document.getElementById('planExpense').textContent = formatCurrency(planExpense);
document.getElementById('factExpense').textContent = `Ger√ßekle≈üen: ${formatCurrency(factExpense)}`;

// TRY ve RUB values
document.getElementById('planIncomeSub').textContent = `${formatCurrency(planIncome * avgTryRate, 'TRY')} / ${formatCurrency(planIncome * avgRubRate, 'RUB')}`;
document.getElementById('factIncomeSub').textContent = `${formatCurrency(factIncome * avgTryRate, 'TRY')} / ${formatCurrency(factIncome * avgRubRate, 'RUB')}`;
document.getElementById('planExpenseSub').textContent = `${formatCurrency(planExpense * avgTryRate, 'TRY')} / ${formatCurrency(planExpense * avgRubRate, 'RUB')}`;
document.getElementById('factExpenseSub').textContent = `${formatCurrency(factExpense * avgTryRate, 'TRY')} / ${formatCurrency(factExpense * avgRubRate, 'RUB')}`;

const netEl = document.getElementById('netBalance');
netEl.textContent = (net >= 0 ? '+' : '-') + formatCurrency(Math.abs(net));
netEl.className = 'amount ' + (net >= 0 ? 'positive' : 'negative');

document.getElementById('netBalanceSub').textContent = `${net >= 0 ? '+' : '-'}${formatCurrency(Math.abs(net) * avgTryRate, 'TRY')} / ${net >= 0 ? '+' : '-'}${formatCurrency(Math.abs(net) * avgRubRate, 'RUB')}`;

// Income progress bar
const incomePercent = planIncome > 0 ? (factIncome / planIncome) * 100 : 0;
const incomeBar = document.getElementById('incomeBar');
incomeBar.style.width = Math.min(incomePercent, 100) + '%';
incomeBar.className = 'plan-fact-fill ' + (incomePercent >= 100 ? 'under' : incomePercent > 50 ? 'warning' : 'over');

// Expense progress bar
const expensePercent = planExpense > 0 ? (factExpense / planExpense) * 100 : 0;
const expenseBar = document.getElementById('expenseBar');
expenseBar.style.width = Math.min(expensePercent, 100) + '%';
expenseBar.className = 'plan-fact-fill ' + (expensePercent > 100 ? 'over' : expensePercent > 80 ? 'warning' : 'under');

// B√ºt√ße √ñzeti - Para Birimi Bazƒ±nda
updateCurrencySummary(txList, avgTryRate, avgRubRate);

// Cash Flow g√ºncelle
updateCashFlow();

// Update chart
updateChart();
}

function updateCurrencySummary(txList, tryRate, rubRate) {
const container = document.getElementById('currencySummaryGrid');
const isMonthly = viewMode === 'monthly';

// Para birimi bazƒ±nda planlarƒ± hesapla (kategorilerin b√ºt√ße para birimine g√∂re)
const planByCurrency = {
USD: { income: 0, expense: 0 },
TRY: { income: 0, expense: 0 },
RUB: { income: 0, expense: 0 }
};

// Gelir kategorileri - b√ºt√ße para birimine g√∂re grupla
categories.income.forEach(cat => {
const budgetCurrency = getCategoryBudgetCurrency(cat);
const planUSD = isMonthly ? getCategoryMonthlyPlan(cat, currentMonth) : getCategoryYearlyPlan(cat);

if (budgetCurrency === 'TRY') {
planByCurrency.TRY.income += planUSD * tryRate;
} else if (budgetCurrency === 'RUB') {
planByCurrency.RUB.income += planUSD * rubRate;
} else {
planByCurrency.USD.income += planUSD;
}
});

// Gider kategorileri - b√ºt√ße para birimine g√∂re grupla
categories.expense.forEach(cat => {
const budgetCurrency = getCategoryBudgetCurrency(cat);
const planUSD = isMonthly ? getCategoryMonthlyPlan(cat, currentMonth) : getCategoryYearlyPlan(cat);

if (budgetCurrency === 'TRY') {
planByCurrency.TRY.expense += planUSD * tryRate;
} else if (budgetCurrency === 'RUB') {
planByCurrency.RUB.expense += planUSD * rubRate;
} else {
planByCurrency.USD.expense += planUSD;
}
});

// ƒ∞≈ülemleri orijinal para biriminde topla
const factByCurrency = {
USD: { income: 0, expense: 0 },
TRY: { income: 0, expense: 0 },
RUB: { income: 0, expense: 0 }
};

txList.forEach(t => {
if (factByCurrency[t.currency]) {
factByCurrency[t.currency][t.type] += t.amount;
}
});

// Binlik ayra√ß formatƒ± (1234567 ‚Üí 1.234.567)
const fmt = (n) => {
const num = Math.round(Math.abs(n));
const formatted = num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
return n < 0 ? '-' + formatted : formatted;
};

// Her para birimi i√ßin net hesapla
const netUSD = factByCurrency.USD.income - factByCurrency.USD.expense;
const netTRY = factByCurrency.TRY.income - factByCurrency.TRY.expense;
const netRUB = factByCurrency.RUB.income - factByCurrency.RUB.expense;

container.innerHTML = `
<div class="currency-card usd">
<div class="currency-symbol">$</div>
<div class="currency-label">Dolar (USD)</div>
<div class="currency-row" style="color: var(--text-secondary);">
<span>Plan G:</span>
<span>$${fmt(planByCurrency.USD.income)}</span>
</div>
<div class="currency-row income">
<span>Ger√ß. G:</span>
<span>$${fmt(factByCurrency.USD.income)}</span>
</div>
<div class="currency-row" style="color: var(--text-secondary);">
<span>Plan Gd:</span>
<span>$${fmt(planByCurrency.USD.expense)}</span>
</div>
<div class="currency-row expense">
<span>Ger√ß. Gd:</span>
<span>$${fmt(factByCurrency.USD.expense)}</span>
</div>
<div class="currency-row net ${netUSD >= 0 ? 'positive' : 'negative'}">
<span>Net:</span>
<span>${netUSD >= 0 ? '+' : ''}$${fmt(Math.abs(netUSD))}</span>
</div>
</div>
<div class="currency-card try">
<div class="currency-symbol">‚Ç∫</div>
<div class="currency-label">T√ºrk Lirasƒ± (TRY)</div>
<div class="currency-row" style="color: var(--text-secondary);">
<span>Plan G:</span>
<span>‚Ç∫${fmt(planByCurrency.TRY.income)}</span>
</div>
<div class="currency-row income">
<span>Ger√ß. G:</span>
<span>‚Ç∫${fmt(factByCurrency.TRY.income)}</span>
</div>
<div class="currency-row" style="color: var(--text-secondary);">
<span>Plan Gd:</span>
<span>‚Ç∫${fmt(planByCurrency.TRY.expense)}</span>
</div>
<div class="currency-row expense">
<span>Ger√ß. Gd:</span>
<span>‚Ç∫${fmt(factByCurrency.TRY.expense)}</span>
</div>
<div class="currency-row net ${netTRY >= 0 ? 'positive' : 'negative'}">
<span>Net:</span>
<span>${netTRY >= 0 ? '+' : ''}‚Ç∫${fmt(Math.abs(netTRY))}</span>
</div>
</div>
<div class="currency-card rub">
<div class="currency-symbol">‚ÇΩ</div>
<div class="currency-label">Ruble (RUB)</div>
<div class="currency-row" style="color: var(--text-secondary);">
<span>Plan G:</span>
<span>‚ÇΩ${fmt(planByCurrency.RUB.income)}</span>
</div>
<div class="currency-row income">
<span>Ger√ß. G:</span>
<span>‚ÇΩ${fmt(factByCurrency.RUB.income)}</span>
</div>
<div class="currency-row" style="color: var(--text-secondary);">
<span>Plan Gd:</span>
<span>‚ÇΩ${fmt(planByCurrency.RUB.expense)}</span>
</div>
<div class="currency-row expense">
<span>Ger√ß. Gd:</span>
<span>‚ÇΩ${fmt(factByCurrency.RUB.expense)}</span>
</div>
<div class="currency-row net ${netRUB >= 0 ? 'positive' : 'negative'}">
<span>Net:</span>
<span>${netRUB >= 0 ? '+' : ''}‚ÇΩ${fmt(Math.abs(netRUB))}</span>
</div>
</div>
`;
}

function updateCashFlow() {
const yearTx = getYearTransactions();
const tbody = document.getElementById('cashflowBody');
const tfoot = document.getElementById('cashflowFoot');
const summary = document.getElementById('cashflowSummary');

const today = new Date();
const thisMonth = today.getMonth();

let rows = '';
let totalIncomePlan = 0, totalIncomeActual = 0;
let totalExpensePlan = 0, totalExpenseActual = 0;
let cumulativePlan = 0, cumulativeActual = 0;

// Her ay i√ßin hesapla
for (let i = 0; i < 12; i++) {
const monthTx = yearTx.filter(t => new Date(t.date).getMonth() === i);

const incomePlan = categories.income.reduce((sum, c) => sum + getCategoryMonthlyPlan(c, i), 0);
const incomeActual = monthTx.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amountUSD, 0);

const expensePlan = categories.expense.reduce((sum, c) => sum + getCategoryMonthlyPlan(c, i), 0);
const expenseActual = monthTx.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amountUSD, 0);

const netPlan = incomePlan - expensePlan;
const netActual = incomeActual - expenseActual;

cumulativePlan += netPlan;
cumulativeActual += netActual;

totalIncomePlan += incomePlan;
totalIncomeActual += incomeActual;
totalExpensePlan += expensePlan;
totalExpenseActual += expenseActual;

const isCurrentMonth = (today.getFullYear() === currentYear && i === thisMonth);
const isFutureMonth = (today.getFullYear() === currentYear && i > thisMonth) || (today.getFullYear() < currentYear);

rows += `
<tr class="${isCurrentMonth ? 'current-month' : ''}">
<td>${monthNames[i]}</td>
<td>$${incomePlan.toFixed(0)}</td>
<td class="${incomeActual > 0 ? 'positive' : ''}">${isFutureMonth && incomeActual === 0 ? '-' : '$' + incomeActual.toFixed(0)}</td>
<td>$${expensePlan.toFixed(0)}</td>
<td class="${expenseActual > 0 ? 'negative' : ''}">${isFutureMonth && expenseActual === 0 ? '-' : '$' + expenseActual.toFixed(0)}</td>
<td class="${netPlan >= 0 ? 'positive' : 'negative'}">${netPlan >= 0 ? '+' : ''}$${netPlan.toFixed(0)}</td>
<td class="${netActual >= 0 ? 'positive' : 'negative'}">${isFutureMonth && incomeActual === 0 && expenseActual === 0 ? '-' : (netActual >= 0 ? '+' : '') + '$' + netActual.toFixed(0)}</td>
<td class="${cumulativeActual >= 0 ? 'positive' : 'negative'}">${isFutureMonth && incomeActual === 0 && expenseActual === 0 ? '($' + cumulativePlan.toFixed(0) + ')' : (cumulativeActual >= 0 ? '+' : '') + '$' + cumulativeActual.toFixed(0)}</td>
</tr>
`;
}

tbody.innerHTML = rows;

// Toplam satƒ±rƒ± - getCategoryYearlyPlan kullanarak √∂zet kartlarƒ±yla tutarlƒ± hesaplama
const yearlyIncomePlan = categories.income.reduce((sum, c) => sum + getCategoryYearlyPlan(c), 0);
const yearlyExpensePlan = categories.expense.reduce((sum, c) => sum + getCategoryYearlyPlan(c), 0);
const yearlyNetPlan = yearlyIncomePlan - yearlyExpensePlan;
const totalNetActual = totalIncomeActual - totalExpenseActual;

tfoot.innerHTML = `
<tr>
<td>TOPLAM</td>
<td>$${yearlyIncomePlan.toFixed(0)}</td>
<td class="positive">$${totalIncomeActual.toFixed(0)}</td>
<td>$${yearlyExpensePlan.toFixed(0)}</td>
<td class="negative">$${totalExpenseActual.toFixed(0)}</td>
<td class="${yearlyNetPlan >= 0 ? 'positive' : 'negative'}">${yearlyNetPlan >= 0 ? '+' : ''}$${yearlyNetPlan.toFixed(0)}</td>
<td class="${totalNetActual >= 0 ? 'positive' : 'negative'}">${totalNetActual >= 0 ? '+' : ''}$${totalNetActual.toFixed(0)}</td>
<td class="${totalNetActual >= 0 ? 'positive' : 'negative'}">${totalNetActual >= 0 ? '+' : ''}$${totalNetActual.toFixed(0)}</td>
</tr>
`;

// TRY ve RUB i√ßin ortalama kur
const avgTryRate = monthlyRates.TRY.reduce((a, b) => a + b, 0) / 12;
const avgRubRate = monthlyRates.RUB.reduce((a, b) => a + b, 0) / 12;

// Tasarruf √∂zeti - yƒ±llƒ±k plan deƒüerlerini kullan (√∂zet kartlarƒ±yla tutarlƒ±)
const yearlySavingsPlan = yearlyNetPlan;
const yearlySavingsActual = totalNetActual;
const monthlySavingsPlan = yearlySavingsPlan / 12;
const remainingMonths = 12 - thisMonth - 1;
const projectedSavings = totalNetActual + (remainingMonths * monthlySavingsPlan);

summary.innerHTML = `
<div class="cashflow-card savings">
<div class="cashflow-card-title">üìà Yƒ±llƒ±k Tasarruf Planƒ±</div>
<div class="cashflow-card-value">${yearlySavingsPlan >= 0 ? '+' : ''}$${yearlySavingsPlan.toFixed(0)}</div>
<div class="cashflow-card-sub">‚Ç∫${(yearlySavingsPlan * avgTryRate).toFixed(0)} / ‚ÇΩ${(yearlySavingsPlan * avgRubRate).toFixed(0)}</div>
</div>
<div class="cashflow-card ${yearlySavingsActual >= 0 ? 'savings' : 'spending'}">
<div class="cashflow-card-title">üí∞ Ger√ßekle≈üen Tasarruf</div>
<div class="cashflow-card-value">${yearlySavingsActual >= 0 ? '+' : ''}$${yearlySavingsActual.toFixed(0)}</div>
<div class="cashflow-card-sub">‚Ç∫${(yearlySavingsActual * avgTryRate).toFixed(0)} / ‚ÇΩ${(yearlySavingsActual * avgRubRate).toFixed(0)}</div>
</div>
<div class="cashflow-card savings">
<div class="cashflow-card-title">üéØ Aylƒ±k Tasarruf Hedefi</div>
<div class="cashflow-card-value">${monthlySavingsPlan >= 0 ? '+' : ''}$${monthlySavingsPlan.toFixed(0)}</div>
<div class="cashflow-card-sub">‚Ç∫${(monthlySavingsPlan * avgTryRate).toFixed(0)} / ‚ÇΩ${(monthlySavingsPlan * avgRubRate).toFixed(0)}</div>
</div>
<div class="cashflow-card ${projectedSavings >= 0 ? 'savings' : 'spending'}">
<div class="cashflow-card-title">üîÆ Yƒ±l Sonu Tahmini</div>
<div class="cashflow-card-value">${projectedSavings >= 0 ? '+' : ''}$${projectedSavings.toFixed(0)}</div>
<div class="cashflow-card-sub">‚Ç∫${(projectedSavings * avgTryRate).toFixed(0)} / ‚ÇΩ${(projectedSavings * avgRubRate).toFixed(0)}</div>
</div>
`;
}

function updateChart() {
const ctx = document.getElementById('monthlyChart').getContext('2d');
const yearTx = getYearTransactions();

// Prepare data for each month
const incomeData = [];
const expenseData = [];
const incomePlanData = [];
const expensePlanData = [];

for (let i = 0; i < 12; i++) {
const monthTx = yearTx.filter(t => new Date(t.date).getMonth() === i);

incomeData.push(monthTx.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amountUSD, 0));
expenseData.push(monthTx.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amountUSD, 0));
incomePlanData.push(categories.income.reduce((sum, c) => sum + getCategoryMonthlyPlan(c, i), 0));
expensePlanData.push(categories.expense.reduce((sum, c) => sum + getCategoryMonthlyPlan(c, i), 0));
}

// Destroy existing chart if any
if (monthlyChart) {
monthlyChart.destroy();
}

// Chart title based on view mode
const chartTitle = document.querySelector('.chart-title');
chartTitle.textContent = viewMode === 'monthly' ?
`${monthNamesFull[currentMonth]} - Kategori Daƒüƒ±lƒ±mƒ±` :
'Aylƒ±k B√ºt√ße vs Ger√ßekle≈üen';

const isDark = document.documentElement.classList.contains('dark');
const textColor = isDark ? '#a0aec0' : '#636e72';
const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';

if (viewMode === 'yearly') {
// Bar chart for yearly view - showing monthly breakdown
monthlyChart = new Chart(ctx, {
type: 'bar',
data: {
labels: monthNames,
datasets: [
{
label: 'Gelir Planƒ±',
data: incomePlanData,
backgroundColor: 'rgba(0, 184, 148, 0.3)',
borderColor: '#00b894',
borderWidth: 2,
borderRadius: 4,
order: 2
},
{
label: 'Gelir Ger√ßekle≈üen',
data: incomeData,
backgroundColor: '#00b894',
borderColor: '#00b894',
borderWidth: 0,
borderRadius: 4,
order: 1
},
{
label: 'Gider Planƒ±',
data: expensePlanData,
backgroundColor: 'rgba(225, 112, 85, 0.3)',
borderColor: '#e17055',
borderWidth: 2,
borderRadius: 4,
order: 4
},
{
label: 'Gider Ger√ßekle≈üen',
data: expenseData,
backgroundColor: '#e17055',
borderColor: '#e17055',
borderWidth: 0,
borderRadius: 4,
order: 3
}
]
},
options: {
responsive: true,
maintainAspectRatio: true,
plugins: {
legend: {
position: 'bottom',
labels: {
color: textColor,
font: { size: 10, family: 'Nunito' },
boxWidth: 12,
padding: 8
}
}
},
scales: {
x: {
grid: { display: false },
ticks: { color: textColor, font: { size: 10 } }
},
y: {
grid: { color: gridColor },
ticks: {
color: textColor,
font: { size: 10 },
callback: (v) => '$' + v.toLocaleString()
}
}
}
}
});
} else {
// Doughnut chart for monthly view - showing category breakdown
const monthTx = yearTx.filter(t => new Date(t.date).getMonth() === currentMonth);

const expenseByCategory = [];
const categoryLabels = [];
const categoryOriginalAmounts = []; // Orijinal para biriminde tutarlar
const categoryCurrencies = []; // Para birimleri
const categoryColors = [
'#e17055', '#ff7675', '#fd79a8', '#fdcb6e', '#ffeaa7',
'#55efc4', '#00b894', '#74b9ff', '#0984e3', '#a29bfe',
'#6c5ce7', '#b2bec3'
];

const tryRate = getRateForMonth('TRY', currentMonth);
const rubRate = getRateForMonth('RUB', currentMonth);

categories.expense.forEach((cat, index) => {
const catTx = monthTx.filter(t => t.categoryId === cat.id);
const amountUSD = catTx.reduce((sum, t) => sum + t.amountUSD, 0);

if (amountUSD > 0) {
expenseByCategory.push(amountUSD);
categoryLabels.push(cat.name);

// Kategori b√ºt√ße para birimine g√∂re orijinal tutarƒ± hesapla
const budgetCurrency = getCategoryBudgetCurrency(cat);
let originalAmount = 0;

if (budgetCurrency === 'TRY') {
// TRY bazlƒ± kategori - TRY i≈ülemlerini topla, diƒüerlerini √ßevir
originalAmount = catTx.reduce((sum, t) => {
if (t.currency === 'TRY') return sum + t.amount;
if (t.currency === 'USD') return sum + t.amount * tryRate;
if (t.currency === 'RUB') return sum + t.amount * tryRate / rubRate;
return sum;
}, 0);
} else if (budgetCurrency === 'RUB') {
// RUB bazlƒ± kategori - RUB i≈ülemlerini topla, diƒüerlerini √ßevir
originalAmount = catTx.reduce((sum, t) => {
if (t.currency === 'RUB') return sum + t.amount;
if (t.currency === 'USD') return sum + t.amount * rubRate;
if (t.currency === 'TRY') return sum + t.amount * rubRate / tryRate;
return sum;
}, 0);
} else {
// USD bazlƒ± kategori
originalAmount = amountUSD;
}

categoryOriginalAmounts.push(originalAmount);
categoryCurrencies.push(budgetCurrency);
}
});

if (expenseByCategory.length === 0) {
expenseByCategory.push(1);
categoryLabels.push('Veri yok');
categoryOriginalAmounts.push(0);
categoryCurrencies.push('USD');
}

const totalExpense = expenseByCategory.reduce((a, b) => a + b, 0);

// Para birimi sembolleri
const currencySymbols = { USD: '$', TRY: '‚Ç∫', RUB: '‚ÇΩ' };

monthlyChart = new Chart(ctx, {
type: 'doughnut',
data: {
labels: categoryLabels,
datasets: [{
data: expenseByCategory,
backgroundColor: categoryColors.slice(0, expenseByCategory.length),
borderWidth: 0,
hoverOffset: 4
}]
},
options: {
responsive: true,
maintainAspectRatio: true,
cutout: '60%',
plugins: {
legend: {
position: 'right',
labels: {
color: textColor,
font: { size: 10, family: 'Nunito' },
boxWidth: 12,
padding: 6,
generateLabels: function(chart) {
const data = chart.data;
if (data.labels.length && data.datasets.length) {
return data.labels.map((label, i) => {
const value = data.datasets[0].data[i];
const percent = totalExpense > 0 ? ((value / totalExpense) * 100).toFixed(0) : 0;
return {
text: `${label} (${percent}%)`,
fillStyle: data.datasets[0].backgroundColor[i],
hidden: false,
index: i
};
});
}
return [];
}
}
},
tooltip: {
callbacks: {
label: function(context) {
const idx = context.dataIndex;
const valueUSD = context.parsed;
const percent = totalExpense > 0 ? ((valueUSD / totalExpense) * 100).toFixed(1) : 0;

const originalAmount = categoryOriginalAmounts[idx] || 0;
const currency = categoryCurrencies[idx] || 'USD';
const symbol = currencySymbols[currency] || '$';

// Orijinal tutar + Dolar kar≈üƒ±lƒ±ƒüƒ±
const formattedOriginal = originalAmount.toLocaleString('tr-TR', { maximumFractionDigits: 0 });
const formattedUSD = valueUSD.toLocaleString('tr-TR', { maximumFractionDigits: 0 });

if (currency === 'USD') {
return `$${formattedUSD} - %${percent}`;
} else {
return `${symbol}${formattedOriginal} ($${formattedUSD}) - %${percent}`;
}
}
}
}
}
}
});
}
}

// ==================== BUDGETS ====================
function renderBudgets() {
const yearTx = getYearTransactions();
const isMonthly = viewMode === 'monthly';

['income', 'expense'].forEach(type => {
const container = document.getElementById(`${type}Budgets`);
const cats = categories[type];

if (cats.length === 0) {
container.innerHTML = `
<div class="empty-state">
<i class="fas fa-folder-plus"></i>
<p>${type === 'income' ? 'Gelir' : 'Gider'} kalemi ekleyin</p>
</div>
`;
return;
}

// TRY kuru (aylƒ±k veya yƒ±llƒ±k ortalama)
const tryRate = isMonthly
? getRateForMonth('TRY', currentMonth)
: monthlyRates.TRY.reduce((a, b) => a + b, 0) / 12;

// RUB kuru (aylƒ±k veya yƒ±llƒ±k ortalama)
const rubRate = isMonthly
? getRateForMonth('RUB', currentMonth)
: monthlyRates.RUB.reduce((a, b) => a + b, 0) / 12;

container.innerHTML = cats.map(cat => {
// Plan deƒüeri (aylƒ±k veya yƒ±llƒ±k)
const plan = isMonthly
? getCategoryMonthlyPlan(cat, currentMonth)
: getCategoryYearlyPlan(cat);

// ƒ∞≈ülemler (aylƒ±k veya yƒ±llƒ±k)
const txList = isMonthly
? yearTx.filter(t => t.categoryId === cat.id && new Date(t.date).getMonth() === currentMonth)
: yearTx.filter(t => t.categoryId === cat.id);

const fact = txList.reduce((sum, t) => sum + t.amountUSD, 0);
const diff = type === 'income' ? fact - plan : plan - fact;
const percent = plan > 0 ? (fact / plan) * 100 : 0;

// Orijinal para birimlerinde ger√ßekle≈üen tutarlar
const factByCurrency = { USD: 0, TRY: 0, RUB: 0 };
txList.forEach(t => {
if (factByCurrency[t.currency] !== undefined) {
factByCurrency[t.currency] += t.amount;
}
});

// Orijinal para birimi g√∂sterimi (Ger√ßekle≈üen)
let originalCurrencyHtml = '';
const parts = [];
if (factByCurrency.USD > 0) parts.push(`$${factByCurrency.USD.toFixed(0)}`);
if (factByCurrency.TRY > 0) parts.push(`‚Ç∫${factByCurrency.TRY.toFixed(0)}`);
if (factByCurrency.RUB > 0) parts.push(`‚ÇΩ${factByCurrency.RUB.toFixed(0)}`);
if (parts.length > 0) {
originalCurrencyHtml = `<div class="original-currency">üìå ${parts.join(' + ')}</div>`;
}

// Plan i√ßin orijinal para birimi g√∂sterimi
let planOriginalHtml = '';
const budgetCurrency = getCategoryBudgetCurrency(cat, currentYear);
if (budgetCurrency && budgetCurrency !== 'USD' && plan > 0) {
// B√ºt√ße orijinal para birimindeyse, o para biriminde g√∂ster
// Her ayƒ±n planƒ±nƒ± o ayƒ±n kuruyla √ßevirip topla (tutarlƒ±lƒ±k i√ßin)
let planInOriginal;
if (isMonthly) {
planInOriginal = plan * getRateForMonth(budgetCurrency, currentMonth);
} else {
// Yƒ±llƒ±k i√ßin: her ayƒ±n planƒ±nƒ± o ayƒ±n kuruyla √ßevir ve topla
planInOriginal = 0;
for (let i = 0; i < 12; i++) {
const monthPlan = getCategoryMonthlyPlan(cat, i);
const monthRate = getRateForMonth(budgetCurrency, i);
planInOriginal += monthPlan * monthRate;
}
}
const symbol = currencySymbols[budgetCurrency];
planOriginalHtml = `<div class="original-currency">üìå ${symbol}${planInOriginal.toFixed(0)}</div>`;
}

let barClass = type === 'expense'
? (percent > 100 ? 'over' : percent > 80 ? 'warning' : 'under')
: (percent >= 100 ? 'under' : percent > 50 ? 'warning' : 'over');

const planLabel = isMonthly ? 'Aylƒ±k Plan' : 'Yƒ±llƒ±k Plan';
const subtitle = `${txList.length} i≈ülem`;

// G√ºnl√ºk limit hesaplama (sadece aylƒ±k g√∂r√ºn√ºm, gider ve g√ºnl√ºk takip a√ßƒ±k olanlar i√ßin)
let dailySection = '';
if (isMonthly && type === 'expense' && plan > 0 && cat.dailyTracking) {
const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
const today = new Date();
const currentDay = (today.getFullYear() === currentYear && today.getMonth() === currentMonth)
? today.getDate()
: daysInMonth;

// Orijinal para biriminde plan hesapla
const planOriginal = plan * getRateForMonth(budgetCurrency, currentMonth);
const dailyLimitOriginal = planOriginal / daysInMonth;

const dailyLimit = plan / daysInMonth;
const dailyLimitTRY = dailyLimit * tryRate;
const dailyLimitRUB = dailyLimit * rubRate;

// Bug√ºne kadar olmasƒ± gereken toplam harcama
const expectedSpent = dailyLimit * currentDay;

// G√ºnl√ºk ortalama harcama
const dailyAvgSpent = currentDay > 0 ? fact / currentDay : 0;
const dailyAvgSpentTRY = dailyAvgSpent * tryRate;
const dailyAvgSpentRUB = dailyAvgSpent * rubRate;
const dailyAvgSpentOriginal = dailyAvgSpent * getRateForMonth(budgetCurrency, currentMonth);

// Durum: g√ºnl√ºk ortalama, g√ºnl√ºk limitin altƒ±nda mƒ±?
const dailyStatus = dailyAvgSpent <= dailyLimit ? 'positive' : 'negative';
const dailyDiff = dailyLimit - dailyAvgSpent;
const dailyDiffOriginal = dailyLimitOriginal - dailyAvgSpentOriginal;

// Orijinal para birimine g√∂re g√∂sterim formatƒ±
let dailyLimitDisplay, dailyAvgDisplay, dailyDiffDisplay;
const origSymbol = currencySymbols[budgetCurrency] || '$';

if (budgetCurrency === 'TRY') {
dailyLimitDisplay = `${origSymbol}${dailyLimitOriginal.toFixed(0)} <small>(${formatCurrency(dailyLimit)} / ${formatCurrency(dailyLimitRUB, 'RUB')})</small>`;
dailyAvgDisplay = `${origSymbol}${dailyAvgSpentOriginal.toFixed(0)} <small>(${formatCurrency(dailyAvgSpent)} / ${formatCurrency(dailyAvgSpentRUB, 'RUB')})</small>`;
dailyDiffDisplay = `${dailyDiffOriginal >= 0 ? '+' : ''}${origSymbol}${dailyDiffOriginal.toFixed(0)} <small>(${dailyDiff >= 0 ? '+' : ''}${formatCurrency(dailyDiff)} / ${dailyDiff >= 0 ? '+' : ''}${formatCurrency(dailyDiff * rubRate, 'RUB')})</small>`;
} else if (budgetCurrency === 'RUB') {
dailyLimitDisplay = `${origSymbol}${dailyLimitOriginal.toFixed(0)} <small>(${formatCurrency(dailyLimit)} / ${formatCurrency(dailyLimitTRY, 'TRY')})</small>`;
dailyAvgDisplay = `${origSymbol}${dailyAvgSpentOriginal.toFixed(0)} <small>(${formatCurrency(dailyAvgSpent)} / ${formatCurrency(dailyAvgSpentTRY, 'TRY')})</small>`;
dailyDiffDisplay = `${dailyDiffOriginal >= 0 ? '+' : ''}${origSymbol}${dailyDiffOriginal.toFixed(0)} <small>(${dailyDiff >= 0 ? '+' : ''}${formatCurrency(dailyDiff)} / ${dailyDiff >= 0 ? '+' : ''}${formatCurrency(dailyDiff * tryRate, 'TRY')})</small>`;
} else {
// USD - mevcut format
dailyLimitDisplay = `${formatCurrency(dailyLimit)} <small>(${formatCurrency(dailyLimitTRY, 'TRY')} / ${formatCurrency(dailyLimitRUB, 'RUB')})</small>`;
dailyAvgDisplay = `${formatCurrency(dailyAvgSpent)} <small>(${formatCurrency(dailyAvgSpentTRY, 'TRY')} / ${formatCurrency(dailyAvgSpentRUB, 'RUB')})</small>`;
dailyDiffDisplay = `${dailyDiff >= 0 ? '+' : ''}${formatCurrency(dailyDiff)} <small>(${dailyDiff >= 0 ? '+' : ''}${formatCurrency(dailyDiff * tryRate, 'TRY')} / ${dailyDiff >= 0 ? '+' : ''}${formatCurrency(dailyDiff * rubRate, 'RUB')})</small>`;
}

dailySection = `
<div class="daily-budget-info">
<div class="daily-item">
<span class="daily-label">üìÖ G√ºnl√ºk Limit:</span>
<span class="daily-value">${dailyLimitDisplay}</span>
</div>
<div class="daily-item">
<span class="daily-label">üìä G√ºnl√ºk Ortalama:</span>
<span class="daily-value ${dailyStatus}">${dailyAvgDisplay}</span>
</div>
<div class="daily-item">
<span class="daily-label">üìà G√ºnl√ºk Fark:</span>
<span class="daily-value ${dailyStatus}">${dailyDiffDisplay}</span>
</div>
</div>
`;
}

return `
<div class="budget-item">
<div class="budget-header">
<div class="budget-left">
<div class="budget-icon ${type}">
<i class="fas ${cat.icon}"></i>
</div>
<div class="budget-info">
<h3>${cat.name}</h3>
<span>${subtitle}</span>
</div>
</div>
<div class="budget-actions">
<button class="action-btn edit" onclick="openEditBudgetModal(${cat.id})">
<i class="fas fa-pen"></i>
</button>
<button class="action-btn delete" onclick="confirmDelete('category', ${cat.id}, '${type}', '${cat.name}')">
<i class="fas fa-trash"></i>
</button>
</div>
</div>
<div class="budget-stats">
<div class="stat-box">
<div class="stat-label">${planLabel}</div>
<div class="stat-value plan">${formatCurrency(plan)}</div>
<div class="stat-sub">${formatCurrency(plan * tryRate, 'TRY')} / ${formatCurrency(plan * rubRate, 'RUB')}</div>
${planOriginalHtml}
</div>
<div class="stat-box">
<div class="stat-label">Ger√ßekle≈üen</div>
<div class="stat-value fact">${formatCurrency(fact)}</div>
<div class="stat-sub">${formatCurrency(fact * tryRate, 'TRY')} / ${formatCurrency(fact * rubRate, 'RUB')}</div>
${originalCurrencyHtml}
</div>
<div class="stat-box">
<div class="stat-label">Fark</div>
<div class="stat-value diff ${diff >= 0 ? 'positive' : 'negative'}">${diff >= 0 ? '+' : ''}${formatCurrency(diff)}</div>
<div class="stat-sub">${diff >= 0 ? '+' : ''}${formatCurrency(diff * tryRate, 'TRY')} / ${diff >= 0 ? '+' : ''}${formatCurrency(diff * rubRate, 'RUB')}</div>
</div>
</div>
${dailySection}
<div class="plan-fact-bar">
<div class="plan-fact-fill ${barClass}" style="width: ${Math.min(percent, 100)}%"></div>
</div>
</div>
`;
}).join('');
});
}

// ==================== TRANSACTIONS ====================
function renderMonthFilter() {
const container = document.getElementById('monthFilter');
let html = `<div class="month-chip ${selectedMonth === 'all' ? 'active' : ''}" onclick="filterMonth('all')">T√ºm√º</div>`;
for (let i = 0; i < 12; i++) {
html += `<div class="month-chip ${selectedMonth === i ? 'active' : ''}" onclick="filterMonth(${i})">${monthNames[i]}</div>`;
}
container.innerHTML = html;
}

function filterMonth(month) {
selectedMonth = month;
renderMonthFilter();
renderTransactions();
}

function renderTransactions() {
const container = document.getElementById('transactionsList');
let yearTx = getYearTransactions();

if (selectedMonth !== 'all') {
yearTx = yearTx.filter(t => new Date(t.date).getMonth() === selectedMonth);
}

if (yearTx.length === 0) {
container.innerHTML = `
<div class="empty-state">
<i class="fas fa-receipt"></i>
<p>Bu d√∂nemde i≈ülem yok</p>
</div>
`;
return;
}

const sorted = [...yearTx].sort((a, b) => new Date(b.date) - new Date(a.date));

container.innerHTML = sorted.map(t => {
const cat = [...categories.income, ...categories.expense].find(c => c.id === t.categoryId);
const catName = cat ? cat.name : 'Bilinmeyen';
const catIcon = cat ? cat.icon : 'fa-tag';
const date = new Date(t.date);

return `
<div class="transaction-item">
<div class="transaction-header">
<span class="transaction-category">
<i class="fas ${catIcon}"></i> ${catName}
</span>
<span class="transaction-date">${date.getDate()} ${monthNames[date.getMonth()]}</span>
</div>
<div class="transaction-details">
<span class="transaction-note">${t.note || '-'}</span>
<div style="display: flex; align-items: center; gap: 8px;">
<div class="transaction-amounts">
<div class="transaction-amount ${t.type}">
${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount, t.currency)}
</div>
${t.currency !== 'USD' ? `
<div class="transaction-usd">${formatCurrency(t.amountUSD)}</div>
<div class="transaction-rate">${t.rateSource === 'live' ? 'üì°' : 'üìÖ'} @${t.rateAtTime.toFixed(2)}</div>
` : ''}
</div>
<button class="action-btn delete" onclick="confirmDelete('transaction', ${t.id})">
<i class="fas fa-trash"></i>
</button>
</div>
</div>
</div>
`;
}).join('');
}

// ==================== MODALS ====================
function openTransactionModal() {
document.getElementById('transactionModal').classList.add('active');
document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
document.getElementById('transactionAmount').value = '';
document.getElementById('transactionNote').value = '';
selectedCategoryId = null;
selectedCurrency = 'USD';
setTransactionType('income');
renderCategorySelect();
updateCurrencyButtons();
updateCurrentRatesDisplay();
updateLiveRateDisplay();
}

function closeModal(id) {
document.getElementById(id).classList.remove('active');
}

function setTransactionType(type) {
currentTransactionType = type;
document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
document.querySelector(`.type-btn.${type}`).classList.add('active');
selectedCategoryId = null;
renderCategorySelect();
}

function updateCurrencyButtons() {
document.querySelectorAll('.currency-btn').forEach(btn => {
btn.classList.toggle('active', btn.dataset.currency === selectedCurrency);
});
}

function updateCurrentRatesDisplay() {
const txDate = document.getElementById('transactionDate')?.value;
const month = txDate ? new Date(txDate).getMonth() : currentMonth;
const tryRate = getRateForMonth('TRY', month);
const rubRate = getRateForMonth('RUB', month);

document.getElementById('currentRates').innerHTML = `
<span class="rate-chip">${monthNames[month]}: 1$ = ${tryRate.toFixed(2)}‚Ç∫</span>
<span class="rate-chip">${monthNames[month]}: 1$ = ${rubRate.toFixed(2)}‚ÇΩ</span>
`;
}

document.querySelectorAll('.currency-btn').forEach(btn => {
btn.addEventListener('click', (e) => {
e.preventDefault();
selectedCurrency = btn.dataset.currency;
updateCurrencyButtons();
});
});

// Tarih deƒüi≈ütiƒüinde kur g√∂sterimini g√ºncelle
document.getElementById('transactionDate').addEventListener('change', () => {
updateCurrentRatesDisplay();
});

function renderCategorySelect() {
const container = document.getElementById('categorySelectGrid');
const cats = categories[currentTransactionType];

if (cats.length === 0) {
container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--text-secondary); padding: 24px; font-size: 0.9rem;">√ñnce kategori ekleyin ‚Üí</p>';
return;
}

container.innerHTML = cats.map(cat => `
<div class="category-select-item ${selectedCategoryId === cat.id ? 'selected' : ''}"
onclick="selectCategory(${cat.id})">
<i class="fas ${cat.icon}"></i>
<span>${cat.name}</span>
</div>
`).join('');
}

function selectCategory(id) {
selectedCategoryId = id;
renderCategorySelect();
}

async function saveTransaction() {
const amount = parseFloat(document.getElementById('transactionAmount').value);
const note = document.getElementById('transactionNote').value.trim();
const date = document.getElementById('transactionDate').value;

if (!selectedCategoryId) { showToast('Kategori se√ßin'); return; }
if (!amount || amount <= 0) { showToast('Tutar girin'); return; }
if (!date) { showToast('Tarih se√ßin'); return; }

let rateAtTime;
let amountUSD;
let rateSource = 'live'; // 'live' veya 'monthly'

// USD ise kur 1
if (selectedCurrency === 'USD') {
rateAtTime = 1;
amountUSD = amount;
} else {
// √ñnce cache'e bak (modal a√ßƒ±kken zaten √ßekilmi≈ü olmalƒ±)
if (cachedLiveRates[selectedCurrency] && cachedLiveRates.timestamp) {
const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
if (cachedLiveRates.timestamp.getTime() > fiveMinutesAgo) {
rateAtTime = cachedLiveRates[selectedCurrency];
amountUSD = amount / rateAtTime;
rateSource = 'live';
}
}

// Cache'de yoksa veya eskiyse API'den √ßek
if (!rateAtTime) {
const liveRate = await fetchLiveRateForCurrency(selectedCurrency);
if (liveRate) {
rateAtTime = liveRate;
amountUSD = amount / rateAtTime;
rateSource = 'live';
} else {
// Canlƒ± kur alƒ±namazsa aylƒ±k kuru kullan
const txMonth = new Date(date).getMonth();
rateAtTime = getRateForMonth(selectedCurrency, txMonth);
amountUSD = amount / rateAtTime;
rateSource = 'monthly';
}
}
}

const symbol = selectedCurrency === 'TRY' ? '‚Ç∫' : selectedCurrency === 'RUB' ? '‚ÇΩ' : '$';

transactions.push({
id: Date.now(),
type: currentTransactionType,
categoryId: selectedCategoryId,
amount,
currency: selectedCurrency,
amountUSD,
rateAtTime,
rateSource, // Kurun nereden geldiƒüini kaydet
note,
date
});

closeModal('transactionModal');
saveData();
updateAll();

if (selectedCurrency !== 'USD') {
const rateInfo = rateSource === 'live' ? 'üì° Canlƒ±' : 'üìÖ Aylƒ±k';
showToast(`Kaydedildi ‚úì | ${rateInfo} kur: 1$ = ${symbol}${rateAtTime.toFixed(2)}`);
} else {
showToast('Kaydedildi ‚úì');
}
}

// Belirli bir para birimi i√ßin canlƒ± kur √ßek
// Belirli bir para birimi i√ßin canlƒ± kur √ßek (SADECE ER-API)
async function fetchLiveRateForCurrency(currency) {
  try {
    // Cache: son 5 dakika
    const ts = cachedLiveRates.timestamp;
    const tsMs =
      ts instanceof Date ? ts.getTime() :
      typeof ts === "number" ? ts :
      0;

    if (cachedLiveRates[currency] && tsMs) {
      const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
      if (tsMs > fiveMinutesAgo) {
        return cachedLiveRates[currency];
      }
    }

    // ER-API: 1 USD = X TRY/RUB
    const r = await fetch('https://open.er-api.com/v6/latest/USD', { cache: "no-store" });
    if (!r.ok) return null;

    const j = await r.json();
    const rate = Number(j?.rates?.[currency]);

    if (!rate || !isFinite(rate)) return null;

    cachedLiveRates[currency] = rate;       // 1 USD = rate currency
    cachedLiveRates.timestamp = Date.now(); // number olarak sakla
    return rate;
  } catch (e) {
    console.error('Canlƒ± kur alƒ±namadƒ±:', e);
    return null;
  }
}

// Frankfurter API
const response = await fetch(`https://api.frankfurter.app/latest?from=USD&to=${currency}`);
if (response.ok) {
const data = await response.json();
if (data.rates && data.rates[currency]) {
cachedLiveRates[currency] = data.rates[currency];
cachedLiveRates.timestamp = new Date();
return data.rates[currency];
}
}

// Yedek API
const backupResponse = await fetch('https://open.er-api.com/v6/latest/USD');
if (backupResponse.ok) {
const backupData = await backupResponse.json();
if (backupData.rates && backupData.rates[currency]) {
cachedLiveRates[currency] = backupData.rates[currency];
cachedLiveRates.timestamp = new Date();
return backupData.rates[currency];
}
}

return null;
} catch (error) {
console.error('Canlƒ± kur alƒ±namadƒ±:', error);
return null;
}
}

// ƒ∞≈ülem modalƒ±nda para birimi se√ßildiƒüinde
async function selectTransactionCurrency(currency) {
selectedCurrency = currency;
updateCurrencyButtons();
await updateLiveRateDisplay();
updateUsdEquivalent();
}

// Canlƒ± kur g√∂sterimini g√ºncelle
async function updateLiveRateDisplay() {
const liveRateBox = document.getElementById('liveRateBox');
const liveRateValue = document.getElementById('liveRateValue');
const liveRateTime = document.getElementById('liveRateTime');

if (selectedCurrency === 'USD') {
liveRateBox.style.display = 'none';
return;
}

liveRateBox.style.display = 'block';
liveRateValue.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Y√ºkleniyor...';
liveRateTime.textContent = '';

const rate = await fetchLiveRateForCurrency(selectedCurrency);

if (rate) {
const symbol = selectedCurrency === 'TRY' ? '‚Ç∫' : '‚ÇΩ';
liveRateValue.textContent = `1$ = ${symbol}${rate.toFixed(4)}`;
liveRateTime.textContent = `Son g√ºncelleme: ${new Date().toLocaleString('tr-TR')}`;
} else {
// Canlƒ± kur alƒ±namazsa aylƒ±k kuru g√∂ster
const txDate = document.getElementById('transactionDate')?.value;
const month = txDate ? new Date(txDate).getMonth() : currentMonth;
const monthlyRate = getRateForMonth(selectedCurrency, month);
const symbol = selectedCurrency === 'TRY' ? '‚Ç∫' : '‚ÇΩ';
liveRateValue.textContent = `1$ = ${symbol}${monthlyRate.toFixed(4)}`;
liveRateTime.textContent = '‚ö†Ô∏è Aylƒ±k kayƒ±tlƒ± kur kullanƒ±lƒ±yor';
}

updateUsdEquivalent();
}

// Tutar girildiƒüinde dolar kar≈üƒ±lƒ±ƒüƒ±nƒ± hesapla
function updateUsdEquivalent() {
const amount = parseFloat(document.getElementById('transactionAmount').value) || 0;
const liveUsdEquivalent = document.getElementById('liveUsdEquivalent');

if (selectedCurrency === 'USD') {
if (liveUsdEquivalent) liveUsdEquivalent.textContent = `$${amount.toLocaleString('tr-TR', { maximumFractionDigits: 2 })}`;
return;
}

const rate = cachedLiveRates[selectedCurrency];
if (rate && rate > 0) {
const usdAmount = amount / rate;
if (liveUsdEquivalent) {
liveUsdEquivalent.textContent = `$${usdAmount.toLocaleString('tr-TR', { maximumFractionDigits: 2 })}`;
}
} else {
// Aylƒ±k kur kullan
const txDate = document.getElementById('transactionDate')?.value;
const month = txDate ? new Date(txDate).getMonth() : currentMonth;
const monthlyRate = getRateForMonth(selectedCurrency, month);
const usdAmount = monthlyRate > 0 ? amount / monthlyRate : 0;
if (liveUsdEquivalent) {
liveUsdEquivalent.textContent = `$${usdAmount.toLocaleString('tr-TR', { maximumFractionDigits: 2 })}`;
}
}
}

function renderMonthlyBudgetGrid(containerId, values = null) {
const container = document.getElementById(containerId);
container.innerHTML = monthNames.map((month, i) => `
<div class="monthly-input">
<label>${month}</label>
<input type="number" id="${containerId}_${i}" value="${values ? (values[i] || 0) : 0}" step="0.01" inputmode="decimal">
</div>
`).join('');
}

function getMonthlyBudgets(containerId) {
const budgets = [];
for (let i = 0; i < 12; i++) {
const input = document.getElementById(`${containerId}_${i}`);
budgets.push(parseFloat(input?.value) || 0);
}
return budgets;
}

function fillEqualMonthly() {
const yearly = parseFloat(document.getElementById('categoryYearlyBudget').value) || 0;
const monthly = yearly / 12;
for (let i = 0; i < 12; i++) {
const input = document.getElementById(`monthlyBudgetGrid_${i}`);
if (input) input.value = monthly.toFixed(2);
}
}

function fillEqualMonthlyEdit() {
const yearly = parseFloat(document.getElementById('editCategoryYearlyBudget').value) || 0;
const monthly = yearly / 12;
for (let i = 0; i < 12; i++) {
const input = document.getElementById(`editMonthlyBudgetGrid_${i}`);
if (input) input.value = monthly.toFixed(2);
}
}

function openCategoryModal(type) {
currentCategoryType = type;
document.getElementById('categoryModalTitle').textContent =
type === 'income' ? 'Yeni Gelir Kalemi' : 'Yeni Gider Kalemi';
document.getElementById('categoryName').value = '';
document.getElementById('categoryYearlyBudget').value = '';
selectedIcon = 'fa-tag';
selectedCategoryCurrency = 'USD';
updateCategoryCurrencyUI();
renderMonthlyBudgetGrid('monthlyBudgetGrid');
renderIconGrid();
document.getElementById('categoryModal').classList.add('active');
}

function setCategoryCurrency(currency) {
selectedCategoryCurrency = currency;
updateCategoryCurrencyUI();
}

function updateCategoryCurrencyUI() {
const symbol = currencySymbols[selectedCategoryCurrency];
document.getElementById('yearlyBudgetLabel').textContent = `Yƒ±llƒ±k B√ºt√ße (${symbol})`;

// Update monthly budget label (keep button)
const monthlyLabel = document.getElementById('monthlyBudgetLabel');
const btn = monthlyLabel.querySelector('button');
monthlyLabel.innerHTML = `Aylƒ±k B√ºt√ßeler (${symbol}) `;
monthlyLabel.appendChild(btn);

// Update currency buttons
document.querySelectorAll('#categoryCurrencyToggle .currency-btn').forEach(btn => {
btn.classList.toggle('active', btn.dataset.currency === selectedCategoryCurrency);
});

// Show rates
updateCategoryRatesDisplay();
}

function updateCategoryRatesDisplay() {
const avgTryRate = monthlyRates.TRY.reduce((a, b) => a + b, 0) / 12;
const avgRubRate = monthlyRates.RUB.reduce((a, b) => a + b, 0) / 12;

document.getElementById('categoryRatesDisplay').innerHTML = `
<span class="rate-chip">Ort: 1$ = ${avgTryRate.toFixed(2)}‚Ç∫</span>
<span class="rate-chip">Ort: 1$ = ${avgRubRate.toFixed(2)}‚ÇΩ</span>
`;
}

function renderIconGrid() {
document.getElementById('iconGrid').innerHTML = icons.map(icon => `
<button class="icon-option ${selectedIcon === icon ? 'selected' : ''}"
onclick="selectIcon('${icon}')">
<i class="fas ${icon}"></i>
</button>
`).join('');
}

function selectIcon(icon) {
selectedIcon = icon;
renderIconGrid();
}

function saveCategory() {
const name = document.getElementById('categoryName').value.trim();
let yearlyBudget = parseFloat(document.getElementById('categoryYearlyBudget').value) || 0;
let monthlyBudgets = getMonthlyBudgets('monthlyBudgetGrid');

if (!name) { showToast('ƒ∞sim girin'); return; }

// Convert to USD if entered in different currency
if (selectedCategoryCurrency !== 'USD') {
const avgRate = selectedCategoryCurrency === 'TRY'
? monthlyRates.TRY.reduce((a, b) => a + b, 0) / 12
: monthlyRates.RUB.reduce((a, b) => a + b, 0) / 12;

yearlyBudget = yearlyBudget / avgRate;
monthlyBudgets = monthlyBudgets.map((val, i) => {
const rate = getRateForMonth(selectedCategoryCurrency, i);
return val / rate;
});
}

categories[currentCategoryType].push({
id: nextCategoryId++,
name,
yearlyBudget,
monthlyBudgets,
icon: selectedIcon
});

closeModal('categoryModal');
saveData();
updateAll();
showToast('Eklendi ‚úì');
}

function openEditBudgetModal(categoryId) {
const cat = [...categories.income, ...categories.expense].find(c => c.id === categoryId);
if (!cat) return;

editingCategoryId = categoryId;

// Mevcut yƒ±l i√ßin b√ºt√ße bilgilerini al
const yearBudget = cat.budgets && cat.budgets[currentYear];
let yearlyBudgetUSD = 0;
let monthlyBudgetsUSD = [];
let savedCurrency = 'USD';

if (yearBudget) {
yearlyBudgetUSD = yearBudget.yearlyBudget || 0;
monthlyBudgetsUSD = yearBudget.monthlyBudgets || [];
savedCurrency = yearBudget.budgetCurrency || 'USD';
} else {
// Eski format desteƒüi (geriye uyumluluk)
yearlyBudgetUSD = cat.yearlyBudget || 0;
monthlyBudgetsUSD = cat.monthlyBudgets || [];
savedCurrency = cat.budgetCurrency || 'USD';
}

selectedEditCategoryCurrency = savedCurrency;
document.getElementById('editCategoryName').value = cat.name;

// Eƒüer kayƒ±tlƒ± para birimi varsa, o para biriminde g√∂ster
if (savedCurrency !== 'USD') {
const avgRate = savedCurrency === 'TRY'
? monthlyRates.TRY.reduce((a, b) => a + b, 0) / 12
: monthlyRates.RUB.reduce((a, b) => a + b, 0) / 12;
document.getElementById('editCategoryYearlyBudget').value = (yearlyBudgetUSD * avgRate).toFixed(2);

const convertedMonthly = monthlyBudgetsUSD.map((val, i) => {
const rate = getRateForMonth(savedCurrency, i);
return val * rate;
});
renderMonthlyBudgetGrid('editMonthlyBudgetGrid', convertedMonthly);
} else {
document.getElementById('editCategoryYearlyBudget').value = yearlyBudgetUSD;
renderMonthlyBudgetGrid('editMonthlyBudgetGrid', monthlyBudgetsUSD);
}

updateEditCategoryCurrencyUI();

// G√ºnl√ºk takip ayarƒ±nƒ± oku
const dailyTracking = cat.dailyTracking !== undefined ? cat.dailyTracking : false;
document.getElementById('editDailyTracking').checked = dailyTracking;
updateDailyTrackingStatus();

// Modal ba≈ülƒ±ƒüƒ±na yƒ±lƒ± ekle
document.querySelector('#editBudgetModal .modal-header h2').textContent = `${currentYear} B√ºt√ßesi D√ºzenle`;
document.getElementById('editBudgetModal').classList.add('active');
}

function updateDailyTrackingStatus() {
const isChecked = document.getElementById('editDailyTracking').checked;
document.getElementById('dailyTrackingStatus').textContent = isChecked ? 'A√ßƒ±k' : 'Kapalƒ±';
document.getElementById('dailyTrackingStatus').style.color = isChecked ? 'var(--accent-main)' : 'var(--text-secondary)';
}

function setEditCategoryCurrency(currency) {
// Get current values in USD
const cat = [...categories.income, ...categories.expense].find(c => c.id === editingCategoryId);
if (!cat) return;

selectedEditCategoryCurrency = currency;
updateEditCategoryCurrencyUI();

// Yƒ±l bazƒ±nda b√ºt√ße bilgilerini al
const yearBudget = cat.budgets && cat.budgets[currentYear];
let yearlyBudgetUSD = 0;
let monthlyBudgetsUSD = [];

if (yearBudget) {
yearlyBudgetUSD = yearBudget.yearlyBudget || 0;
monthlyBudgetsUSD = yearBudget.monthlyBudgets || [];
} else {
// Eski format desteƒüi
yearlyBudgetUSD = cat.yearlyBudget || 0;
monthlyBudgetsUSD = cat.monthlyBudgets || [];
}

// Convert and display in selected currency
if (currency === 'USD') {
document.getElementById('editCategoryYearlyBudget').value = yearlyBudgetUSD.toFixed(2);
renderMonthlyBudgetGrid('editMonthlyBudgetGrid', monthlyBudgetsUSD);
} else {
const avgRate = currency === 'TRY'
? monthlyRates.TRY.reduce((a, b) => a + b, 0) / 12
: monthlyRates.RUB.reduce((a, b) => a + b, 0) / 12;

document.getElementById('editCategoryYearlyBudget').value = (yearlyBudgetUSD * avgRate).toFixed(2);

const convertedMonthly = monthlyBudgetsUSD.map((val, i) => {
const rate = getRateForMonth(currency, i);
return val * rate;
});
renderMonthlyBudgetGrid('editMonthlyBudgetGrid', convertedMonthly);
}
}

function updateEditCategoryCurrencyUI() {
const symbol = currencySymbols[selectedEditCategoryCurrency];
document.getElementById('editYearlyBudgetLabel').textContent = `Yƒ±llƒ±k B√ºt√ße (${symbol})`;

// Update monthly budget label (keep button)
const monthlyLabel = document.getElementById('editMonthlyBudgetLabel');
const btn = monthlyLabel.querySelector('button');
monthlyLabel.innerHTML = `Aylƒ±k B√ºt√ßeler (${symbol}) `;
monthlyLabel.appendChild(btn);

// Update currency buttons
document.querySelectorAll('#editCategoryCurrencyToggle .currency-btn').forEach(btn => {
btn.classList.toggle('active', btn.dataset.currency === selectedEditCategoryCurrency);
});

// Show rates
updateEditCategoryRatesDisplay();
}

function updateEditCategoryRatesDisplay() {
const avgTryRate = monthlyRates.TRY.reduce((a, b) => a + b, 0) / 12;
const avgRubRate = monthlyRates.RUB.reduce((a, b) => a + b, 0) / 12;

document.getElementById('editCategoryRatesDisplay').innerHTML = `
<span class="rate-chip">Ort: 1$ = ${avgTryRate.toFixed(2)}‚Ç∫</span>
<span class="rate-chip">Ort: 1$ = ${avgRubRate.toFixed(2)}‚ÇΩ</span>
`;
}

function updateCategory() {
const name = document.getElementById('editCategoryName').value.trim();
let yearlyBudget = parseFloat(document.getElementById('editCategoryYearlyBudget').value) || 0;
let monthlyBudgets = getMonthlyBudgets('editMonthlyBudgetGrid');

if (!name) { showToast('ƒ∞sim girin'); return; }

// Convert to USD if entered in different currency
if (selectedEditCategoryCurrency !== 'USD') {
const avgRate = selectedEditCategoryCurrency === 'TRY'
? monthlyRates.TRY.reduce((a, b) => a + b, 0) / 12
: monthlyRates.RUB.reduce((a, b) => a + b, 0) / 12;

yearlyBudget = yearlyBudget / avgRate;
monthlyBudgets = monthlyBudgets.map((val, i) => {
const rate = getRateForMonth(selectedEditCategoryCurrency, i);
return val / rate;
});
}

const dailyTracking = document.getElementById('editDailyTracking').checked;

['income', 'expense'].forEach(type => {
const cat = categories[type].find(c => c.id === editingCategoryId);
if (cat) {
cat.name = name;
cat.dailyTracking = dailyTracking; // G√ºnl√ºk takip ayarƒ±
// Yƒ±l bazƒ±nda b√ºt√ße kaydet
if (!cat.budgets) cat.budgets = {};
cat.budgets[currentYear] = {
yearlyBudget: yearlyBudget,
monthlyBudgets: monthlyBudgets,
budgetCurrency: selectedEditCategoryCurrency
};
}
});

closeModal('editBudgetModal');
saveData();
updateAll();
showToast('G√ºncellendi ‚úì');
}

function renderMonthlyRatesGrid(containerId, currency) {
const container = document.getElementById(containerId);
const rates = monthlyRates[currency] || Array(12).fill(currency === 'TRY' ? 38.50 : 96.00);
container.innerHTML = monthNames.map((month, i) => `
<div class="monthly-input">
<label>${month}</label>
<input type="number" id="${containerId}_${i}" value="${rates[i] || 0}" step="0.01" inputmode="decimal">
</div>
`).join('');
}

function getMonthlyRatesFromGrid(containerId) {
const rates = [];
for (let i = 0; i < 12; i++) {
const input = document.getElementById(`${containerId}_${i}`);
rates.push(parseFloat(input?.value) || 0);
}
return rates;
}

function openRatesModal() {
renderMonthlyRatesGrid('monthlyRatesTRY', 'TRY');
renderMonthlyRatesGrid('monthlyRatesRUB', 'RUB');
document.getElementById('ratesModal').classList.add('active');
}

// ==================== DATA MANAGEMENT ====================
function openDataModal() {
const catCount = categories.income.length + categories.expense.length;
const txCount = transactions.length;
document.getElementById('statCategories').textContent = `${catCount} kategori`;
document.getElementById('statTransactions').textContent = `${txCount} i≈ülem`;
document.getElementById('dataModal').classList.add('active');
}

function exportData() {
const data = {
version: 1,
exportDate: new Date().toISOString(),
categories,
transactions,
monthlyRates,
exchangeRates,
nextCategoryId
};

const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = `butce-yedek-${new Date().toISOString().split('T')[0]}.json`;
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(url);
showToast('Veriler indirildi ‚úì');
}

function importData(event) {
const file = event.target.files[0];
if (!file) return;

const reader = new FileReader();
reader.onload = function(e) {
try {
const data = JSON.parse(e.target.result);

// Validate data structure
if (!data.categories || !data.transactions) {
showToast('Ge√ßersiz dosya formatƒ±');
return;
}

// Import data
categories = data.categories || { income: [], expense: [] };
transactions = data.transactions || [];
monthlyRates = data.monthlyRates || {
TRY: Array(12).fill(38.50),
RUB: Array(12).fill(96.00)
};
exchangeRates = data.exchangeRates || { USD: 1, TRY: 38.50, RUB: 96.00 };
nextCategoryId = data.nextCategoryId || 1;

saveData();
closeModal('dataModal');
updateAll();
showToast('Veriler y√ºklendi ‚úì');
} catch (err) {
showToast('Dosya okunamadƒ±');
}
};
reader.readAsText(file);
event.target.value = ''; // Reset input
}

function confirmClearAllData() {
document.getElementById('confirmMessage').textContent = 'T√ºm kategoriler ve i≈ülemler silinecek. Bu i≈ülem geri alƒ±namaz!';
deleteCallback = () => {
categories = { income: [], expense: [] };
transactions = [];
nextCategoryId = 1;
saveData();
closeModal('dataModal');
updateAll();
showToast('Veriler temizlendi');
};
document.getElementById('confirmModal').classList.add('active');
}

// ==================== PDF REPORT ====================
function generatePDFReport() {
const { jsPDF } = window.jspdf;
const doc = new jsPDF();

const isMonthly = viewMode === 'monthly';
const yearTx = getYearTransactions();
const today = new Date();
const currentDayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
const daysInYear = 365;
const dayOfMonth = today.getDate();
const daysInCurrentMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();

// PDF Helper Functions
const colors = {
primary: [108, 92, 231],
income: [0, 184, 148],
expense: [225, 112, 85],
text: [45, 52, 54],
textLight: [99, 110, 114],
warning: [253, 203, 110],
white: [255, 255, 255],
bgLight: [248, 249, 250]
};

// Ay isimleri ASCII uyumlu
const monthNamesASCII = ['Oca', 'Sub', 'Mar', 'Nis', 'May', 'Haz', 'Tem', 'Agu', 'Eyl', 'Eki', 'Kas', 'Ara'];
const monthNamesFullASCII = ['Ocak', 'Subat', 'Mart', 'Nisan', 'Mayis', 'Haziran', 'Temmuz', 'Agustos', 'Eylul', 'Ekim', 'Kasim', 'Aralik'];

// Binlik ayracli sayi formatlama
function formatNum(num, decimals = 0) {
return num.toFixed(decimals).replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

// Para birimi sembolu
function getCurrencySymbol(currency) {
return { USD: '$', TRY: 'TL', RUB: 'R' }[currency] || '$';
}

function drawHeader(docRef, title, subtitle) {
docRef.setFillColor(...colors.primary);
docRef.rect(0, 0, 210, 35, 'F');
docRef.setTextColor(...colors.white);
docRef.setFontSize(20);
docRef.text(title, 105, 18, { align: 'center' });
docRef.setFontSize(10);
docRef.text(subtitle, 105, 28, { align: 'center' });
return 45;
}

function drawSectionTitle(docRef, title, yPos, color = colors.primary) {
docRef.setFillColor(...color);
docRef.rect(14, yPos - 5, 4, 8, 'F');
docRef.setTextColor(...colors.text);
docRef.setFontSize(13);
docRef.text(title, 22, yPos);
return yPos + 10;
}

function drawInfoBox(docRef, x, yPos, w, h, label, value, subValue, color) {
docRef.setFillColor(...colors.bgLight);
docRef.roundedRect(x, yPos, w, h, 3, 3, 'F');
docRef.setFillColor(...color);
docRef.rect(x, yPos, 3, h, 'F');
docRef.setTextColor(...colors.textLight);
docRef.setFontSize(8);
docRef.text(label, x + 8, yPos + 8);
docRef.setTextColor(...color);
docRef.setFontSize(14);
docRef.text(value, x + 8, yPos + 18);
if (subValue) {
docRef.setTextColor(...colors.textLight);
docRef.setFontSize(8);
docRef.text(subValue, x + 8, yPos + 25);
}
}

function drawProgressBar(docRef, x, yPos, w, h, percent, color) {
docRef.setFillColor(220, 220, 220);
docRef.roundedRect(x, yPos, w, h, 2, 2, 'F');
const fillWidth = Math.min(percent, 100) / 100 * w;
if (fillWidth > 0) {
docRef.setFillColor(...color);
docRef.roundedRect(x, yPos, fillWidth, h, 2, 2, 'F');
}
docRef.setTextColor(...colors.text);
docRef.setFontSize(7);
docRef.text(`${percent.toFixed(0)}%`, x + w + 3, yPos + 4);
}

function drawTable(docRef, headers, rows, startY, columnWidths) {
const rowHeight = 7;
const padding = 3;
let yPos = startY;
const startX = 14;

docRef.setFillColor(...colors.primary);
docRef.rect(startX, yPos, columnWidths.reduce((a, b) => a + b, 0), rowHeight, 'F');
docRef.setTextColor(...colors.white);
docRef.setFontSize(8);

let x = startX + padding;
headers.forEach((header, i) => {
docRef.text(header, x, yPos + 5);
x += columnWidths[i];
});
yPos += rowHeight;

docRef.setTextColor(...colors.text);
rows.forEach((row, rowIndex) => {
if (rowIndex % 2 === 0) {
docRef.setFillColor(...colors.bgLight);
docRef.rect(startX, yPos, columnWidths.reduce((a, b) => a + b, 0), rowHeight, 'F');
}

x = startX + padding;
row.forEach((cell, i) => {
docRef.setFontSize(7);
if (typeof cell === 'object') {
docRef.setTextColor(...cell.color);
docRef.text(cell.text, x, yPos + 5);
} else {
docRef.setTextColor(...colors.text);
docRef.text(String(cell), x, yPos + 5);
}
x += columnWidths[i];
});
yPos += rowHeight;
});

return yPos + 5;
}

function checkPageBreak(docRef, yPos, needed = 40) {
if (yPos + needed > 280) {
docRef.addPage();
return 20;
}
return yPos;
}

// Title
const title = isMonthly
? `${monthNamesFullASCII[currentMonth]} ${currentYear} Butce Raporu`
: `${currentYear} Yili Butce Raporu`;

const subtitle = `Olusturulma: ${today.toLocaleDateString('tr-TR')} ${today.toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'})}`;

let y = drawHeader(doc, title, subtitle);

// Calculate totals
let planIncome, planExpense, factIncome, factExpense;
let txListForCalc;

if (isMonthly) {
txListForCalc = yearTx.filter(t => new Date(t.date).getMonth() === currentMonth);
planIncome = categories.income.reduce((sum, c) => sum + getCategoryMonthlyPlan(c, currentMonth), 0);
planExpense = categories.expense.reduce((sum, c) => sum + getCategoryMonthlyPlan(c, currentMonth), 0);
factIncome = txListForCalc.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amountUSD, 0);
factExpense = txListForCalc.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amountUSD, 0);
} else {
txListForCalc = yearTx;
planIncome = categories.income.reduce((sum, c) => sum + getCategoryYearlyPlan(c), 0);
planExpense = categories.expense.reduce((sum, c) => sum + getCategoryYearlyPlan(c), 0);
factIncome = yearTx.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amountUSD, 0);
factExpense = yearTx.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amountUSD, 0);
}

const net = factIncome - factExpense;
const netColor = net >= 0 ? colors.income : colors.expense;

// ==================== OZET BOLUMU ====================
y = drawSectionTitle(doc, 'GENEL OZET', y);

const tryRate = isMonthly ? getRateForMonth('TRY', currentMonth) : monthlyRates.TRY.reduce((a, b) => a + b, 0) / 12;
const rubRate = isMonthly ? getRateForMonth('RUB', currentMonth) : monthlyRates.RUB.reduce((a, b) => a + b, 0) / 12;

drawInfoBox(doc, 14, y, 58, 30, 'GELIR PLANI', `$${formatNum(planIncome)}`, `TL ${formatNum(planIncome * tryRate)}`, colors.income);
drawInfoBox(doc, 76, y, 58, 30, 'GIDER PLANI', `$${formatNum(planExpense)}`, `TL ${formatNum(planExpense * tryRate)}`, colors.expense);
drawInfoBox(doc, 138, y, 58, 30, 'NET PLAN', `${(planIncome - planExpense) >= 0 ? '+' : ''}$${formatNum(Math.abs(planIncome - planExpense))}`, `TL ${formatNum((planIncome - planExpense) * tryRate)}`, (planIncome - planExpense) >= 0 ? colors.income : colors.expense);
y += 35;

drawInfoBox(doc, 14, y, 58, 30, 'GERCEKLESEN GELIR', `$${formatNum(factIncome)}`, `TL ${formatNum(factIncome * tryRate)}`, colors.income);
drawInfoBox(doc, 76, y, 58, 30, 'GERCEKLESEN GIDER', `$${formatNum(factExpense)}`, `TL ${formatNum(factExpense * tryRate)}`, colors.expense);
drawInfoBox(doc, 138, y, 58, 30, 'NET DURUM', `${net >= 0 ? '+' : ''}$${formatNum(Math.abs(net))}`, `TL ${formatNum(net * tryRate)}`, netColor);
y += 38;

doc.setTextColor(...colors.text);
doc.setFontSize(9);
doc.text('Gelir Gerceklesme:', 14, y);
const incomePercent = planIncome > 0 ? (factIncome / planIncome) * 100 : 0;
drawProgressBar(doc, 55, y - 3, 80, 5, incomePercent, colors.income);
y += 10;

doc.text('Gider Gerceklesme:', 14, y);
const expensePercent = planExpense > 0 ? (factExpense / planExpense) * 100 : 0;
drawProgressBar(doc, 55, y - 3, 80, 5, expensePercent, expensePercent > 100 ? colors.expense : colors.income);
y += 15;

// ==================== AYLIK HARCAMALAR (PARA BIRIMI BAZINDA) ====================
y = checkPageBreak(doc, y, 120);
y = drawSectionTitle(doc, 'AYLIK BUTCE - PARA BIRIMI BAZINDA (Plan/Gerceklesen)', y);

// Her ay i√ßin para birimi bazƒ±nda plan ve ger√ßekle≈üen hesapla
const monthlyByCurrencyData = [];
for (let i = 0; i < 12; i++) {
const monthTx = yearTx.filter(t => new Date(t.date).getMonth() === i && t.type === 'expense');
const monthTryRate = getRateForMonth('TRY', i);
const monthRubRate = getRateForMonth('RUB', i);

// Orijinal para birimlerinde ger√ßekle≈üen harcamalar
const actualUSD = monthTx.filter(t => t.currency === 'USD').reduce((sum, t) => sum + t.amount, 0);
const actualTRY = monthTx.filter(t => t.currency === 'TRY').reduce((sum, t) => sum + t.amount, 0);
const actualRUB = monthTx.filter(t => t.currency === 'RUB').reduce((sum, t) => sum + t.amount, 0);

// Para birimi bazƒ±nda planlar (kategorilerin b√ºt√ße para birimine g√∂re)
let planUSD = 0, planTRY = 0, planRUB = 0;
categories.expense.forEach(cat => {
const catPlan = getCategoryMonthlyPlan(cat, i);
const budgetCurrency = getCategoryBudgetCurrency(cat);
if (budgetCurrency === 'USD') {
planUSD += catPlan;
} else if (budgetCurrency === 'TRY') {
planTRY += catPlan * monthTryRate;
} else if (budgetCurrency === 'RUB') {
planRUB += catPlan * monthRubRate;
}
});

// USD kar≈üƒ±lƒ±klarƒ± (toplam i√ßin)
const actualUSD_inUSD = actualUSD;
const actualTRY_inUSD = monthTryRate > 0 ? actualTRY / monthTryRate : 0;
const actualRUB_inUSD = monthRubRate > 0 ? actualRUB / monthRubRate : 0;
const totalActualUSD = actualUSD_inUSD + actualTRY_inUSD + actualRUB_inUSD;

const planTRY_inUSD = monthTryRate > 0 ? planTRY / monthTryRate : 0;
const planRUB_inUSD = monthRubRate > 0 ? planRUB / monthRubRate : 0;
const totalPlanUSD = planUSD + planTRY_inUSD + planRUB_inUSD;

monthlyByCurrencyData.push({
month: monthNamesASCII[i],
tryRate: monthTryRate,
rubRate: monthRubRate,
planUSD, actualUSD,
planTRY, actualTRY,
planRUB, actualRUB,
totalPlanUSD, totalActualUSD,
diff: totalPlanUSD - totalActualUSD
});
}

// Para birimi bazƒ±nda tablo - Plan/Ger√ßekle≈üen yan yana
const currencyTableHeaders = ['Ay', 'USD (P/G)', 'TRY (P/G)', 'RUB (P/G)', 'TOPLAM $ (P/G)', 'Fark'];
const currencyTableRows = monthlyByCurrencyData.map((m, i) => {
const diffColor = m.diff >= 0 ? colors.income : colors.expense;
const isCurrentMonthRow = today.getFullYear() === currentYear && i === today.getMonth();

return [
isCurrentMonthRow ? `> ${m.month}` : m.month,
`${formatNum(m.planUSD)} / ${formatNum(m.actualUSD)}`,
`${formatNum(m.planTRY)} / ${formatNum(m.actualTRY)}`,
`${formatNum(m.planRUB)} / ${formatNum(m.actualRUB)}`,
{ text: `${formatNum(m.totalPlanUSD)} / ${formatNum(m.totalActualUSD)}`, color: m.diff >= 0 ? colors.income : colors.expense },
{ text: `${m.diff >= 0 ? '+' : ''}${formatNum(Math.abs(m.diff))}`, color: diffColor }
];
});

y = drawTable(doc, currencyTableHeaders, currencyTableRows, y, [18, 34, 42, 42, 38, 22]);

// Yƒ±llƒ±k toplam √∂zeti
const totalsByYear = {
planUSD: monthlyByCurrencyData.reduce((sum, m) => sum + m.planUSD, 0),
actualUSD: monthlyByCurrencyData.reduce((sum, m) => sum + m.actualUSD, 0),
planTRY: monthlyByCurrencyData.reduce((sum, m) => sum + m.planTRY, 0),
actualTRY: monthlyByCurrencyData.reduce((sum, m) => sum + m.actualTRY, 0),
planRUB: monthlyByCurrencyData.reduce((sum, m) => sum + m.planRUB, 0),
actualRUB: monthlyByCurrencyData.reduce((sum, m) => sum + m.actualRUB, 0),
totalPlanUSD: monthlyByCurrencyData.reduce((sum, m) => sum + m.totalPlanUSD, 0),
totalActualUSD: monthlyByCurrencyData.reduce((sum, m) => sum + m.totalActualUSD, 0)
};
const yearDiff = totalsByYear.totalPlanUSD - totalsByYear.totalActualUSD;

// Y√ºzde hesaplama (ger√ßekle≈üen bazƒ±nda)
const usdPercent = totalsByYear.totalActualUSD > 0 ? (monthlyByCurrencyData.reduce((sum, m) => sum + m.actualUSD, 0) / totalsByYear.totalActualUSD * 100) : 0;
const tryPercentVal = totalsByYear.totalActualUSD > 0 ? (monthlyByCurrencyData.reduce((sum, m) => sum + (m.tryRate > 0 ? m.actualTRY / m.tryRate : 0), 0) / totalsByYear.totalActualUSD * 100) : 0;
const rubPercentVal = totalsByYear.totalActualUSD > 0 ? (monthlyByCurrencyData.reduce((sum, m) => sum + (m.rubRate > 0 ? m.actualRUB / m.rubRate : 0), 0) / totalsByYear.totalActualUSD * 100) : 0;

// Yƒ±llƒ±k √∂zet kutusu i√ßin sayfa kontrol√º
y = checkPageBreak(doc, y + 3, 50);

doc.setFillColor(...colors.bgLight);
doc.roundedRect(14, y, 182, 42, 3, 3, 'F');

doc.setTextColor(...colors.text);
doc.setFontSize(9);
doc.text('YILLIK OZET (Plan / Gerceklesen)', 20, y + 8);

doc.setFontSize(8);
// USD satƒ±rƒ±
doc.setTextColor(39, 174, 96);
doc.text(`USD:`, 20, y + 16);
doc.setTextColor(...colors.text);
doc.text(`$${formatNum(totalsByYear.planUSD)} / $${formatNum(totalsByYear.actualUSD)}`, 38, y + 16);

// TRY satƒ±rƒ±
doc.setTextColor(231, 76, 60);
doc.text(`TRY:`, 90, y + 16);
doc.setTextColor(...colors.text);
doc.text(`${formatNum(totalsByYear.planTRY)} / ${formatNum(totalsByYear.actualTRY)}`, 103, y + 16);

// RUB satƒ±rƒ±
doc.setTextColor(52, 152, 219);
doc.text(`RUB:`, 152, y + 16);
doc.setTextColor(...colors.text);
doc.text(`${formatNum(totalsByYear.planRUB)} / ${formatNum(totalsByYear.actualRUB)}`, 165, y + 16);

// Toplam USD satƒ±rƒ±
doc.setFontSize(9);
doc.setTextColor(...colors.primary);
doc.text(`TOPLAM (USD):`, 20, y + 26);
doc.text(`$${formatNum(totalsByYear.totalPlanUSD)} / $${formatNum(totalsByYear.totalActualUSD)}`, 60, y + 26);
doc.setTextColor(...(yearDiff >= 0 ? colors.income : colors.expense));
doc.text(`Fark: ${yearDiff >= 0 ? '+' : ''}$${formatNum(Math.abs(yearDiff))}`, 125, y + 26);

// Y√ºzde √ßubuklarƒ±
const barStartX = 20;
const barWidth = 170;
const barY = y + 32;
const barHeight = 5;

// Arka plan
doc.setFillColor(220, 220, 220);
doc.rect(barStartX, barY, barWidth, barHeight, 'F');

// USD kƒ±smƒ± (ye≈üil)
if (usdPercent > 0) {
doc.setFillColor(39, 174, 96);
doc.rect(barStartX, barY, barWidth * (usdPercent / 100), barHeight, 'F');
}
// TRY kƒ±smƒ± (kƒ±rmƒ±zƒ±)
if (tryPercentVal > 0) {
doc.setFillColor(231, 76, 60);
doc.rect(barStartX + barWidth * (usdPercent / 100), barY, barWidth * (tryPercentVal / 100), barHeight, 'F');
}
// RUB kƒ±smƒ± (mavi)
if (rubPercentVal > 0) {
doc.setFillColor(52, 152, 219);
doc.rect(barStartX + barWidth * ((usdPercent + tryPercentVal) / 100), barY, barWidth * (rubPercentVal / 100), barHeight, 'F');
}

doc.setFontSize(7);
doc.setTextColor(39, 174, 96);
doc.text(`USD %${usdPercent.toFixed(0)}`, barStartX, y + 42);
doc.setTextColor(231, 76, 60);
doc.text(`TRY %${tryPercentVal.toFixed(0)}`, barStartX + 45, y + 42);
doc.setTextColor(52, 152, 219);
doc.text(`RUB %${rubPercentVal.toFixed(0)}`, barStartX + 90, y + 42);

y += 50;

// ==================== HARCAMA TRENDI VE PROJEKSIYON ====================
y = checkPageBreak(doc, y, 70);
y = drawSectionTitle(doc, 'HARCAMA TRENDI VE PROJEKSIYON', y, colors.warning);

const completedMonths = today.getFullYear() === currentYear ? today.getMonth() : 11;
const totalExpenseSoFar = yearTx.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amountUSD, 0);
const yearlyExpensePlan = categories.expense.reduce((sum, c) => sum + getCategoryYearlyPlan(c), 0);

let projectedYearlyExpense, dailyAverage, monthlyAverage;

if (isMonthly) {
const monthExpense = yearTx.filter(t => new Date(t.date).getMonth() === currentMonth && t.type === 'expense')
.reduce((sum, t) => sum + t.amountUSD, 0);
const monthPlan = categories.expense.reduce((sum, c) => sum + getCategoryMonthlyPlan(c, currentMonth), 0);

dailyAverage = dayOfMonth > 0 ? monthExpense / dayOfMonth : 0;
projectedYearlyExpense = dailyAverage * daysInCurrentMonth;

const projectedDiff = monthPlan - projectedYearlyExpense;

doc.setFillColor(...colors.bgLight);
doc.roundedRect(14, y, 182, 55, 3, 3, 'F');

doc.setTextColor(...colors.text);
doc.setFontSize(9);
doc.text(`${monthNamesFullASCII[currentMonth]} Ayi Analizi`, 20, y + 10);

doc.setFontSize(8);
doc.text(`- Bu ayin ${dayOfMonth}. gunu itibariyle toplam harcama: $${formatNum(monthExpense)} (TL ${formatNum(monthExpense * tryRate)})`, 20, y + 20);
doc.text(`- Gunluk ortalama harcama: $${formatNum(dailyAverage, 1)} (TL ${formatNum(dailyAverage * tryRate)})`, 20, y + 28);
doc.text(`- Ay sonu tahmini harcama: $${formatNum(projectedYearlyExpense)} (TL ${formatNum(projectedYearlyExpense * tryRate)})`, 20, y + 36);

doc.setTextColor(...(projectedDiff >= 0 ? colors.income : colors.expense));
doc.setFontSize(9);
if (projectedDiff >= 0) {
doc.text(`[OK] Bu trendle devam ederseniz ay sonunda $${formatNum(projectedDiff)} butce altinda kalirsiniz.`, 20, y + 48);
} else {
doc.text(`[!] Bu trendle devam ederseniz ay sonunda $${formatNum(Math.abs(projectedDiff))} butce asimi olacak!`, 20, y + 48);
}
y += 62;
} else {
const daysPassedThisYear = today.getFullYear() === currentYear ? currentDayOfYear : daysInYear;
dailyAverage = daysPassedThisYear > 0 ? totalExpenseSoFar / daysPassedThisYear : 0;
monthlyAverage = completedMonths > 0 ? totalExpenseSoFar / (completedMonths + (dayOfMonth / daysInCurrentMonth)) : 0;
projectedYearlyExpense = dailyAverage * daysInYear;

const projectedDiff = yearlyExpensePlan - projectedYearlyExpense;
const avgTryRate = monthlyRates.TRY.reduce((a, b) => a + b, 0) / 12;

doc.setFillColor(...colors.bgLight);
doc.roundedRect(14, y, 182, 60, 3, 3, 'F');

doc.setTextColor(...colors.text);
doc.setFontSize(9);
doc.text(`${currentYear} Yili Harcama Trend Analizi`, 20, y + 10);

doc.setFontSize(8);
doc.text(`- Yilin ${daysPassedThisYear}. gunu itibariyle toplam harcama: $${formatNum(totalExpenseSoFar)} (TL ${formatNum(totalExpenseSoFar * avgTryRate)})`, 20, y + 20);
doc.text(`- Gunluk ortalama harcama: $${formatNum(dailyAverage, 1)} (TL ${formatNum(dailyAverage * avgTryRate)})`, 20, y + 28);
doc.text(`- Aylik ortalama harcama: $${formatNum(monthlyAverage)} (TL ${formatNum(monthlyAverage * avgTryRate)})`, 20, y + 36);
doc.text(`- Yil sonu tahmini harcama: $${formatNum(projectedYearlyExpense)} (TL ${formatNum(projectedYearlyExpense * avgTryRate)})`, 20, y + 44);

doc.setTextColor(...(projectedDiff >= 0 ? colors.income : colors.expense));
doc.setFontSize(9);
if (projectedDiff >= 0) {
doc.text(`[OK] Bu trendle devam ederseniz yil sonunda $${formatNum(projectedDiff)} butce altinda kalirsiniz.`, 20, y + 54);
} else {
doc.text(`[!] Bu trendle devam ederseniz yil sonunda $${formatNum(Math.abs(projectedDiff))} butce asimi olacak!`, 20, y + 54);
}
y += 68;
}

// ==================== KATEGORI BAZINDA HARCAMALAR ====================
y = checkPageBreak(doc, y, 50);
y = drawSectionTitle(doc, 'GIDER KATEGORILERI DETAYI (Orijinal Para Birimi)', y, colors.expense);

const categoryData = categories.expense.map(cat => {
const budgetCurrency = getCategoryBudgetCurrency(cat);
const planUSD = isMonthly ? getCategoryMonthlyPlan(cat, currentMonth) : getCategoryYearlyPlan(cat);

// Ger√ßekle≈üen harcamalarƒ± al
const txListCat = isMonthly
? yearTx.filter(t => t.categoryId === cat.id && new Date(t.date).getMonth() === currentMonth)
: yearTx.filter(t => t.categoryId === cat.id);
const factUSD = txListCat.reduce((sum, t) => sum + t.amountUSD, 0);

// Orijinal para biriminde deƒüerler
let planOriginal, factOriginal, rate;
if (budgetCurrency === 'TRY') {
rate = isMonthly ? getRateForMonth('TRY', currentMonth) : monthlyRates.TRY.reduce((a, b) => a + b, 0) / 12;
planOriginal = planUSD * rate;
factOriginal = txListCat.filter(t => t.currency === 'TRY').reduce((sum, t) => sum + t.amount, 0);
// Diƒüer para birimlerinden gelen harcamalarƒ± da ekle
factOriginal += txListCat.filter(t => t.currency === 'USD').reduce((sum, t) => sum + t.amount * rate, 0);
factOriginal += txListCat.filter(t => t.currency === 'RUB').reduce((sum, t) => {
const rubRate = isMonthly ? getRateForMonth('RUB', currentMonth) : monthlyRates.RUB.reduce((a, b) => a + b, 0) / 12;
return sum + t.amount * rate / rubRate;
}, 0);
} else if (budgetCurrency === 'RUB') {
rate = isMonthly ? getRateForMonth('RUB', currentMonth) : monthlyRates.RUB.reduce((a, b) => a + b, 0) / 12;
planOriginal = planUSD * rate;
factOriginal = txListCat.filter(t => t.currency === 'RUB').reduce((sum, t) => sum + t.amount, 0);
// Diƒüer para birimlerinden gelen harcamalarƒ± da ekle
factOriginal += txListCat.filter(t => t.currency === 'USD').reduce((sum, t) => sum + t.amount * rate, 0);
factOriginal += txListCat.filter(t => t.currency === 'TRY').reduce((sum, t) => {
const tryRate2 = isMonthly ? getRateForMonth('TRY', currentMonth) : monthlyRates.TRY.reduce((a, b) => a + b, 0) / 12;
return sum + t.amount * rate / tryRate2;
}, 0);
} else {
// USD
planOriginal = planUSD;
factOriginal = factUSD;
}

const diff = planOriginal - factOriginal;
const percent = planOriginal > 0 ? (factOriginal / planOriginal) * 100 : 0;

return {
name: cat.name,
currency: budgetCurrency,
planOriginal,
factOriginal,
diff,
percent,
planUSD,
factUSD
};
}).filter(c => c.planOriginal > 0 || c.factOriginal > 0).sort((a, b) => b.factUSD - a.factUSD);

const catTableHeaders = ['Kategori', 'PB', 'Plan', 'Gerceklesen', 'Fark', 'Oran'];
const catTableRows = categoryData.map(c => {
const diffColor = c.diff >= 0 ? colors.income : colors.expense;
const percentColor = c.percent > 100 ? colors.expense : (c.percent > 80 ? colors.warning : colors.income);
const symbol = getCurrencySymbol(c.currency);
return [
c.name.length > 18 ? c.name.substring(0, 18) + '...' : c.name,
c.currency,
`${symbol}${formatNum(c.planOriginal)}`,
`${symbol}${formatNum(c.factOriginal)}`,
{ text: `${c.diff >= 0 ? '+' : '-'}${symbol}${formatNum(Math.abs(c.diff))}`, color: diffColor },
{ text: `%${c.percent.toFixed(0)}`, color: percentColor }
];
});

if (catTableRows.length > 0) {
y = drawTable(doc, catTableHeaders, catTableRows, y, [48, 16, 38, 38, 30, 18]);
}

// ==================== GELIR KATEGORILERI ====================
y = checkPageBreak(doc, y, 50);
y = drawSectionTitle(doc, 'GELIR KATEGORILERI DETAYI (Orijinal Para Birimi)', y, colors.income);

const incomeData = categories.income.map(cat => {
const budgetCurrency = getCategoryBudgetCurrency(cat);
const planUSD = isMonthly ? getCategoryMonthlyPlan(cat, currentMonth) : getCategoryYearlyPlan(cat);

const txListCat = isMonthly
? yearTx.filter(t => t.categoryId === cat.id && new Date(t.date).getMonth() === currentMonth)
: yearTx.filter(t => t.categoryId === cat.id);
const factUSD = txListCat.reduce((sum, t) => sum + t.amountUSD, 0);

// Orijinal para biriminde deƒüerler
let planOriginal, factOriginal, rate;
if (budgetCurrency === 'TRY') {
rate = isMonthly ? getRateForMonth('TRY', currentMonth) : monthlyRates.TRY.reduce((a, b) => a + b, 0) / 12;
planOriginal = planUSD * rate;
factOriginal = factUSD * rate;
} else if (budgetCurrency === 'RUB') {
rate = isMonthly ? getRateForMonth('RUB', currentMonth) : monthlyRates.RUB.reduce((a, b) => a + b, 0) / 12;
planOriginal = planUSD * rate;
factOriginal = factUSD * rate;
} else {
planOriginal = planUSD;
factOriginal = factUSD;
}

const diff = factOriginal - planOriginal;
const percent = planOriginal > 0 ? (factOriginal / planOriginal) * 100 : 0;

return {
name: cat.name,
currency: budgetCurrency,
planOriginal,
factOriginal,
diff,
percent
};
}).filter(c => c.planOriginal > 0 || c.factOriginal > 0).sort((a, b) => b.factOriginal - a.factOriginal);

const incomeTableHeaders = ['Kategori', 'PB', 'Plan', 'Gerceklesen', 'Fark', 'Oran'];
const incomeTableRows = incomeData.map(c => {
const diffColor = c.diff >= 0 ? colors.income : colors.expense;
const percentColor = c.percent >= 100 ? colors.income : (c.percent > 50 ? colors.warning : colors.expense);
const symbol = getCurrencySymbol(c.currency);
return [
c.name.length > 18 ? c.name.substring(0, 18) + '...' : c.name,
c.currency,
`${symbol}${formatNum(c.planOriginal)}`,
`${symbol}${formatNum(c.factOriginal)}`,
{ text: `${c.diff >= 0 ? '+' : '-'}${symbol}${formatNum(Math.abs(c.diff))}`, color: diffColor },
{ text: `%${c.percent.toFixed(0)}`, color: percentColor }
];
});

if (incomeTableRows.length > 0) {
y = drawTable(doc, incomeTableHeaders, incomeTableRows, y, [48, 16, 38, 38, 30, 18]);
}

// ==================== SON ISLEMLER ====================
const txList = isMonthly
? yearTx.filter(t => new Date(t.date).getMonth() === currentMonth)
: yearTx;

if (txList.length > 0) {
y = checkPageBreak(doc, y, 50);
y = drawSectionTitle(doc, 'SON ISLEMLER', y, colors.primary);

const txTableHeaders = ['Tarih', 'Kategori', 'PB', 'Tutar', 'Tutar ($)', 'Not'];
const txTableRows = txList.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 20).map(tx => {
const cat = [...categories.income, ...categories.expense].find(c => c.id === tx.categoryId);
const catName = cat ? cat.name : 'Bilinmiyor';
const txDate = new Date(tx.date);
const sign = tx.type === 'income' ? '+' : '-';
const color = tx.type === 'income' ? colors.income : colors.expense;
const symbol = getCurrencySymbol(tx.currency);

return [
txDate.toLocaleDateString('tr-TR'),
catName.length > 12 ? catName.substring(0, 12) + '...' : catName,
tx.currency,
{ text: `${sign}${symbol}${formatNum(tx.amount)}`, color },
{ text: `${sign}$${formatNum(tx.amountUSD)}`, color },
(tx.note || '-').substring(0, 18)
];
});

y = drawTable(doc, txTableHeaders, txTableRows, y, [25, 32, 16, 32, 28, 50]);
}

// Footer on each page
const pageCount = doc.internal.getNumberOfPages();
for (let i = 1; i <= pageCount; i++) {
doc.setPage(i);
doc.setFillColor(...colors.primary);
doc.rect(0, 287, 210, 10, 'F');
doc.setTextColor(...colors.white);
doc.setFontSize(8);
doc.text('Butce Takip Uygulamasi', 105, 293, { align: 'center' });
doc.text(`Sayfa ${i} / ${pageCount}`, 195, 293, { align: 'right' });
}

// Save
const filename = isMonthly
? `butce-${currentYear}-${String(currentMonth + 1).padStart(2, '0')}.pdf`
: `butce-${currentYear}-yillik.pdf`;

doc.save(filename);
showToast('PDF raporu olusturuldu');
}

// ==================== EXCEL REPORT ====================
function generateExcelReport() {
const isMonthly = viewMode === 'monthly';
const yearTx = getYearTransactions();
const tryRate = isMonthly
? getRateForMonth('TRY', currentMonth)
: monthlyRates.TRY.reduce((a, b) => a + b, 0) / 12;

const wb = XLSX.utils.book_new();

// Stil sabitleri
const borderStyle = { style: 'thin', color: { rgb: '000000' } };
const allBorders = { top: borderStyle, bottom: borderStyle, left: borderStyle, right: borderStyle };
const headerFill = { fgColor: { rgb: '4A5568' }, patternType: 'solid' };
const headerFont = { bold: true, color: { rgb: 'FFFFFF' }, sz: 11 };
const titleFont = { bold: true, sz: 14, color: { rgb: '2D3748' } };
const subtitleFont = { bold: false, sz: 10, color: { rgb: '718096' } };
const incomeFont = { color: { rgb: '059669' } };
const expenseFont = { color: { rgb: 'DC2626' } };
const incomeFill = { fgColor: { rgb: 'D1FAE5' }, patternType: 'solid' };
const expenseFill = { fgColor: { rgb: 'FEE2E2' }, patternType: 'solid' };
const altRowFill = { fgColor: { rgb: 'F7FAFC' }, patternType: 'solid' };

// Yardƒ±mcƒ± fonksiyonlar
function applyStyleToSheet(ws, range, dataRows, headerRowIndex, options = {}) {
const { hasTotal = false, totalRowIndex = -1, colorColumn = -1 } = options;

// T√ºm h√ºcrelere kenarlƒ±k ekle
for (let R = range.s.r; R <= range.e.r; ++R) {
for (let C = range.s.c; C <= range.e.c; ++C) {
const cellRef = XLSX.utils.encode_cell({ r: R, c: C });
if (!ws[cellRef]) ws[cellRef] = { v: '', t: 's' };
if (!ws[cellRef].s) ws[cellRef].s = {};
ws[cellRef].s.border = allBorders;

// Header satƒ±rƒ±
if (R === headerRowIndex) {
ws[cellRef].s.fill = headerFill;
ws[cellRef].s.font = headerFont;
ws[cellRef].s.alignment = { horizontal: 'center', vertical: 'center' };
}
// Toplam satƒ±rƒ±
else if (hasTotal && R === totalRowIndex) {
ws[cellRef].s.font = { bold: true, sz: 11 };
ws[cellRef].s.fill = { fgColor: { rgb: 'E2E8F0' }, patternType: 'solid' };
}
// Normal satƒ±rlar - alternatif renk
else if (R > headerRowIndex && (R - headerRowIndex) % 2 === 0) {
ws[cellRef].s.fill = altRowFill;
}

// Sayƒ± h√ºcreleri saƒüa hizala
if (C > 0 && R > headerRowIndex) {
ws[cellRef].s.alignment = { horizontal: 'right' };
}
}
}
}

function setColumnWidths(ws, widths) {
ws['!cols'] = widths.map(w => ({ wch: w }));
}

function formatNumber(num) {
return Number(num).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// ===== √ñZET SAYFASI =====
const summaryData = [];
summaryData.push(['B√úT√áE RAPORU', '', '', '', '', '', '']);
summaryData.push([isMonthly ? `${monthNamesFull[currentMonth]} ${currentYear}` : `${currentYear} Yƒ±lƒ±`, '', '', '', '', '', '']);
summaryData.push([`Olu≈üturulma: ${new Date().toLocaleDateString('tr-TR')} ${new Date().toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'})}`, '', '', '', '', '', '']);
summaryData.push(['', '', '', '', '', '', '']);

// Hesaplamalar
let planIncome, planExpense, factIncome, factExpense;
if (isMonthly) {
const monthTx = yearTx.filter(t => new Date(t.date).getMonth() === currentMonth);
planIncome = categories.income.reduce((sum, c) => sum + getCategoryMonthlyPlan(c, currentMonth), 0);
planExpense = categories.expense.reduce((sum, c) => sum + getCategoryMonthlyPlan(c, currentMonth), 0);
factIncome = monthTx.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amountUSD, 0);
factExpense = monthTx.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amountUSD, 0);
} else {
planIncome = categories.income.reduce((sum, c) => sum + getCategoryYearlyPlan(c), 0);
planExpense = categories.expense.reduce((sum, c) => sum + getCategoryYearlyPlan(c), 0);
factIncome = yearTx.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amountUSD, 0);
factExpense = yearTx.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amountUSD, 0);
}
const net = factIncome - factExpense;
const incomeDiff = factIncome - planIncome;
const expenseDiff = planExpense - factExpense;

summaryData.push(['√ñZET', 'Plan ($)', 'Plan (‚Ç∫)', 'Ger√ßekle≈üen ($)', 'Ger√ßekle≈üen (‚Ç∫)', 'Fark ($)', 'Fark (‚Ç∫)']);
summaryData.push(['üí∞ Gelir', formatNumber(planIncome), formatNumber(planIncome * tryRate), formatNumber(factIncome), formatNumber(factIncome * tryRate), formatNumber(incomeDiff), formatNumber(incomeDiff * tryRate)]);
summaryData.push(['üí∏ Gider', formatNumber(planExpense), formatNumber(planExpense * tryRate), formatNumber(factExpense), formatNumber(factExpense * tryRate), formatNumber(expenseDiff), formatNumber(expenseDiff * tryRate)]);
summaryData.push(['üìä Net', '', '', formatNumber(net), formatNumber(net * tryRate), '', '']);
summaryData.push(['', '', '', '', '', '', '']);

// Para birimi bazƒ±nda √∂zet
summaryData.push(['PARA Bƒ∞Rƒ∞Mƒ∞ BAZINDA HARCAMALAR', '', '', '', '', '', '']);
summaryData.push(['Para Birimi', 'Plan', 'Ger√ßekle≈üen', 'Fark', '', '', '']);

// Para birimi hesaplamalarƒ±
let planUSD = 0, planTRY = 0, planRUB = 0;
let actualUSD = 0, actualTRY = 0, actualRUB = 0;

categories.expense.forEach(cat => {
const catPlan = isMonthly ? getCategoryMonthlyPlan(cat, currentMonth) : getCategoryYearlyPlan(cat);
const budgetCurrency = getCategoryBudgetCurrency(cat);
const monthTryRate = isMonthly ? getRateForMonth('TRY', currentMonth) : tryRate;
const monthRubRate = isMonthly ? getRateForMonth('RUB', currentMonth) : monthlyRates.RUB.reduce((a, b) => a + b, 0) / 12;

if (budgetCurrency === 'USD') planUSD += catPlan;
else if (budgetCurrency === 'TRY') planTRY += catPlan * monthTryRate;
else if (budgetCurrency === 'RUB') planRUB += catPlan * monthRubRate;
});

const txListForCurrency = isMonthly ? yearTx.filter(t => new Date(t.date).getMonth() === currentMonth && t.type === 'expense') : yearTx.filter(t => t.type === 'expense');
actualUSD = txListForCurrency.filter(t => t.currency === 'USD').reduce((sum, t) => sum + t.amount, 0);
actualTRY = txListForCurrency.filter(t => t.currency === 'TRY').reduce((sum, t) => sum + t.amount, 0);
actualRUB = txListForCurrency.filter(t => t.currency === 'RUB').reduce((sum, t) => sum + t.amount, 0);

summaryData.push(['$ Dolar (USD)', formatNumber(planUSD), formatNumber(actualUSD), formatNumber(planUSD - actualUSD), '', '', '']);
summaryData.push(['‚Ç∫ T√ºrk Lirasƒ± (TRY)', formatNumber(planTRY), formatNumber(actualTRY), formatNumber(planTRY - actualTRY), '', '', '']);
summaryData.push(['‚ÇΩ Ruble (RUB)', formatNumber(planRUB), formatNumber(actualRUB), formatNumber(planRUB - actualRUB), '', '', '']);

const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);

// √ñzet sayfa stilleri
setColumnWidths(wsSummary, [22, 16, 16, 16, 16, 14, 14]);
wsSummary['!merges'] = [
{ s: { r: 0, c: 0 }, e: { r: 0, c: 6 } },
{ s: { r: 1, c: 0 }, e: { r: 1, c: 6 } },
{ s: { r: 2, c: 0 }, e: { r: 2, c: 6 } },
{ s: { r: 9, c: 0 }, e: { r: 9, c: 6 } }
];

// Ba≈ülƒ±k stilleri
if (wsSummary['A1']) wsSummary['A1'].s = { font: titleFont, alignment: { horizontal: 'center' } };
if (wsSummary['A2']) wsSummary['A2'].s = { font: subtitleFont, alignment: { horizontal: 'center' } };
if (wsSummary['A3']) wsSummary['A3'].s = { font: subtitleFont, alignment: { horizontal: 'center' } };

// Tablo ba≈ülƒ±klarƒ± ve kenarlƒ±klar
const summaryRange = { s: { r: 4, c: 0 }, e: { r: 8, c: 6 } };
applyStyleToSheet(wsSummary, summaryRange, summaryData.slice(4), 4, { hasTotal: true, totalRowIndex: 8 });

const currencyRange = { s: { r: 10, c: 0 }, e: { r: 14, c: 3 } };
applyStyleToSheet(wsSummary, currencyRange, summaryData.slice(10), 10);

XLSX.utils.book_append_sheet(wb, wsSummary, '√ñzet');

// ===== GELƒ∞R KALEMLERƒ∞ SAYFASI =====
const incomeData = [];
incomeData.push(['üí∞ GELƒ∞R KALEMLERƒ∞', '', '', '', '', '', '', '']);
incomeData.push(['', '', '', '', '', '', '', '']);
incomeData.push(['Kategori', 'Para Birimi', 'Plan ($)', 'Plan (‚Ç∫)', 'Ger√ßekle≈üen ($)', 'Ger√ßekle≈üen (‚Ç∫)', 'Fark ($)', 'ƒ∞≈ülem']);

let totalIncomePlan = 0, totalIncomeFact = 0;
categories.income.forEach(cat => {
const plan = isMonthly ? getCategoryMonthlyPlan(cat, currentMonth) : getCategoryYearlyPlan(cat);
const txList = isMonthly
? yearTx.filter(t => t.categoryId === cat.id && new Date(t.date).getMonth() === currentMonth)
: yearTx.filter(t => t.categoryId === cat.id);
const fact = txList.reduce((sum, t) => sum + t.amountUSD, 0);
const diff = fact - plan;
const budgetCurrency = getCategoryBudgetCurrency(cat);

totalIncomePlan += plan;
totalIncomeFact += fact;

incomeData.push([
cat.name,
budgetCurrency,
formatNumber(plan),
formatNumber(plan * tryRate),
formatNumber(fact),
formatNumber(fact * tryRate),
formatNumber(diff),
txList.length
]);
});

incomeData.push([
'üìä TOPLAM',
'',
formatNumber(totalIncomePlan),
formatNumber(totalIncomePlan * tryRate),
formatNumber(totalIncomeFact),
formatNumber(totalIncomeFact * tryRate),
formatNumber(totalIncomeFact - totalIncomePlan),
''
]);

const wsIncome = XLSX.utils.aoa_to_sheet(incomeData);
setColumnWidths(wsIncome, [24, 12, 14, 16, 14, 16, 14, 8]);
wsIncome['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 7 } }];
if (wsIncome['A1']) wsIncome['A1'].s = { font: titleFont };

const incomeRange = { s: { r: 2, c: 0 }, e: { r: incomeData.length - 1, c: 7 } };
applyStyleToSheet(wsIncome, incomeRange, incomeData.slice(2), 2, { hasTotal: true, totalRowIndex: incomeData.length - 1 });

XLSX.utils.book_append_sheet(wb, wsIncome, 'Gelir Kalemleri');

// ===== Gƒ∞DER KALEMLERƒ∞ SAYFASI =====
const expenseData = [];
expenseData.push(['üí∏ Gƒ∞DER KALEMLERƒ∞', '', '', '', '', '', '', '', '', '']);
expenseData.push(['', '', '', '', '', '', '', '', '', '']);

let totalExpensePlan = 0, totalExpenseFact = 0;

if (isMonthly) {
const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
expenseData.push(['Kategori', 'P.B.', 'Aylƒ±k Plan ($)', 'Aylƒ±k Plan (‚Ç∫)', 'G√ºnl√ºk ($)', 'Ger√ßekle≈üen ($)', 'Ger√ßekle≈üen (‚Ç∫)', 'Fark ($)', 'Oran %', 'ƒ∞≈ülem']);

categories.expense.forEach(cat => {
const plan = getCategoryMonthlyPlan(cat, currentMonth);
const dailyLimit = plan / daysInMonth;
const txList = yearTx.filter(t => t.categoryId === cat.id && new Date(t.date).getMonth() === currentMonth);
const fact = txList.reduce((sum, t) => sum + t.amountUSD, 0);
const diff = plan - fact;
const percent = plan > 0 ? (fact / plan * 100) : 0;
const budgetCurrency = getCategoryBudgetCurrency(cat);

totalExpensePlan += plan;
totalExpenseFact += fact;

expenseData.push([
cat.name,
budgetCurrency,
formatNumber(plan),
formatNumber(plan * tryRate),
formatNumber(dailyLimit),
formatNumber(fact),
formatNumber(fact * tryRate),
formatNumber(diff),
`%${percent.toFixed(0)}`,
txList.length
]);
});

expenseData.push([
'üìä TOPLAM',
'',
formatNumber(totalExpensePlan),
formatNumber(totalExpensePlan * tryRate),
formatNumber(totalExpensePlan / daysInMonth),
formatNumber(totalExpenseFact),
formatNumber(totalExpenseFact * tryRate),
formatNumber(totalExpensePlan - totalExpenseFact),
totalExpensePlan > 0 ? `%${(totalExpenseFact / totalExpensePlan * 100).toFixed(0)}` : '%0',
''
]);
} else {
expenseData.push(['Kategori', 'P.B.', 'Plan ($)', 'Plan (‚Ç∫)', 'Ger√ßekle≈üen ($)', 'Ger√ßekle≈üen (‚Ç∫)', 'Fark ($)', 'Fark (‚Ç∫)', 'Oran %', 'ƒ∞≈ülem']);

categories.expense.forEach(cat => {
const plan = getCategoryYearlyPlan(cat);
const txList = yearTx.filter(t => t.categoryId === cat.id);
const fact = txList.reduce((sum, t) => sum + t.amountUSD, 0);
const diff = plan - fact;
const percent = plan > 0 ? (fact / plan * 100) : 0;
const budgetCurrency = getCategoryBudgetCurrency(cat);

totalExpensePlan += plan;
totalExpenseFact += fact;

expenseData.push([
cat.name,
budgetCurrency,
formatNumber(plan),
formatNumber(plan * tryRate),
formatNumber(fact),
formatNumber(fact * tryRate),
formatNumber(diff),
formatNumber(diff * tryRate),
`%${percent.toFixed(0)}`,
txList.length
]);
});

expenseData.push([
'üìä TOPLAM',
'',
formatNumber(totalExpensePlan),
formatNumber(totalExpensePlan * tryRate),
formatNumber(totalExpenseFact),
formatNumber(totalExpenseFact * tryRate),
formatNumber(totalExpensePlan - totalExpenseFact),
formatNumber((totalExpensePlan - totalExpenseFact) * tryRate),
totalExpensePlan > 0 ? `%${(totalExpenseFact / totalExpensePlan * 100).toFixed(0)}` : '%0',
''
]);
}

const wsExpense = XLSX.utils.aoa_to_sheet(expenseData);
setColumnWidths(wsExpense, [24, 8, 14, 16, 12, 14, 16, 12, 10, 8]);
wsExpense['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 9 } }];
if (wsExpense['A1']) wsExpense['A1'].s = { font: titleFont };

const expenseRange = { s: { r: 2, c: 0 }, e: { r: expenseData.length - 1, c: 9 } };
applyStyleToSheet(wsExpense, expenseRange, expenseData.slice(2), 2, { hasTotal: true, totalRowIndex: expenseData.length - 1 });

XLSX.utils.book_append_sheet(wb, wsExpense, 'Gider Kalemleri');

// ===== ƒ∞≈ûLEMLER SAYFASI =====
const txData = [];
txData.push(['üìã ƒ∞≈ûLEMLER', '', '', '', '', '', '', '', '']);
txData.push(['', '', '', '', '', '', '', '', '']);
txData.push(['Tarih', 'T√ºr', 'Kategori', 'Tutar ($)', 'Tutar (‚Ç∫)', 'Orijinal Tutar', 'Para Birimi', 'Kur', 'Not']);

const txList = isMonthly
? yearTx.filter(t => new Date(t.date).getMonth() === currentMonth)
: yearTx;

txList.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(tx => {
const cat = [...categories.income, ...categories.expense].find(c => c.id === tx.categoryId);
const catName = cat ? cat.name : 'Bilinmiyor';
const txTryRate = getRateForMonth('TRY', new Date(tx.date).getMonth());

txData.push([
new Date(tx.date).toLocaleDateString('tr-TR'),
tx.type === 'income' ? '‚úÖ Gelir' : '‚ùå Gider',
catName,
formatNumber(tx.amountUSD),
formatNumber(tx.amountUSD * txTryRate),
formatNumber(tx.amount),
tx.currency,
tx.rateAtTime?.toFixed(4) || '-',
tx.note || ''
]);
});

const wsTx = XLSX.utils.aoa_to_sheet(txData);
setColumnWidths(wsTx, [12, 12, 22, 14, 16, 14, 12, 10, 30]);
wsTx['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 8 } }];
if (wsTx['A1']) wsTx['A1'].s = { font: titleFont };

const txRange = { s: { r: 2, c: 0 }, e: { r: txData.length - 1, c: 8 } };
applyStyleToSheet(wsTx, txRange, txData.slice(2), 2);

XLSX.utils.book_append_sheet(wb, wsTx, 'ƒ∞≈ülemler');

// ===== AYLIK B√úT√áELER SAYFASI (Orijinal Para Birimi Bazƒ±nda) =====
const monthlyBudgetData = [];
monthlyBudgetData.push(['üìÖ AYLIK B√úT√áELER (Orijinal Para Birimi)', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']);
monthlyBudgetData.push(['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']);
monthlyBudgetData.push(['Kategori', 'T√ºr', 'P.B.', 'Oca', '≈ûub', 'Mar', 'Nis', 'May', 'Haz', 'Tem', 'Aƒüu', 'Eyl', 'Eki', 'Kas', 'Ara', 'Yƒ±llƒ±k']);

// Para birimi bazƒ±nda toplamlarƒ± tutacak objeler
const monthlyTotals = {
USD: { income: Array(12).fill(0), expense: Array(12).fill(0) },
TRY: { income: Array(12).fill(0), expense: Array(12).fill(0) },
RUB: { income: Array(12).fill(0), expense: Array(12).fill(0) }
};
const yearlyTotals = {
USD: { income: 0, expense: 0 },
TRY: { income: 0, expense: 0 },
RUB: { income: 0, expense: 0 }
};

// Gelirler
categories.income.forEach(cat => {
const budgetCurrency = getCategoryBudgetCurrency(cat);
const row = [cat.name, 'üí∞ Gelir', budgetCurrency];
let yearlyTotal = 0;

for (let i = 0; i < 12; i++) {
const planUSD = getCategoryMonthlyPlan(cat, i);
const rate = budgetCurrency === 'TRY' ? getRateForMonth('TRY', i) :
budgetCurrency === 'RUB' ? getRateForMonth('RUB', i) : 1;
const planOriginal = planUSD * rate;
row.push(formatNumber(planOriginal));
yearlyTotal += planOriginal;
monthlyTotals[budgetCurrency].income[i] += planOriginal;
}
row.push(formatNumber(yearlyTotal));
yearlyTotals[budgetCurrency].income += yearlyTotal;
monthlyBudgetData.push(row);
});

// Giderler
categories.expense.forEach(cat => {
const budgetCurrency = getCategoryBudgetCurrency(cat);
const row = [cat.name, 'üí∏ Gider', budgetCurrency];
let yearlyTotal = 0;

for (let i = 0; i < 12; i++) {
const planUSD = getCategoryMonthlyPlan(cat, i);
const rate = budgetCurrency === 'TRY' ? getRateForMonth('TRY', i) :
budgetCurrency === 'RUB' ? getRateForMonth('RUB', i) : 1;
const planOriginal = planUSD * rate;
row.push(formatNumber(planOriginal));
yearlyTotal += planOriginal;
monthlyTotals[budgetCurrency].expense[i] += planOriginal;
}
row.push(formatNumber(yearlyTotal));
yearlyTotals[budgetCurrency].expense += yearlyTotal;
monthlyBudgetData.push(row);
});

// Bo≈ü satƒ±r
monthlyBudgetData.push(['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']);

// Para birimi bazƒ±nda toplam satƒ±rlarƒ±
// USD Toplam
const usdTotalRow = ['üíµ USD TOPLAM', 'Net', 'USD'];
let usdYearlyNet = 0;
for (let i = 0; i < 12; i++) {
const net = monthlyTotals.USD.income[i] - monthlyTotals.USD.expense[i];
usdTotalRow.push(formatNumber(net));
usdYearlyNet += net;
}
usdTotalRow.push(formatNumber(usdYearlyNet));
monthlyBudgetData.push(usdTotalRow);

// TRY Toplam
const tryTotalRow = ['üíµ TRY TOPLAM', 'Net', 'TRY'];
let tryYearlyNet = 0;
for (let i = 0; i < 12; i++) {
const net = monthlyTotals.TRY.income[i] - monthlyTotals.TRY.expense[i];
tryTotalRow.push(formatNumber(net));
tryYearlyNet += net;
}
tryTotalRow.push(formatNumber(tryYearlyNet));
monthlyBudgetData.push(tryTotalRow);

// RUB Toplam
const rubTotalRow = ['üíµ RUB TOPLAM', 'Net', 'RUB'];
let rubYearlyNet = 0;
for (let i = 0; i < 12; i++) {
const net = monthlyTotals.RUB.income[i] - monthlyTotals.RUB.expense[i];
rubTotalRow.push(formatNumber(net));
rubYearlyNet += net;
}
rubTotalRow.push(formatNumber(rubYearlyNet));
monthlyBudgetData.push(rubTotalRow);

// Bo≈ü satƒ±r
monthlyBudgetData.push(['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']);

// Genel Toplam (USD bazƒ±nda)
const grandTotalRow = ['üìä GENEL TOPLAM', 'Net', 'USD'];
let grandYearlyTotal = 0;
for (let i = 0; i < 12; i++) {
const tryRate = getRateForMonth('TRY', i);
const rubRate = getRateForMonth('RUB', i);

const usdNet = monthlyTotals.USD.income[i] - monthlyTotals.USD.expense[i];
const tryNetUSD = tryRate > 0 ? (monthlyTotals.TRY.income[i] - monthlyTotals.TRY.expense[i]) / tryRate : 0;
const rubNetUSD = rubRate > 0 ? (monthlyTotals.RUB.income[i] - monthlyTotals.RUB.expense[i]) / rubRate : 0;

const totalUSD = usdNet + tryNetUSD + rubNetUSD;
grandTotalRow.push(formatNumber(totalUSD));
grandYearlyTotal += totalUSD;
}
grandTotalRow.push(formatNumber(grandYearlyTotal));
monthlyBudgetData.push(grandTotalRow);

const wsMonthlyBudget = XLSX.utils.aoa_to_sheet(monthlyBudgetData);
setColumnWidths(wsMonthlyBudget, [22, 10, 6, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 14]);
wsMonthlyBudget['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 15 } }];
if (wsMonthlyBudget['A1']) wsMonthlyBudget['A1'].s = { font: titleFont };

const budgetRange = { s: { r: 2, c: 0 }, e: { r: monthlyBudgetData.length - 1, c: 15 } };
applyStyleToSheet(wsMonthlyBudget, budgetRange, monthlyBudgetData.slice(2), 2, { hasTotal: true, totalRowIndex: monthlyBudgetData.length - 1 });

XLSX.utils.book_append_sheet(wb, wsMonthlyBudget, 'Aylƒ±k B√ºt√ßeler');

// ===== KURLAR SAYFASI =====
const ratesData = [];
ratesData.push(['üí± D√ñVƒ∞Z KURLARI (1 USD = ?)', '', '']);
ratesData.push(['', '', '']);
ratesData.push(['Ay', 'TRY (‚Ç∫)', 'RUB (‚ÇΩ)']);
for (let i = 0; i < 12; i++) {
ratesData.push([monthNamesFull[i], formatNumber(monthlyRates.TRY[i]), formatNumber(monthlyRates.RUB[i])]);
}

// Ortalama satƒ±rƒ±
const avgTRY = monthlyRates.TRY.reduce((a, b) => a + b, 0) / 12;
const avgRUB = monthlyRates.RUB.reduce((a, b) => a + b, 0) / 12;
ratesData.push(['üìä Ortalama', formatNumber(avgTRY), formatNumber(avgRUB)]);

const wsRates = XLSX.utils.aoa_to_sheet(ratesData);
setColumnWidths(wsRates, [16, 14, 14]);
wsRates['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 2 } }];
if (wsRates['A1']) wsRates['A1'].s = { font: titleFont };

const ratesRange = { s: { r: 2, c: 0 }, e: { r: ratesData.length - 1, c: 2 } };
applyStyleToSheet(wsRates, ratesRange, ratesData.slice(2), 2, { hasTotal: true, totalRowIndex: ratesData.length - 1 });

XLSX.utils.book_append_sheet(wb, wsRates, 'Kurlar');

// Dosyayƒ± kaydet
const filename = isMonthly
? `butce-${currentYear}-${String(currentMonth + 1).padStart(2, '0')}.xlsx`
: `butce-${currentYear}-yillik.xlsx`;

XLSX.writeFile(wb, filename);
showToast('Excel raporu olu≈üturuldu ‚úì');
}

function saveRates() {
const tryRates = getMonthlyRatesFromGrid('monthlyRatesTRY');
const rubRates = getMonthlyRatesFromGrid('monthlyRatesRUB');

// Validate all rates
const hasInvalidTRY = tryRates.some(r => !r || r <= 0);
const hasInvalidRUB = rubRates.some(r => !r || r <= 0);

if (hasInvalidTRY || hasInvalidRUB) {
showToast('T√ºm kurlarƒ± ge√ßerli girin');
return;
}

monthlyRates.TRY = tryRates;
monthlyRates.RUB = rubRates;

// Geriye uyumluluk i√ßin mevcut ay kurunu da g√ºncelle
exchangeRates.TRY = tryRates[currentMonth];
exchangeRates.RUB = rubRates[currentMonth];

closeModal('ratesModal');
saveData();
updateCurrentRatesDisplay();
showToast('Kurlar g√ºncellendi ‚úì');
}

// ==================== OTOMATIK KUR G√úNCELLEME ====================
let cachedLiveRates = { TRY: null, RUB: null, timestamp: null };

async function fetchCurrentRates() {
const icon = document.getElementById('fetchRateIcon');
const display = document.getElementById('currentRateDisplay');

// Animasyon ba≈ülat
icon.classList.add('fa-spin');

try {
// Frankfurter API - √ºcretsiz ve CORS destekli
const response = await fetch('https://api.frankfurter.app/latest?from=USD&to=TRY,RUB');

if (!response.ok) {
throw new Error('API yanƒ±t vermedi');
}

const data = await response.json();

if (data.rates && data.rates.TRY && data.rates.RUB) {
cachedLiveRates.TRY = data.rates.TRY;
cachedLiveRates.RUB = data.rates.RUB;
cachedLiveRates.timestamp = new Date();

// G√∂sterimi g√ºncelle
document.getElementById('liveRateTRY').textContent = data.rates.TRY.toFixed(4);
document.getElementById('liveRateRUB').textContent = data.rates.RUB.toFixed(4);
document.getElementById('rateUpdateTime').textContent =
`Son g√ºncelleme: ${cachedLiveRates.timestamp.toLocaleString('tr-TR')}`;

display.style.display = 'block';
showToast('G√ºncel kurlar alƒ±ndƒ± ‚úì');
} else {
throw new Error('Kur verisi alƒ±namadƒ±');
}
} catch (error) {
console.error('Kur API hatasƒ±:', error);

// Yedek API dene - ExchangeRate API
try {
const backupResponse = await fetch('https://open.er-api.com/v6/latest/USD');
const backupData = await backupResponse.json();

if (backupData.rates && backupData.rates.TRY && backupData.rates.RUB) {
cachedLiveRates.TRY = backupData.rates.TRY;
cachedLiveRates.RUB = backupData.rates.RUB;
cachedLiveRates.timestamp = new Date();

document.getElementById('liveRateTRY').textContent = backupData.rates.TRY.toFixed(4);
document.getElementById('liveRateRUB').textContent = backupData.rates.RUB.toFixed(4);
document.getElementById('rateUpdateTime').textContent =
`Son g√ºncelleme: ${cachedLiveRates.timestamp.toLocaleString('tr-TR')}`;

display.style.display = 'block';
showToast('G√ºncel kurlar alƒ±ndƒ± ‚úì');
} else {
throw new Error('Yedek API de √ßalƒ±≈ümadƒ±');
}
} catch (backupError) {
showToast('Kurlar alƒ±namadƒ±, internet baƒülantƒ±nƒ±zƒ± kontrol edin');
}
} finally {
icon.classList.remove('fa-spin');
}
}

function fillAllMonthsWithCurrent() {
if (!cachedLiveRates.TRY || !cachedLiveRates.RUB) {
showToast('√ñnce "G√ºncel Kurlarƒ± Al" butonuna tƒ±klayƒ±n');
return;
}

// T√ºm aylara g√ºncel kuru uygula
const tryInputs = document.querySelectorAll('#monthlyRatesTRY input');
const rubInputs = document.querySelectorAll('#monthlyRatesRUB input');

tryInputs.forEach(input => {
input.value = cachedLiveRates.TRY.toFixed(2);
});

rubInputs.forEach(input => {
input.value = cachedLiveRates.RUB.toFixed(2);
});

showToast('T√ºm aylara g√ºncel kur uygulandƒ± ‚úì');
}

function fillCurrentMonthWithLiveRate() {
if (!cachedLiveRates.TRY || !cachedLiveRates.RUB) {
return;
}

const tryInputs = document.querySelectorAll('#monthlyRatesTRY input');
const rubInputs = document.querySelectorAll('#monthlyRatesRUB input');

// Sadece mevcut ayƒ± g√ºncelle
if (tryInputs[currentMonth]) {
tryInputs[currentMonth].value = cachedLiveRates.TRY.toFixed(2);
}
if (rubInputs[currentMonth]) {
rubInputs[currentMonth].value = cachedLiveRates.RUB.toFixed(2);
}
}

// ==================== DELETE ====================
function confirmDelete(type, id, categoryType, name) {
const message = document.getElementById('confirmMessage');

if (type === 'category') {
const count = transactions.filter(t => t.categoryId === id).length;
message.textContent = count > 0
? `"${name}" ve ${count} i≈ülem silinecek.`
: `"${name}" silinecek.`;
deleteCallback = () => deleteCategory(id, categoryType);
} else {
message.textContent = 'Bu i≈ülem silinecek.';
deleteCallback = () => deleteTransaction(id);
}

document.getElementById('confirmModal').classList.add('active');
}

function closeConfirm() {
document.getElementById('confirmModal').classList.remove('active');
deleteCallback = null;
}

document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
if (deleteCallback) {
deleteCallback();
closeConfirm();
}
});

function deleteCategory(id, type) {
categories[type] = categories[type].filter(c => c.id !== id);
transactions = transactions.filter(t => t.categoryId !== id);
saveData();
updateAll();
showToast('Silindi');
}

function deleteTransaction(id) {
transactions = transactions.filter(t => t.id !== id);
saveData();
updateAll();
showToast('Silindi');
}

// ==================== INSTALL BANNER ====================
function showInstallBanner() {
document.getElementById('installBanner').classList.add('show');
}

function hideInstallBanner() {
document.getElementById('installBanner').classList.remove('show');
}

// ==================== TOAST ====================
function showToast(message) {
const existing = document.querySelector('.toast');
if (existing) existing.remove();

const toast = document.createElement('div');
toast.className = 'toast';
toast.textContent = message;
document.body.appendChild(toast);

setTimeout(() => {
toast.style.opacity = '0';
toast.style.transition = 'opacity 0.3s';
setTimeout(() => toast.remove(), 300);
}, 2000);
}

// ==================== UPDATE ALL ====================
function updateAll() {
updateSummary();
renderBudgets();
renderMonthFilter();
renderTransactions();
}

// ==================== INIT ====================
loadData();
document.getElementById('yearDisplay').textContent = currentYear;
document.getElementById('monthDisplay').textContent = monthNamesFull[currentMonth];
updateAll();

// Show install banner for iOS Safari
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
const isStandalone = window.navigator.standalone === true;
if (isIOS && !isStandalone) {
setTimeout(showInstallBanner, 2000);
}
</script>
</body>
</html>


