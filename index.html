

<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="B√ºt√ße">
<meta name="theme-color" content="#6c5ce7">
<title>B√ºt√ße Takip</title>

<!-- PWA Icons -->
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%236c5ce7' width='100' height='100' rx='20'/><text x='50' y='62' text-anchor='middle' font-size='45' fill='white'>üí∞</text></svg>">

<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Firebase SDK (via jsDelivr CDN - CSP uyumlu) -->
<script src="https://cdn.jsdelivr.net/npm/firebase@10.7.1/firebase-app-compat.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/firebase@10.7.1/firebase-database-compat.min.js"></script>

<style>
:root {
--bg-primary: #f8f5f1;
--bg-secondary: #ffffff;
--bg-card: #ffffff;
--text-primary: #2d3436;
--text-secondary: #636e72;
--accent-income: #00b894;
--accent-income-light: #e8f8f5;
--accent-expense: #e17055;
--accent-expense-light: #fef0ed;
--accent-main: #6c5ce7;
--accent-main-light: #f0eeff;
--accent-warning: #fdcb6e;
--accent-warning-light: #fef9e7;
--border-color: #e0dcd7;
--shadow: 0 4px 20px rgba(0,0,0,0.08);
--safe-top: env(safe-area-inset-top);
--safe-bottom: env(safe-area-inset-bottom);
}

.dark {
--bg-primary: #1a1a2e;
--bg-secondary: #16213e;
--bg-card: #1f2b47;
--text-primary: #edf2f7;
--text-secondary: #a0aec0;
--accent-income: #38d9a9;
--accent-income-light: rgba(56, 217, 169, 0.15);
--accent-expense: #ff7675;
--accent-expense-light: rgba(255, 118, 117, 0.15);
--accent-main: #a29bfe;
--accent-main-light: rgba(162, 155, 254, 0.15);
--accent-warning: #ffeaa7;
--accent-warning-light: rgba(253, 203, 110, 0.15);
--border-color: #2d3a5c;
--shadow: 0 4px 20px rgba(0,0,0,0.3);
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
-webkit-tap-highlight-color: transparent;
}

body {
font-family: 'Nunito', -apple-system, sans-serif;
background: var(--bg-primary);
color: var(--text-primary);
min-height: 100vh;
min-height: -webkit-fill-available;
padding-bottom: calc(100px + var(--safe-bottom));
overscroll-behavior: none;
}

.header {
background: linear-gradient(135deg, var(--accent-main) 0%, #a29bfe 100%);
padding: calc(16px + var(--safe-top)) 20px 24px;
color: white;
position: sticky;
top: 0;
z-index: 100;
display: flex;
justify-content: space-between;
align-items: center;
}

.header h1 {
font-size: 1.4rem;
font-weight: 800;
display: flex;
align-items: center;
gap: 10px;
}

.header h1 i { font-size: 1.2rem; }

.header-actions {
display: flex;
gap: 8px;
}

.header-btn {
background: rgba(255,255,255,0.2);
border: none;
width: 40px;
height: 40px;
border-radius: 12px;
color: white;
font-size: 1.1rem;
cursor: pointer;
transition: background 0.2s, transform 0.1s;
}

.header-btn:active {
background: rgba(255,255,255,0.3);
transform: scale(0.95);
}

.year-selector {
display: flex;
align-items: center;
justify-content: center;
gap: 16px;
padding: 16px;
background: var(--bg-card);
margin: -20px 16px 16px;
border-radius: 16px;
box-shadow: var(--shadow);
}

.year-btn {
background: var(--bg-secondary);
border: 2px solid var(--border-color);
width: 40px;
height: 40px;
border-radius: 12px;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
color: var(--text-secondary);
font-size: 1rem;
transition: all 0.2s;
}

.year-btn:active { transform: scale(0.95); }

.year-display {
font-size: 1.4rem;
font-weight: 800;
color: var(--accent-main);
}

.view-toggle {
display: flex;
margin: 0 16px 12px;
background: var(--bg-card);
border-radius: 12px;
padding: 4px;
box-shadow: var(--shadow);
}

.view-btn {
flex: 1;
padding: 10px;
text-align: center;
border-radius: 10px;
font-weight: 700;
font-size: 0.85rem;
cursor: pointer;
border: none;
background: transparent;
color: var(--text-secondary);
transition: all 0.2s;
}

.view-btn.active {
background: var(--accent-main);
color: white;
}

.month-selector {
display: flex;
align-items: center;
justify-content: center;
gap: 20px;
margin: 0 16px 12px;
}

.month-nav-btn {
background: var(--bg-card);
border: 2px solid var(--border-color);
width: 36px;
height: 36px;
border-radius: 10px;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
color: var(--text-secondary);
transition: all 0.2s;
}

.month-nav-btn:active { transform: scale(0.95); }

.month-display {
font-size: 1.1rem;
font-weight: 800;
color: var(--accent-main);
min-width: 80px;
text-align: center;
}

.chart-container {
padding: 0 16px 16px;
}

.chart-card {
background: var(--bg-card);
border-radius: 16px;
padding: 16px;
box-shadow: var(--shadow);
}

.chart-title {
font-size: 0.85rem;
font-weight: 700;
color: var(--text-secondary);
margin-bottom: 12px;
text-align: center;
}

.chart-card canvas {
max-height: 200px;
}

.summary-grid {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 12px;
padding: 0 16px 16px;
}

.summary-card {
background: var(--bg-card);
border-radius: 16px;
padding: 16px;
box-shadow: var(--shadow);
}

.summary-card.full { grid-column: 1 / -1; }

.summary-card .label {
font-size: 0.7rem;
color: var(--text-secondary);
text-transform: uppercase;
letter-spacing: 0.5px;
font-weight: 700;
margin-bottom: 4px;
}

.summary-card .amount {
font-size: 1.3rem;
font-weight: 800;
}

.summary-card .sub-amount {
font-size: 0.75rem;
color: var(--text-secondary);
margin-top: 2px;
}

.fact-row {
display: flex;
justify-content: space-between;
font-size: 0.75rem;
color: var(--text-secondary);
margin-top: 6px;
padding-top: 6px;
border-top: 1px dashed var(--border-color);
}

.fact-row span:last-child {
font-weight: 700;
}

.summary-card.income .amount { color: var(--accent-income); }
.summary-card.expense .amount { color: var(--accent-expense); }
.summary-card .amount.positive { color: var(--accent-income); }
.summary-card .amount.negative { color: var(--accent-expense); }

.plan-fact-bar {
height: 8px;
background: var(--border-color);
border-radius: 4px;
margin-top: 8px;
overflow: hidden;
}

.plan-fact-fill {
height: 100%;
border-radius: 4px;
transition: width 0.3s ease;
}

.plan-fact-fill.under { background: var(--accent-income); }
.plan-fact-fill.over { background: var(--accent-expense); }
.plan-fact-fill.warning { background: var(--accent-warning); }

.tabs {
display: flex;
margin: 0 16px 16px;
background: var(--bg-card);
border-radius: 14px;
padding: 4px;
box-shadow: var(--shadow);
}

.tab {
flex: 1;
padding: 14px 8px;
text-align: center;
border-radius: 12px;
font-weight: 700;
font-size: 0.9rem;
cursor: pointer;
transition: all 0.2s;
color: var(--text-secondary);
}

.tab.active {
background: var(--accent-main);
color: white;
}

.section {
padding: 0 16px;
display: none;
}

.section.active { display: block; }

.section-title {
font-size: 0.95rem;
font-weight: 700;
margin-bottom: 12px;
color: var(--text-primary);
display: flex;
align-items: center;
justify-content: space-between;
}

.budget-item {
background: var(--bg-card);
border-radius: 16px;
padding: 16px;
margin-bottom: 12px;
box-shadow: var(--shadow);
}

.budget-header {
display: flex;
align-items: center;
justify-content: space-between;
margin-bottom: 12px;
}

.budget-left {
display: flex;
align-items: center;
gap: 12px;
}

.budget-icon {
width: 44px;
height: 44px;
border-radius: 12px;
display: flex;
align-items: center;
justify-content: center;
font-size: 1.2rem;
}

.budget-icon.income {
background: var(--accent-income-light);
color: var(--accent-income);
}

.budget-icon.expense {
background: var(--accent-expense-light);
color: var(--accent-expense);
}

.budget-info h3 {
font-size: 1rem;
font-weight: 700;
}

.budget-info span {
font-size: 0.75rem;
color: var(--text-secondary);
}

.budget-actions {
display: flex;
gap: 4px;
}

.budget-stats {
display: grid;
grid-template-columns: 1fr 1fr 1fr;
gap: 8px;
margin-bottom: 10px;
}

.stat-box {
text-align: center;
padding: 10px 8px;
background: var(--bg-secondary);
border-radius: 10px;
}

.stat-box .stat-label {
font-size: 0.65rem;
color: var(--text-secondary);
text-transform: uppercase;
font-weight: 700;
}

.stat-box .stat-value {
font-size: 0.9rem;
font-weight: 800;
margin-top: 2px;
}

.stat-box .stat-value.plan { color: var(--accent-main); }
.stat-box .stat-value.fact { color: var(--text-primary); }
.stat-box .stat-value.diff.positive { color: var(--accent-income); }
.stat-box .stat-value.diff.negative { color: var(--accent-expense); }

.stat-box .stat-sub {
font-size: 0.65rem;
color: var(--text-secondary);
margin-top: 2px;
opacity: 0.8;
}

.daily-budget-info {
background: var(--bg-secondary);
border-radius: 10px;
padding: 10px 12px;
margin-top: 10px;
border: 1px dashed var(--border-color);
}

.daily-item {
display: flex;
justify-content: space-between;
align-items: center;
padding: 4px 0;
font-size: 0.8rem;
}

.daily-item:not(:last-child) {
border-bottom: 1px dotted var(--border-color);
}

.daily-label {
color: var(--text-secondary);
}

.daily-value {
font-weight: 700;
color: var(--text-primary);
}

.daily-value.positive {
color: var(--accent-income);
}

.daily-value.negative {
color: var(--accent-expense);
}

.daily-value small {
font-weight: 400;
opacity: 0.7;
}

/* B√ºt√ße √ñzeti Stili */
.budget-summary-section {
margin: 16px;
background: var(--bg-card);
border-radius: 16px;
padding: 16px;
box-shadow: var(--shadow);
}

.summary-title {
font-weight: 700;
font-size: 1rem;
color: var(--text-primary);
margin-bottom: 12px;
padding-bottom: 8px;
border-bottom: 2px solid var(--accent-main);
}

.currency-summary-grid {
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 12px;
}

.currency-card {
background: var(--bg-secondary);
border-radius: 12px;
padding: 12px;
text-align: center;
border: 2px solid var(--border-color);
}

.currency-card.usd { border-color: #27ae60; }
.currency-card.try { border-color: #e74c3c; }
.currency-card.rub { border-color: #3498db; }

.currency-symbol {
font-size: 1.5rem;
font-weight: 800;
margin-bottom: 4px;
}

.currency-card.usd .currency-symbol { color: #27ae60; }
.currency-card.try .currency-symbol { color: #e74c3c; }
.currency-card.rub .currency-symbol { color: #3498db; }

.currency-label {
font-size: 0.7rem;
color: var(--text-secondary);
margin-bottom: 8px;
}

.currency-row {
display: flex;
justify-content: space-between;
font-size: 0.75rem;
padding: 3px 0;
border-bottom: 1px dotted var(--border-color);
}

.currency-row:last-child {
border-bottom: none;
padding-top: 6px;
font-weight: 700;
}

.currency-row.income { color: var(--accent-income); }
.currency-row.expense { color: var(--accent-expense); }
.currency-row.net.positive { color: var(--accent-income); }
.currency-row.net.negative { color: var(--accent-expense); }

.original-currency {
font-size: 0.7rem;
color: var(--accent-main);
font-weight: 600;
display: block;
margin-top: 2px;
}

/* Cash Flow Stili */
.cashflow-section {
margin: 16px;
background: var(--bg-card);
border-radius: 16px;
padding: 16px;
box-shadow: var(--shadow);
}

.cashflow-table-wrapper {
overflow-x: auto;
margin-bottom: 12px;
}

.cashflow-table {
width: 100%;
border-collapse: collapse;
font-size: 0.7rem;
min-width: 600px;
}

.cashflow-table th,
.cashflow-table td {
padding: 8px 6px;
text-align: right;
border-bottom: 1px solid var(--border-color);
}

.cashflow-table th {
background: var(--accent-main);
color: white;
font-weight: 700;
font-size: 0.65rem;
text-transform: uppercase;
position: sticky;
top: 0;
}

.cashflow-table th:first-child,
.cashflow-table td:first-child {
text-align: left;
font-weight: 700;
}

.cashflow-table tbody tr:nth-child(even) {
background: var(--bg-secondary);
}

.cashflow-table tbody tr:hover {
background: var(--accent-main-light);
}

.cashflow-table tbody tr.current-month {
background: var(--accent-warning-light);
font-weight: 700;
}

.cashflow-table .positive {
color: var(--accent-income);
}

.cashflow-table .negative {
color: var(--accent-expense);
}

.cashflow-table tfoot {
background: var(--bg-secondary);
font-weight: 700;
}

.cashflow-table tfoot td {
border-top: 2px solid var(--accent-main);
padding: 10px 6px;
}

.cashflow-summary {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 12px;
margin-top: 12px;
}

.cashflow-card {
background: var(--bg-secondary);
border-radius: 12px;
padding: 12px;
text-align: center;
}

.cashflow-card.savings {
border: 2px solid var(--accent-income);
}

.cashflow-card.spending {
border: 2px solid var(--accent-expense);
}

.cashflow-card-title {
font-size: 0.75rem;
color: var(--text-secondary);
margin-bottom: 6px;
}

.cashflow-card-value {
font-size: 1.1rem;
font-weight: 800;
}

.cashflow-card.savings .cashflow-card-value {
color: var(--accent-income);
}

.cashflow-card.spending .cashflow-card-value {
color: var(--accent-expense);
}

.cashflow-card-sub {
font-size: 0.7rem;
color: var(--text-secondary);
margin-top: 4px;
}

/* Balance Sheet Stili */
.balance-sheet-section {
margin: 16px;
background: var(--bg-card);
border-radius: 16px;
padding: 16px;
box-shadow: var(--shadow);
}

.balance-sheet-container {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 16px;
}

@media (max-width: 768px) {
.balance-sheet-container {
grid-template-columns: 1fr;
}
}

.balance-card {
background: var(--bg-secondary);
border-radius: 14px;
padding: 16px;
transition: transform 0.2s;
}

.balance-card:hover {
transform: translateY(-2px);
}

.balance-card.assets-card {
border-left: 4px solid var(--accent-income);
}

.balance-card.liabilities-card {
border-left: 4px solid var(--accent-expense);
}

.balance-card.equity-card {
grid-column: 1 / -1;
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
color: white;
}

.balance-card-header {
display: flex;
align-items: center;
gap: 10px;
margin-bottom: 14px;
}

.balance-icon {
font-size: 1.5rem;
}

.balance-card-header h3 {
font-size: 1rem;
font-weight: 700;
margin: 0;
}

.balance-items {
display: flex;
flex-direction: column;
gap: 10px;
}

.balance-item {
display: flex;
align-items: center;
gap: 10px;
padding: 12px;
background: var(--bg-card);
border-radius: 10px;
cursor: pointer;
transition: all 0.2s;
}

.balance-item:hover {
background: var(--accent-main-light);
transform: translateX(4px);
}

.balance-item-icon {
font-size: 1.2rem;
}

.balance-item-label {
flex: 1;
font-size: 0.85rem;
font-weight: 500;
}

.balance-item-value {
font-size: 0.95rem;
font-weight: 700;
color: var(--accent-income);
}

.balance-item-value.liability {
color: var(--accent-expense);
}

.balance-total {
display: flex;
justify-content: space-between;
align-items: center;
margin-top: 14px;
padding: 14px;
background: var(--accent-income);
color: white;
border-radius: 10px;
font-weight: 700;
}

.balance-total.liability {
background: var(--accent-expense);
}

.equity-formula {
display: flex;
align-items: center;
justify-content: center;
gap: 12px;
flex-wrap: wrap;
padding: 16px;
}

.formula-item {
text-align: center;
padding: 12px 16px;
border-radius: 10px;
background: rgba(255,255,255,0.15);
}

.formula-item span:first-child {
display: block;
font-size: 0.75rem;
opacity: 0.9;
margin-bottom: 4px;
}

.formula-item span:last-child {
font-size: 1.1rem;
font-weight: 800;
}

.formula-operator {
font-size: 1.5rem;
font-weight: 700;
}

.formula-result {
text-align: center;
padding: 14px 20px;
border-radius: 12px;
background: rgba(255,255,255,0.25);
border: 2px solid rgba(255,255,255,0.4);
}

.formula-result span:first-child {
display: block;
font-size: 0.8rem;
margin-bottom: 4px;
}

.formula-result span:last-child {
font-size: 1.3rem;
font-weight: 800;
}

.balance-item-info {
flex: 1;
display: flex;
flex-direction: column;
gap: 2px;
}

.balance-item-note {
font-size: 0.7rem;
color: var(--text-secondary);
font-style: italic;
max-width: 180px;
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
}

textarea {
width: 100%;
padding: 14px;
border: 2px solid var(--border-color);
border-radius: 12px;
font-size: 0.95rem;
font-family: inherit;
background: var(--bg-secondary);
color: var(--text-main);
resize: vertical;
min-height: 80px;
}

textarea:focus {
outline: none;
border-color: var(--accent-main);
}

textarea::placeholder {
color: var(--text-secondary);
opacity: 0.7;
}

.action-btn {
background: none;
border: none;
color: var(--text-secondary);
padding: 10px;
cursor: pointer;
font-size: 0.9rem;
opacity: 0.6;
transition: opacity 0.2s, color 0.2s;
border-radius: 8px;
}

.action-btn:active { opacity: 1; }
.action-btn.delete:active { color: var(--accent-expense); }
.action-btn.edit:active { color: var(--accent-main); }

.transaction-item {
background: var(--bg-card);
border-radius: 14px;
padding: 14px 16px;
margin-bottom: 10px;
box-shadow: var(--shadow);
}

.transaction-header {
display: flex;
justify-content: space-between;
align-items: center;
}

.transaction-category {
font-size: 0.9rem;
font-weight: 700;
}

.transaction-date {
font-size: 0.75rem;
color: var(--text-secondary);
}

.transaction-details {
display: flex;
justify-content: space-between;
align-items: center;
margin-top: 8px;
}

.transaction-note {
font-size: 0.85rem;
color: var(--text-secondary);
flex: 1;
}

.transaction-amounts { text-align: right; }

.transaction-amount {
font-weight: 800;
font-size: 1.05rem;
}

.transaction-amount.income { color: var(--accent-income); }
.transaction-amount.expense { color: var(--accent-expense); }

.transaction-usd {
font-size: 0.7rem;
color: var(--text-secondary);
}

.transaction-rate {
font-size: 0.65rem;
color: var(--text-secondary);
opacity: 0.7;
}

.add-btn {
background: var(--accent-main);
color: white;
border: none;
padding: 10px 16px;
border-radius: 10px;
font-weight: 700;
font-size: 0.85rem;
cursor: pointer;
display: flex;
align-items: center;
gap: 6px;
transition: transform 0.2s;
}

.add-btn:active { transform: scale(0.95); }

.fab {
position: fixed;
bottom: calc(24px + var(--safe-bottom));
right: 24px;
width: 64px;
height: 64px;
border-radius: 50%;
background: linear-gradient(135deg, var(--accent-main) 0%, #a29bfe 100%);
color: white;
border: none;
font-size: 1.6rem;
cursor: pointer;
box-shadow: 0 6px 24px rgba(108, 92, 231, 0.4);
display: flex;
align-items: center;
justify-content: center;
transition: transform 0.2s;
z-index: 100;
}

.fab:active { transform: scale(0.9); }

.modal-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0,0,0,0.5);
display: none;
align-items: flex-end;
justify-content: center;
z-index: 200;
}

.modal-overlay.active { display: flex; }

.modal {
background: var(--bg-card);
width: 100%;
max-width: 500px;
border-radius: 24px 24px 0 0;
padding: 24px;
padding-bottom: calc(24px + var(--safe-bottom));
max-height: 90vh;
overflow-y: auto;
animation: slideUp 0.3s ease;
}

@keyframes slideUp {
from { transform: translateY(100%); }
to { transform: translateY(0); }
}

.modal-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
}

.modal-header h2 {
font-size: 1.2rem;
font-weight: 800;
}

.modal-close {
background: var(--bg-secondary);
border: none;
font-size: 1.3rem;
cursor: pointer;
color: var(--text-secondary);
width: 36px;
height: 36px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
}

.form-group {
margin-bottom: 18px;
}

.form-group label {
display: block;
font-size: 0.85rem;
font-weight: 700;
margin-bottom: 8px;
color: var(--text-secondary);
}

.form-group input, .form-group select {
width: 100%;
padding: 16px;
border: 2px solid var(--border-color);
border-radius: 14px;
font-size: 16px;
font-family: 'Nunito', sans-serif;
background: var(--bg-secondary);
color: var(--text-primary);
transition: border-color 0.2s;
}

.form-group input:focus, .form-group select:focus {
outline: none;
border-color: var(--accent-main);
}

.type-toggle {
display: flex;
gap: 10px;
margin-bottom: 18px;
}

.type-btn {
flex: 1;
padding: 16px;
border: 2px solid var(--border-color);
border-radius: 14px;
background: var(--bg-secondary);
font-weight: 700;
font-size: 0.95rem;
cursor: pointer;
transition: all 0.2s;
color: var(--text-secondary);
}

.type-btn.income.active {
border-color: var(--accent-income);
background: var(--accent-income-light);
color: var(--accent-income);
}

.type-btn.expense.active {
border-color: var(--accent-expense);
background: var(--accent-expense-light);
color: var(--accent-expense);
}

.currency-toggle {
display: flex;
gap: 8px;
}

.currency-btn {
flex: 1;
padding: 14px 8px;
border: 2px solid var(--border-color);
border-radius: 12px;
background: var(--bg-secondary);
font-weight: 700;
font-size: 0.9rem;
cursor: pointer;
transition: all 0.2s;
color: var(--text-secondary);
}

.currency-btn.active {
border-color: var(--accent-main);
background: var(--accent-main-light);
color: var(--accent-main);
}

/* Toggle Switch */
.toggle-switch {
position: relative;
display: inline-block;
width: 52px;
height: 28px;
}
.toggle-switch input {
opacity: 0;
width: 0;
height: 0;
}
.toggle-slider {
position: absolute;
cursor: pointer;
top: 0;
left: 0;
right: 0;
bottom: 0;
background-color: var(--border-color);
transition: 0.3s;
border-radius: 28px;
}
.toggle-slider:before {
position: absolute;
content: "";
height: 22px;
width: 22px;
left: 3px;
bottom: 3px;
background-color: white;
transition: 0.3s;
border-radius: 50%;
box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.toggle-switch input:checked + .toggle-slider {
background: linear-gradient(135deg, var(--accent-main) 0%, #a29bfe 100%);
}
.toggle-switch input:checked + .toggle-slider:before {
transform: translateX(24px);
}

.submit-btn {
width: 100%;
padding: 18px;
border: none;
border-radius: 14px;
background: linear-gradient(135deg, var(--accent-main) 0%, #a29bfe 100%);
color: white;
font-size: 1.05rem;
font-weight: 800;
cursor: pointer;
transition: transform 0.2s;
margin-top: 8px;
}

.submit-btn:active { transform: scale(0.98); }

.monthly-grid {
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 8px;
}

.monthly-input {
display: flex;
flex-direction: column;
gap: 4px;
}

.monthly-input label {
font-size: 0.7rem;
color: var(--text-secondary);
margin: 0;
text-align: center;
}

.monthly-input input {
padding: 10px 8px;
text-align: center;
font-size: 14px;
}

.fill-equal-btn {
background: var(--accent-main-light);
color: var(--accent-main);
border: none;
padding: 4px 10px;
border-radius: 6px;
font-size: 0.75rem;
font-weight: 700;
cursor: pointer;
margin-left: 8px;
}

.fill-equal-btn:active {
transform: scale(0.95);
}

.icon-grid {
display: grid;
grid-template-columns: repeat(6, 1fr);
gap: 8px;
max-height: 140px;
overflow-y: auto;
padding: 10px;
background: var(--bg-secondary);
border-radius: 14px;
border: 2px solid var(--border-color);
}

.icon-option {
width: 100%;
aspect-ratio: 1;
border: none;
border-radius: 10px;
background: var(--bg-card);
cursor: pointer;
font-size: 1.2rem;
display: flex;
align-items: center;
justify-content: center;
transition: all 0.2s;
}

.icon-option.selected {
background: var(--accent-main-light);
box-shadow: 0 0 0 2px var(--accent-main);
}

.empty-state {
text-align: center;
padding: 50px 20px;
color: var(--text-secondary);
}

.empty-state i {
font-size: 3.5rem;
margin-bottom: 16px;
opacity: 0.4;
}

.empty-state p { font-size: 0.95rem; }

.category-select-grid {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 10px;
max-height: 180px;
overflow-y: auto;
}

.category-select-item {
padding: 14px;
border: 2px solid var(--border-color);
border-radius: 12px;
background: var(--bg-secondary);
cursor: pointer;
text-align: center;
transition: all 0.2s;
}

.category-select-item.selected {
border-color: var(--accent-main);
background: var(--accent-main-light);
}

.category-select-item i {
display: block;
font-size: 1.4rem;
margin-bottom: 6px;
}

.category-select-item span {
font-size: 0.85rem;
font-weight: 600;
}

.confirm-modal {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0,0,0,0.5);
display: none;
align-items: center;
justify-content: center;
z-index: 300;
padding: 20px;
}

.confirm-modal.active { display: flex; }

.confirm-box {
background: var(--bg-card);
border-radius: 20px;
padding: 28px;
max-width: 320px;
width: 100%;
text-align: center;
animation: scaleIn 0.2s ease;
}

@keyframes scaleIn {
from { transform: scale(0.9); opacity: 0; }
to { transform: scale(1); opacity: 1; }
}

.confirm-box h3 {
margin-bottom: 12px;
font-size: 1.1rem;
}

.confirm-box p {
color: var(--text-secondary);
font-size: 0.9rem;
margin-bottom: 24px;
}

.confirm-buttons {
display: flex;
gap: 12px;
}

.confirm-buttons button {
flex: 1;
padding: 14px;
border: none;
border-radius: 12px;
font-weight: 700;
font-size: 0.95rem;
cursor: pointer;
}

.confirm-buttons button:active { transform: scale(0.95); }

.confirm-cancel {
background: var(--bg-secondary);
color: var(--text-primary);
border: 2px solid var(--border-color) !important;
}

.confirm-delete {
background: var(--accent-expense);
color: white;
}

.rates-display {
display: flex;
gap: 8px;
flex-wrap: wrap;
margin-top: 10px;
}

.rate-chip {
background: var(--bg-secondary);
padding: 6px 12px;
border-radius: 20px;
font-size: 0.8rem;
font-weight: 600;
color: var(--text-secondary);
}

.month-filter {
display: flex;
gap: 8px;
overflow-x: auto;
padding: 10px 0;
margin-bottom: 14px;
-webkit-overflow-scrolling: touch;
}

.month-chip {
padding: 10px 16px;
background: var(--bg-card);
border: 2px solid var(--border-color);
border-radius: 20px;
font-size: 0.85rem;
font-weight: 700;
cursor: pointer;
white-space: nowrap;
transition: all 0.2s;
color: var(--text-secondary);
}

.month-chip.active {
background: var(--accent-main);
border-color: var(--accent-main);
color: white;
}

.toast {
position: fixed;
bottom: calc(100px + var(--safe-bottom));
left: 50%;
transform: translateX(-50%);
background: var(--text-primary);
color: var(--bg-primary);
padding: 14px 28px;
border-radius: 30px;
font-weight: 600;
font-size: 0.95rem;
z-index: 400;
animation: fadeInUp 0.3s ease;
}

/* Sync Status Indicator */
.sync-status {
position: fixed;
top: calc(10px + var(--safe-top));
right: 10px;
display: flex;
align-items: center;
gap: 6px;
padding: 6px 12px;
border-radius: 20px;
font-size: 0.7rem;
font-weight: 600;
z-index: 500;
transition: all 0.3s ease;
}
.sync-status.online {
background: rgba(0, 184, 148, 0.15);
color: var(--accent-income);
}
.sync-status.offline {
background: rgba(225, 112, 85, 0.15);
color: var(--accent-expense);
}
.sync-status.syncing {
background: rgba(108, 92, 231, 0.15);
color: var(--accent-main);
}
.sync-dot {
width: 8px;
height: 8px;
border-radius: 50%;
background: currentColor;
}
.sync-status.syncing .sync-dot {
animation: pulse 1s infinite;
}
@keyframes pulse {
0%, 100% { opacity: 1; }
50% { opacity: 0.3; }
}

@keyframes fadeInUp {
from { opacity: 0; transform: translateX(-50%) translateY(20px); }
to { opacity: 1; transform: translateX(-50%) translateY(0); }
}

.install-banner {
position: fixed;
bottom: calc(100px + var(--safe-bottom));
left: 16px;
right: 16px;
background: var(--bg-card);
border-radius: 16px;
padding: 16px;
box-shadow: 0 8px 30px rgba(0,0,0,0.2);
z-index: 150;
display: none;
animation: slideUp 0.3s ease;
}

.install-banner.show { display: block; }

.install-banner h3 {
font-size: 1rem;
margin-bottom: 8px;
}

.install-banner p {
font-size: 0.85rem;
color: var(--text-secondary);
margin-bottom: 12px;
}

.install-banner .steps {
font-size: 0.8rem;
color: var(--text-secondary);
background: var(--bg-secondary);
padding: 12px;
border-radius: 10px;
margin-bottom: 12px;
}

.install-banner button {
width: 100%;
padding: 12px;
border: none;
border-radius: 10px;
font-weight: 700;
cursor: pointer;
}

.install-banner .install-close {
background: var(--bg-secondary);
color: var(--text-primary);
}
</style>
</head>
<body>
<!-- Sync Status Indicator -->
<div id="syncStatus" class="sync-status online">
<span class="sync-dot"></span>
<span id="syncText">Baƒülantƒ± kuruldu</span>
</div>

<header class="header">
<h1><i class="fas fa-chart-pie"></i> B√ºt√ße Takip</h1>
<div class="header-actions">
<button class="header-btn" onclick="generatePDFReport()" title="PDF Rapor">
<i class="fas fa-file-pdf"></i>
</button>
<button class="header-btn" onclick="generateExcelReport()" title="Excel Rapor">
<i class="fas fa-file-excel"></i>
</button>
<button class="header-btn" onclick="openDataModal()" title="Veri Y√∂netimi">
<i class="fas fa-database"></i>
</button>
<button class="header-btn" onclick="openRatesModal()" title="D√∂viz Kurlarƒ±">
<i class="fas fa-coins"></i>
</button>
<button class="header-btn" onclick="showInstallBanner()" title="Y√ºkle">
<i class="fas fa-download"></i>
</button>
</div>
</header>

<div class="year-selector">
<button class="year-btn" onclick="changeYear(-1)"><i class="fas fa-chevron-left"></i></button>
<span class="year-display" id="yearDisplay">2025</span>
<button class="year-btn" onclick="changeYear(1)"><i class="fas fa-chevron-right"></i></button>
</div>

<!-- Aylƒ±k/Yƒ±llƒ±k Toggle -->
<div class="view-toggle" id="viewToggle">
<button class="view-btn active" data-view="monthly">Aylƒ±k</button>
<button class="view-btn" data-view="yearly">Yƒ±llƒ±k</button>
</div>

<!-- Ay Se√ßici (Aylƒ±k g√∂r√ºn√ºmde) -->
<div class="month-selector" id="monthSelector">
<button class="month-nav-btn" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
<span class="month-display" id="monthDisplay">Ocak</span>
<button class="month-nav-btn" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
</div>

<div class="summary-grid">
<div class="summary-card income">
<div class="label" id="incomeLabel">Aylƒ±k Gelir Planƒ±</div>
<div class="amount" id="planIncome">$0</div>
<div class="sub-amount" id="planIncomeSub">‚Ç∫0 / ‚ÇΩ0</div>
<div class="fact-row" id="factIncomeRow">
<span id="factIncome">Ger√ßekle≈üen: $0</span>
<span id="factIncomeSub">‚Ç∫0 / ‚ÇΩ0</span>
</div>
<div class="plan-fact-bar">
<div class="plan-fact-fill under" id="incomeBar" style="width: 0%"></div>
</div>
</div>
<div class="summary-card expense">
<div class="label" id="expenseLabel">Aylƒ±k Gider Planƒ±</div>
<div class="amount" id="planExpense">$0</div>
<div class="sub-amount" id="planExpenseSub">‚Ç∫0 / ‚ÇΩ0</div>
<div class="fact-row" id="factExpenseRow">
<span id="factExpense">Ger√ßekle≈üen: $0</span>
<span id="factExpenseSub">‚Ç∫0 / ‚ÇΩ0</span>
</div>
<div class="plan-fact-bar">
<div class="plan-fact-fill under" id="expenseBar" style="width: 0%"></div>
</div>
</div>
<div class="summary-card full">
<div class="label">Net Durum (Ger√ßekle≈üen)</div>
<div class="amount positive" id="netBalance">$0</div>
<div class="sub-amount" id="netBalanceSub">‚Ç∫0 / ‚ÇΩ0</div>
</div>
</div>

<!-- B√ºt√ße √ñzeti - Para Birimi Bazƒ±nda -->
<div class="budget-summary-section" id="budgetSummarySection">
<div class="summary-title">üìä B√ºt√ße √ñzeti (Para Birimi Bazƒ±nda)</div>
<div class="currency-summary-grid" id="currencySummaryGrid"></div>
</div>

<!-- Aylƒ±k Cash Flow -->
<div class="cashflow-section" id="cashflowSection">
<div class="summary-title">üí∞ Aylƒ±k Nakit Akƒ±≈üƒ± (Cash Flow)</div>
<div class="cashflow-table-wrapper">
<table class="cashflow-table" id="cashflowTable">
<thead>
<tr>
<th>Ay</th>
<th>Gelir Plan</th>
<th>Gelir Ger√ß.</th>
<th>Gider Plan</th>
<th>Gider Ger√ß.</th>
<th>Net Plan</th>
<th>Net Ger√ß.</th>
<th>K√ºm√ºlatif</th>
</tr>
</thead>
<tbody id="cashflowBody"></tbody>
<tfoot id="cashflowFoot"></tfoot>
</table>
</div>
<div class="cashflow-summary" id="cashflowSummary"></div>
</div>

<!-- Balance Sheet (Bilan√ßo) -->
<div class="balance-sheet-section" id="balanceSheetSection">
<div class="summary-title">üìä Bilan√ßo (Balance Sheet)</div>
<div class="balance-sheet-container">
<!-- Assets (Varlƒ±klar) -->
<div class="balance-card assets-card">
<div class="balance-card-header">
<span class="balance-icon">üíé</span>
<h3>Varlƒ±klar (Assets)</h3>
</div>
<div class="balance-items">
<div class="balance-item" onclick="openBalanceModal('cash')">
<span class="balance-item-icon">üíµ</span>
<div class="balance-item-info">
<span class="balance-item-label">Nakit (Cash)</span>
<span class="balance-item-note" id="bsCashNote"></span>
</div>
<span class="balance-item-value" id="bsCash">$0</span>
</div>
<div class="balance-item" onclick="openBalanceModal('investments')">
<span class="balance-item-icon">üìà</span>
<div class="balance-item-info">
<span class="balance-item-label">Yatƒ±rƒ±mlar (Investments)</span>
<span class="balance-item-note" id="bsInvestmentsNote"></span>
</div>
<span class="balance-item-value" id="bsInvestments">$0</span>
</div>
<div class="balance-item" onclick="openBalanceModal('receivables')">
<span class="balance-item-icon">üìã</span>
<div class="balance-item-info">
<span class="balance-item-label">Alacaklar (Receivables)</span>
<span class="balance-item-note" id="bsReceivablesNote"></span>
</div>
<span class="balance-item-value" id="bsReceivables">$0</span>
</div>
</div>
<div class="balance-total">
<span>Toplam Varlƒ±klar</span>
<span id="bsTotalAssets">$0</span>
</div>
</div>

<!-- Liabilities (Bor√ßlar) -->
<div class="balance-card liabilities-card">
<div class="balance-card-header">
<span class="balance-icon">üìâ</span>
<h3>Bor√ßlar (Liabilities)</h3>
</div>
<div class="balance-items">
<div class="balance-item" onclick="openBalanceModal('credits')">
<span class="balance-item-icon">üè¶</span>
<div class="balance-item-info">
<span class="balance-item-label">Krediler (Credits)</span>
<span class="balance-item-note" id="bsCreditsNote"></span>
</div>
<span class="balance-item-value liability" id="bsCredits">$0</span>
</div>
<div class="balance-item" onclick="openBalanceModal('debitCards')">
<span class="balance-item-icon">üí≥</span>
<div class="balance-item-info">
<span class="balance-item-label">Kredi Kartlarƒ± (Debit Cards)</span>
<span class="balance-item-note" id="bsDebitCardsNote"></span>
</div>
<span class="balance-item-value liability" id="bsDebitCards">$0</span>
</div>
<div class="balance-item" onclick="openBalanceModal('debts')">
<span class="balance-item-icon">üìù</span>
<div class="balance-item-info">
<span class="balance-item-label">Bor√ßlar (Debts)</span>
<span class="balance-item-note" id="bsDebtsNote"></span>
</div>
<span class="balance-item-value liability" id="bsDebts">$0</span>
</div>
</div>
<div class="balance-total liability">
<span>Toplam Bor√ßlar</span>
<span id="bsTotalLiabilities">$0</span>
</div>
</div>

<!-- Equity (√ñz Sermaye) -->
<div class="balance-card equity-card">
<div class="balance-card-header">
<span class="balance-icon">‚öñÔ∏è</span>
<h3>√ñz Sermaye (Equity)</h3>
</div>
<div class="equity-formula">
<div class="formula-item positive">
<span>Toplam Varlƒ±klar</span>
<span id="eqAssets">$0</span>
</div>
<div class="formula-operator">‚àí</div>
<div class="formula-item negative">
<span>Toplam Bor√ßlar</span>
<span id="eqLiabilities">$0</span>
</div>
<div class="formula-operator">=</div>
<div class="formula-result" id="eqResult">
<span>√ñz Sermaye</span>
<span id="bsTotalEquity">$0</span>
</div>
</div>
</div>
</div>
</div>

<!-- Grafikler -->
<div class="chart-container">
<div class="chart-card">
<div class="chart-title">Aylƒ±k B√ºt√ße vs Ger√ßekle≈üen</div>
<canvas id="monthlyChart"></canvas>
</div>
</div>

<div class="tabs">
<div class="tab active" data-tab="budget">B√ºt√ße</div>
<div class="tab" data-tab="transactions">ƒ∞≈ülemler</div>
</div>

<section class="section active" id="budget-section">
<div class="section-title">
<span>Gelir Kalemleri</span>
<button class="add-btn" onclick="openCategoryModal('income')">
<i class="fas fa-plus"></i> Ekle
</button>
</div>
<div id="incomeBudgets"></div>

<div class="section-title" style="margin-top: 24px;">
<span>Gider Kalemleri</span>
<button class="add-btn" onclick="openCategoryModal('expense')">
<i class="fas fa-plus"></i> Ekle
</button>
</div>
<div id="expenseBudgets"></div>
</section>

<section class="section" id="transactions-section">
<div class="month-filter" id="monthFilter"></div>
<div id="transactionsList"></div>
</section>

<button class="fab" onclick="openTransactionModal()">
<i class="fas fa-plus"></i>
</button>

<!-- Install Banner -->
<div class="install-banner" id="installBanner">
<h3>üì± iPhone'a Y√ºkle</h3>
<p>Bu uygulamayƒ± ana ekranƒ±nƒ±za ekleyebilirsiniz:</p>
<div class="steps">
1Ô∏è‚É£ Safari'de <strong>Payla≈ü</strong> butonuna tƒ±klayƒ±n <i class="fas fa-share-square"></i><br>
2Ô∏è‚É£ <strong>"Ana Ekrana Ekle"</strong> se√ßin<br>
3Ô∏è‚É£ <strong>"Ekle"</strong> butonuna tƒ±klayƒ±n
</div>
<button class="install-close" onclick="hideInstallBanner()">Anladƒ±m</button>
</div>

<!-- Transaction Modal -->
<div class="modal-overlay" id="transactionModal">
<div class="modal">
<div class="modal-header">
<h2>Yeni ƒ∞≈ülem</h2>
<button class="modal-close" onclick="closeModal('transactionModal')">√ó</button>
</div>
<div class="type-toggle">
<button class="type-btn income active" onclick="setTransactionType('income')">
<i class="fas fa-arrow-down"></i> Gelir
</button>
<button class="type-btn expense" onclick="setTransactionType('expense')">
<i class="fas fa-arrow-up"></i> Gider
</button>
</div>
<div class="form-group">
<label>Kategori</label>
<div class="category-select-grid" id="categorySelectGrid"></div>
</div>
<div class="form-group">
<label>Para Birimi</label>
<div class="currency-toggle" id="currencyToggle">
<button class="currency-btn active" data-currency="USD" onclick="selectTransactionCurrency('USD')">$ USD</button>
<button class="currency-btn" data-currency="TRY" onclick="selectTransactionCurrency('TRY')">‚Ç∫ TRY</button>
<button class="currency-btn" data-currency="RUB" onclick="selectTransactionCurrency('RUB')">‚ÇΩ RUB</button>
</div>
<div id="liveRateBox" style="background: var(--accent-main-light); padding: 10px 14px; border-radius: 10px; margin-top: 10px; display: none;">
<div style="display: flex; justify-content: space-between; align-items: center;">
<div>
<span style="font-size: 0.75rem; color: var(--text-secondary);">üì° G√ºncel Kur</span>
<div style="font-weight: 700; color: var(--accent-main); font-size: 1.1rem;" id="liveRateValue">-</div>
</div>
<div style="text-align: right;">
<span style="font-size: 0.75rem; color: var(--text-secondary);">‚âà Dolar Kar≈üƒ±lƒ±ƒüƒ±</span>
<div style="font-weight: 700; color: var(--text-primary); font-size: 1.1rem;" id="liveUsdEquivalent">$0</div>
</div>
</div>
<div style="font-size: 0.65rem; color: var(--text-secondary); margin-top: 6px; text-align: center;" id="liveRateTime"></div>
</div>
<div class="rates-display" id="currentRates"></div>
</div>
<div class="form-group">
<label>Tutar</label>
<input type="number" id="transactionAmount" placeholder="0.00" step="0.01" inputmode="decimal" oninput="updateUsdEquivalent()">
</div>
<div class="form-group">
<label>Not (Opsiyonel)</label>
<input type="text" id="transactionNote" placeholder="A√ßƒ±klama...">
</div>
<div class="form-group">
<label>Tarih</label>
<input type="date" id="transactionDate">
</div>
<button class="submit-btn" onclick="saveTransaction()">Kaydet</button>
</div>
</div>

<!-- Category Modal -->
<div class="modal-overlay" id="categoryModal">
<div class="modal">
<div class="modal-header">
<h2 id="categoryModalTitle">Yeni Kategori</h2>
<button class="modal-close" onclick="closeModal('categoryModal')">√ó</button>
</div>
<div class="form-group">
<label>Kategori Adƒ±</label>
<input type="text" id="categoryName" placeholder="√ñrn: Maa≈ü, Kira...">
</div>
<div class="form-group">
<label>B√ºt√ße Para Birimi</label>
<div class="currency-toggle" id="categoryCurrencyToggle">
<button type="button" class="currency-btn active" data-currency="USD" onclick="setCategoryCurrency('USD')">$ USD</button>
<button type="button" class="currency-btn" data-currency="TRY" onclick="setCategoryCurrency('TRY')">‚Ç∫ TRY</button>
<button type="button" class="currency-btn" data-currency="RUB" onclick="setCategoryCurrency('RUB')">‚ÇΩ RUB</button>
</div>
<div class="rates-display" id="categoryRatesDisplay"></div>
</div>
<div class="form-group">
<label id="yearlyBudgetLabel">Yƒ±llƒ±k B√ºt√ße ($)</label>
<input type="number" id="categoryYearlyBudget" placeholder="0.00" step="0.01" inputmode="decimal">
</div>
<div class="form-group">
<label id="monthlyBudgetLabel">Aylƒ±k B√ºt√ßeler ($) <button type="button" class="fill-equal-btn" onclick="fillEqualMonthly()">E≈üit Daƒüƒ±t</button></label>
<div class="monthly-grid" id="monthlyBudgetGrid"></div>
</div>
<div class="form-group">
<label>ƒ∞kon</label>
<div class="icon-grid" id="iconGrid"></div>
</div>
<button class="submit-btn" onclick="saveCategory()">Kaydet</button>
</div>
</div>

<!-- Edit Budget Modal -->
<div class="modal-overlay" id="editBudgetModal">
<div class="modal">
<div class="modal-header">
<h2>D√ºzenle</h2>
<button class="modal-close" onclick="closeModal('editBudgetModal')">√ó</button>
</div>
<div class="form-group">
<label>Kategori Adƒ±</label>
<input type="text" id="editCategoryName">
</div>
<div class="form-group">
<label>B√ºt√ße Para Birimi</label>
<div class="currency-toggle" id="editCategoryCurrencyToggle">
<button type="button" class="currency-btn active" data-currency="USD" onclick="setEditCategoryCurrency('USD')">$ USD</button>
<button type="button" class="currency-btn" data-currency="TRY" onclick="setEditCategoryCurrency('TRY')">‚Ç∫ TRY</button>
<button type="button" class="currency-btn" data-currency="RUB" onclick="setEditCategoryCurrency('RUB')">‚ÇΩ RUB</button>
</div>
<div class="rates-display" id="editCategoryRatesDisplay"></div>
</div>
<div class="form-group">
<label id="editYearlyBudgetLabel">Yƒ±llƒ±k B√ºt√ße ($)</label>
<input type="number" id="editCategoryYearlyBudget" step="0.01" inputmode="decimal">
</div>
<div class="form-group">
<label id="editMonthlyBudgetLabel">Aylƒ±k B√ºt√ßeler ($) <button type="button" class="fill-equal-btn" onclick="fillEqualMonthlyEdit()">E≈üit Daƒüƒ±t</button></label>
<div class="monthly-grid" id="editMonthlyBudgetGrid"></div>
</div>
<div class="form-group">
<label class="toggle-label">
<span>üìÖ G√ºnl√ºk Takip</span>
<small style="display: block; color: var(--text-secondary); font-weight: normal; font-size: 0.8rem; margin-top: 4px;">Yemek, ula≈üƒ±m gibi g√ºnl√ºk harcamalar i√ßin a√ßƒ±n. Kira, fatura gibi tek seferlik √∂demeler i√ßin kapalƒ± bƒ±rakƒ±n.</small>
</label>
<div class="toggle-switch-container" style="display: flex; align-items: center; margin-top: 8px;">
<label class="toggle-switch">
<input type="checkbox" id="editDailyTracking" onchange="updateDailyTrackingStatus()">
<span class="toggle-slider"></span>
</label>
<span id="dailyTrackingStatus" style="margin-left: 12px; font-size: 0.9rem;">Kapalƒ±</span>
</div>
</div>
<button class="submit-btn" onclick="updateCategory()">G√ºncelle</button>
</div>
</div>

<!-- Balance Sheet Modal -->
<div class="modal-overlay" id="balanceModal">
<div class="modal">
<div class="modal-header">
<h2 id="balanceModalTitle">Deƒüer G√ºncelle</h2>
<button class="modal-close" onclick="closeModal('balanceModal')">√ó</button>
</div>
<div class="form-group">
<label>Para Birimi</label>
<div class="currency-toggle" id="balanceCurrencyToggle">
<button type="button" class="currency-btn active" data-currency="USD" onclick="setBalanceCurrency('USD')">$ USD</button>
<button type="button" class="currency-btn" data-currency="TRY" onclick="setBalanceCurrency('TRY')">‚Ç∫ TRY</button>
<button type="button" class="currency-btn" data-currency="RUB" onclick="setBalanceCurrency('RUB')">‚ÇΩ RUB</button>
</div>
<div class="rates-display" id="balanceRatesDisplay"></div>
</div>
<div class="form-group">
<label id="balanceValueLabel">Deƒüer ($)</label>
<input type="number" id="balanceValue" step="0.01" inputmode="decimal" placeholder="0.00">
</div>
<div class="form-group">
<label>A√ßƒ±klama / Not</label>
<textarea id="balanceNote" rows="3" placeholder="Detaylarƒ± buraya yazƒ±n... (√∂rn: Kime bor√ß verdik, hangi banka, vade tarihi vb.)"></textarea>
</div>
<button class="submit-btn" onclick="saveBalanceValue()">Kaydet</button>
</div>
</div>

<!-- Data Management Modal -->
<div class="modal-overlay" id="dataModal">
<div class="modal">
<div class="modal-header">
<h2><i class="fas fa-database"></i> Veri Y√∂netimi</h2>
<button class="modal-close" onclick="closeModal('dataModal')">√ó</button>
</div>
<div class="data-info">
<p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 16px; padding: 12px; background: var(--accent-warning-light); border-radius: 10px; border-left: 4px solid var(--accent-warning);">
‚ö†Ô∏è Uygulama g√ºncellendiƒüinde veriler kaybolabilir. Verilerinizi d√ºzenli olarak dƒ±≈üa aktarƒ±n!
</p>
</div>
<div class="data-stats" style="margin-bottom: 20px;">
<div style="display: flex; gap: 10px; flex-wrap: wrap;">
<span class="rate-chip" id="statCategories">0 kategori</span>
<span class="rate-chip" id="statTransactions">0 i≈ülem</span>
</div>
</div>
<div class="form-group">
<label>Dƒ±≈üa Aktar</label>
<button class="submit-btn" onclick="exportData()" style="background: var(--accent-income); margin-top: 0;">
<i class="fas fa-download"></i> JSON ƒ∞ndir
</button>
</div>
<div class="form-group">
<label>ƒ∞√ße Aktar</label>
<input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
<button class="submit-btn" onclick="document.getElementById('importFile').click()" style="background: var(--accent-main); margin-top: 0;">
<i class="fas fa-upload"></i> JSON Y√ºkle
</button>
</div>
<div class="form-group">
<label>T√ºm Verileri Sil</label>
<button class="submit-btn" onclick="confirmClearAllData()" style="background: var(--accent-expense); margin-top: 0;">
<i class="fas fa-trash"></i> Verileri Temizle
</button>
</div>
</div>
</div>

<!-- Transaction Modal -->
<div class="modal-overlay" id="transactionModal">
<div class="modal">
<div class="modal-header">
<h2>Yeni ƒ∞≈ülem</h2>
<button class="modal-close" onclick="closeModal('transactionModal')">√ó</button>
</div>
<div class="type-toggle">
<button class="type-btn income active" onclick="setTransactionType('income')">
<i class="fas fa-arrow-down"></i> Gelir
</button>
<button class="type-btn expense" onclick="setTransactionType('expense')">
<i class="fas fa-arrow-up"></i> Gider
</button>
</div>
<div class="form-group">
<label>Kategori</label>
<div class="category-select-grid" id="categorySelectGrid"></div>
</div>
<div class="form-group">
<label>Para Birimi</label>
<div class="currency-toggle" id="currencyToggle">
<button class="currency-btn active" data-currency="USD" onclick="selectTransactionCurrency('USD')">$ USD</button>
<button class="currency-btn" data-currency="TRY" onclick="selectTransactionCurrency('TRY')">‚Ç∫ TRY</button>
<button class="currency-btn" data-currency="RUB" onclick="selectTransactionCurrency('RUB')">‚ÇΩ RUB</button>
</div>
<div id="liveRateBox" style="background: var(--accent-main-light); padding: 10px 14px; border-radius: 10px; margin-top: 10px; display: none;">
<div style="display: flex; justify-content: space-between; align-items: center;">
<div>
<span style="font-size: 0.75rem; color: var(--text-secondary);">üì° G√ºncel Kur</span>
<div style="font-weight: 700; color: var(--accent-main); font-size: 1.1rem;" id="liveRateValue">-</div>
</div>
<div style="text-align: right;">
<span style="font-size: 0.75rem; color: var(--text-secondary);">‚âà Dolar Kar≈üƒ±lƒ±ƒüƒ±</span>
<div style="font-weight: 700; color: var(--text-primary); font-size: 1.1rem;" id="liveUsdEquivalent">$0</div>
</div>
</div>
<div style="font-size: 0.65rem; color: var(--text-secondary); margin-top: 6px; text-align: center;" id="liveRateTime"></div>
</div>
<div class="rates-display" id="currentRates"></div>
</div>
<div class="form-group">
<label>Tutar</label>
<input type="number" id="transactionAmount" placeholder="0.00" step="0.01" inputmode="decimal" oninput="updateUsdEquivalent()">
</div>
<div class="form-group">
<label>Not (Opsiyonel)</label>
<input type="text" id="transactionNote" placeholder="A√ßƒ±klama...">
</div>
<div class="form-group">
<label>Tarih</label>
<input type="date" id="transactionDate">
</div>
<button class="submit-btn" onclick="saveTransaction()">Kaydet</button>
</div>
</div>

<!-- Category Modal --><!-- Confirm Modal -->
<div class="confirm-modal" id="confirmModal">
<div class="confirm-box">
<h3>Silmek istediƒüinize emin misiniz?</h3>
<p id="confirmMessage">Bu i≈ülem geri alƒ±namaz.</p>
<div class="confirm-buttons">
<button class="confirm-cancel" onclick="closeConfirm()">ƒ∞ptal</button>
<button class="confirm-delete" id="confirmDeleteBtn">Sil</button>
</div>
</div>
</div>

<script>
// ==================== DARK MODE ====================
if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
document.documentElement.classList.add('dark');
}
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
document.documentElement.classList.toggle('dark', e.matches);
});

// ==================== FIREBASE CONFIG ====================
const firebaseConfig = {
apiKey: "AIzaSyDJFip1yCkZQblCiYXCNJP24CGtPAvIBAo",
authDomain: "butce-e5972.firebaseapp.com",
databaseURL: "https://butce-e5972-default-rtdb.europe-west1.firebasedatabase.app",
projectId: "butce-e5972",
storageBucket: "butce-e5972.firebasestorage.app",
messagingSenderId: "577323366078",
appId: "1:577323366078:web:01eeb397ee6acd378ad0ef"
};

// Firebase'i ba≈ülat
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const dataRef = database.ref('budgetData');

// Sync durumu
let isOnline = true;
let isSyncing = false;
let saveTimeout = null;

// Sync status g√ºncelleme
function updateSyncStatus(status, text) {
const statusEl = document.getElementById('syncStatus');
const textEl = document.getElementById('syncText');
statusEl.className = 'sync-status ' + status;
textEl.textContent = text;
}

// Firebase baƒülantƒ± durumunu izle
database.ref('.info/connected').on('value', (snapshot) => {
isOnline = snapshot.val() === true;
if (isOnline) {
updateSyncStatus('online', 'Senkronize ‚úì');
} else {
updateSyncStatus('offline', '√áevrimdƒ±≈üƒ±');
}
});

// ==================== DATA STORAGE ====================
let dataLoaded = false;

function saveData() {
// Debounce - √ßok sƒ±k kaydetmeyi √∂nle
if (saveTimeout) clearTimeout(saveTimeout);

saveTimeout = setTimeout(() => {
if (!dataLoaded) return; // Veri y√ºklenene kadar kaydetme

isSyncing = true;
updateSyncStatus('syncing', 'Kaydediliyor...');

const data = {
categories,
transactions,
exchangeRates,
monthlyRates,
nextCategoryId,
balanceSheet,
lastUpdated: Date.now()
};

dataRef.set(data)
.then(() => {
isSyncing = false;
updateSyncStatus('online', 'Senkronize ‚úì');
})
.catch((error) => {
console.error('Firebase kayƒ±t hatasƒ±:', error);
isSyncing = false;
updateSyncStatus('offline', 'Kayƒ±t hatasƒ±!');
});
}, 500); // 500ms debounce
}

function loadData() {
// ƒ∞lk y√ºkleme - sadece bir kere √ßalƒ±≈üƒ±r
// Sonraki g√ºncellemeler onValue listener ile gelir
}

// Firebase'den ger√ßek zamanlƒ± veri dinle
function initFirebaseListener() {
updateSyncStatus('syncing', 'Y√ºkleniyor...');

dataRef.on('value', (snapshot) => {
const data = snapshot.val();

if (data) {
categories = data.categories || { income: [], expense: [] };
transactions = data.transactions || [];
exchangeRates = data.exchangeRates || { USD: 1, TRY: 38.50, RUB: 96.00 };

// Aylƒ±k kurlarƒ± y√ºkle
if (data.monthlyRates) {
monthlyRates = data.monthlyRates;
} else if (data.exchangeRates) {
monthlyRates = {
TRY: Array(12).fill(data.exchangeRates.TRY || 38.50),
RUB: Array(12).fill(data.exchangeRates.RUB || 96.00)
};
}

nextCategoryId = data.nextCategoryId || 1;

// Balance Sheet verilerini y√ºkle
if (data.balanceSheet) {
balanceSheet = data.balanceSheet;
}
}

dataLoaded = true;
updateSyncStatus('online', 'Senkronize ‚úì');

// UI'ƒ± g√ºncelle
if (typeof updateAll === 'function') {
updateAll();
}
}, (error) => {
console.error('Firebase okuma hatasƒ±:', error);
updateSyncStatus('offline', 'Baƒülantƒ± hatasƒ±');
dataLoaded = true; // Hata olsa bile devam et
});
}

function getRateForMonth(currency, month) {
if (currency === 'USD') return 1;
return monthlyRates[currency]?.[month] || exchangeRates[currency] || 1;
}

// ==================== APP STATE ====================
let categories = { income: [], expense: [] };
let transactions = [];
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth();
let selectedMonth = 'all';
let viewMode = 'monthly'; // 'monthly' or 'yearly'

// Balance Sheet (Bilan√ßo) verileri - her kalem value ve note i√ßerir
let balanceSheet = {
assets: {
cash: { value: 0, note: '' },
investments: { value: 0, note: '' },
receivables: { value: 0, note: '' }
},
liabilities: {
credits: { value: 0, note: '' },
debitCards: { value: 0, note: '' },
debts: { value: 0, note: '' }
}
};
let currentTransactionType = 'income';
let currentCategoryType = 'income';
let selectedCategoryId = null;
let selectedIcon = 'fa-tag';
let selectedCurrency = 'USD';
let selectedCategoryCurrency = 'USD';
let selectedEditCategoryCurrency = 'USD';
let editingCategoryId = null;
let nextCategoryId = 1;
let deleteCallback = null;
let monthlyChart = null;

// Aylƒ±k kurlar: her ay i√ßin ayrƒ± kur
let monthlyRates = {
TRY: [38.50, 38.50, 38.50, 38.50, 38.50, 38.50, 38.50, 38.50, 38.50, 38.50, 38.50, 38.50],
RUB: [96.00, 96.00, 96.00, 96.00, 96.00, 96.00, 96.00, 96.00, 96.00, 96.00, 96.00, 96.00]
};

// Geriye uyumluluk i√ßin eski format desteƒüi
let exchangeRates = { USD: 1, TRY: 38.50, RUB: 96.00 };
const currencySymbols = { USD: '$', TRY: '‚Ç∫', RUB: '‚ÇΩ' };
const monthNames = ['Oca', '≈ûub', 'Mar', 'Nis', 'May', 'Haz', 'Tem', 'Aƒüu', 'Eyl', 'Eki', 'Kas', 'Ara'];
const monthNamesFull = ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran', 'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'];
const icons = [
'fa-briefcase', 'fa-laptop', 'fa-chart-line', 'fa-money-bill',
'fa-shopping-cart', 'fa-file-invoice', 'fa-car', 'fa-utensils',
'fa-film', 'fa-heartbeat', 'fa-home', 'fa-graduation-cap',
'fa-plane', 'fa-gift', 'fa-music', 'fa-book',
'fa-gamepad', 'fa-coffee', 'fa-tshirt', 'fa-mobile',
'fa-bolt', 'fa-wifi', 'fa-dumbbell', 'fa-dog',
'fa-baby', 'fa-tools', 'fa-paint-brush', 'fa-camera',
'fa-piggy-bank', 'fa-coins'
];

// ==================== VIEW TOGGLE ====================
document.querySelectorAll('.view-btn').forEach(btn => {
btn.addEventListener('click', () => {
document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
btn.classList.add('active');
viewMode = btn.dataset.view;
document.getElementById('monthSelector').style.display = viewMode === 'monthly' ? 'flex' : 'none';
updateAll();
});
});

function changeMonth(delta) {
currentMonth += delta;
if (currentMonth < 0) { currentMonth = 11; currentYear--; }
if (currentMonth > 11) { currentMonth = 0; currentYear++; }
document.getElementById('yearDisplay').textContent = currentYear;
document.getElementById('monthDisplay').textContent = monthNamesFull[currentMonth];
updateAll();
}

// ==================== TABS ====================
document.querySelectorAll('.tab').forEach(tab => {
tab.addEventListener('click', () => {
document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
tab.classList.add('active');
document.getElementById(`${tab.dataset.tab}-section`).classList.add('active');
});
});

// ==================== HELPERS ====================
function formatCurrency(amount, currency = 'USD') {
const symbol = currencySymbols[currency] || '$';
return symbol + Math.abs(amount).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function changeYear(delta) {
currentYear += delta;
document.getElementById('yearDisplay').textContent = currentYear;
updateAll();
}

function getYearTransactions() {
return transactions.filter(t => new Date(t.date).getFullYear() === currentYear);
}

// ==================== SUMMARY ====================
function getCategoryYearlyPlan(cat, year = currentYear) {
// Yƒ±l bazƒ±nda b√ºt√ße kontrol√º
const yearBudget = cat.budgets && cat.budgets[year];
if (yearBudget) {
// Bu yƒ±l i√ßin b√ºt√ße objesi var
if (yearBudget.monthlyBudgets && Array.isArray(yearBudget.monthlyBudgets) && yearBudget.monthlyBudgets.length > 0) {
const sum = yearBudget.monthlyBudgets.reduce((a, b) => a + (b || 0), 0);
if (sum > 0) return sum;
}
if (typeof yearBudget.yearlyBudget === 'number' && yearBudget.yearlyBudget > 0) {
return yearBudget.yearlyBudget;
}
// Yeni formatta deƒüerler 0 ise, eski formata BAK (ge√ßi≈ü d√∂nemi desteƒüi)
}
// Eski format desteƒüi (geriye uyumluluk) - array uzunluƒüu ne olursa olsun topla
if (cat.monthlyBudgets && Array.isArray(cat.monthlyBudgets) && cat.monthlyBudgets.length > 0) {
const sum = cat.monthlyBudgets.reduce((a, b) => a + (b || 0), 0);
if (sum > 0) return sum;
}
if (cat.yearlyBudget) return cat.yearlyBudget;
return 0;
}

function getCategoryMonthlyPlan(cat, month, year = currentYear) {
// Yƒ±l bazƒ±nda b√ºt√ße kontrol√º
const yearBudget = cat.budgets && cat.budgets[year];
if (yearBudget) {
// Bu yƒ±l i√ßin b√ºt√ße objesi var
if (yearBudget.monthlyBudgets && Array.isArray(yearBudget.monthlyBudgets) && yearBudget.monthlyBudgets.length > 0) {
const sum = yearBudget.monthlyBudgets.reduce((a, b) => a + (b || 0), 0);
if (sum > 0) return yearBudget.monthlyBudgets[month] || 0;
}
if (typeof yearBudget.yearlyBudget === 'number' && yearBudget.yearlyBudget > 0) {
return yearBudget.yearlyBudget / 12;
}
// Yeni formatta deƒüerler 0 ise, eski formata BAK (ge√ßi≈ü d√∂nemi desteƒüi)
}
// Eski format desteƒüi (geriye uyumluluk) - array uzunluƒüu ne olursa olsun kullan
if (cat.monthlyBudgets && Array.isArray(cat.monthlyBudgets) && cat.monthlyBudgets.length > 0) {
const sum = cat.monthlyBudgets.reduce((a, b) => a + (b || 0), 0);
if (sum > 0) return cat.monthlyBudgets[month] || 0;
}
if (cat.yearlyBudget) return cat.yearlyBudget / 12;
return 0;
}

function getCategoryBudgetCurrency(cat, year = currentYear) {
// Yƒ±l bazƒ±nda b√ºt√ße para birimi
const yearBudget = cat.budgets && cat.budgets[year];
if (yearBudget && yearBudget.budgetCurrency) {
return yearBudget.budgetCurrency;
}
// Eski format desteƒüi
return cat.budgetCurrency || 'USD';
}

function updateSummary() {
const yearTx = getYearTransactions();

let planIncome, planExpense, factIncome, factExpense;
let avgTryRate, avgRubRate;
let txList;

if (viewMode === 'monthly') {
// Aylƒ±k modda
txList = yearTx.filter(t => new Date(t.date).getMonth() === currentMonth);

planIncome = categories.income.reduce((sum, c) => sum + getCategoryMonthlyPlan(c, currentMonth), 0);
planExpense = categories.expense.reduce((sum, c) => sum + getCategoryMonthlyPlan(c, currentMonth), 0);
factIncome = txList.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amountUSD, 0);
factExpense = txList.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amountUSD, 0);

// Aylƒ±k kur
avgTryRate = getRateForMonth('TRY', currentMonth);
avgRubRate = getRateForMonth('RUB', currentMonth);

document.getElementById('incomeLabel').textContent = 'Aylƒ±k Gelir Planƒ±';
document.getElementById('expenseLabel').textContent = 'Aylƒ±k Gider Planƒ±';
} else {
// Yƒ±llƒ±k modda
txList = yearTx;
planIncome = categories.income.reduce((sum, c) => sum + getCategoryYearlyPlan(c), 0);
planExpense = categories.expense.reduce((sum, c) => sum + getCategoryYearlyPlan(c), 0);
factIncome = yearTx.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amountUSD, 0);
factExpense = yearTx.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amountUSD, 0);

// Yƒ±llƒ±k ortalama kur
avgTryRate = monthlyRates.TRY.reduce((a, b) => a + b, 0) / 12;
avgRubRate = monthlyRates.RUB.reduce((a, b) => a + b, 0) / 12;

document.getElementById('incomeLabel').textContent = 'Yƒ±llƒ±k Gelir Planƒ±';
document.getElementById('expenseLabel').textContent = 'Yƒ±llƒ±k Gider Planƒ±';
}

const net = factIncome - factExpense;

// USD values
document.getElementById('planIncome').textContent = formatCurrency(planIncome);
document.getElementById('factIncome').textContent = `Ger√ßekle≈üen: ${formatCurrency(factIncome)}`;
document.getElementById('planExpense').textContent = formatCurrency(planExpense);
document.getElementById('factExpense').textContent = `Ger√ßekle≈üen: ${formatCurrency(factExpense)}`;

// TRY ve RUB values
document.getElementById('planIncomeSub').textContent = `${formatCurrency(planIncome * avgTryRate, 'TRY')} / ${formatCurrency(planIncome * avgRubRate, 'RUB')}`;
document.getElementById('factIncomeSub').textContent = `${formatCurrency(factIncome * avgTryRate, 'TRY')} / ${formatCurrency(factIncome * avgRubRate, 'RUB')}`;
document.getElementById('planExpenseSub').textContent = `${formatCurrency(planExpense * avgTryRate, 'TRY')} / ${formatCurrency(planExpense * avgRubRate, 'RUB')}`;
document.getElementById('factExpenseSub').textContent = `${formatCurrency(factExpense * avgTryRate, 'TRY')} / ${formatCurrency(factExpense * avgRubRate, 'RUB')}`;

const netEl = document.getElementById('netBalance');
netEl.textContent = (net >= 0 ? '+' : '-') + formatCurrency(Math.abs(net));
netEl.className = 'amount ' + (net >= 0 ? 'positive' : 'negative');

document.getElementById('netBalanceSub').textContent = `${net >= 0 ? '+' : '-'}${formatCurrency(Math.abs(net) * avgTryRate, 'TRY')} / ${net >= 0 ? '+' : '-'}${formatCurrency(Math.abs(net) * avgRubRate, 'RUB')}`;

// Income progress bar
const incomePercent = planIncome > 0 ? (factIncome / planIncome) * 100 : 0;
const incomeBar = document.getElementById('incomeBar');
incomeBar.style.width = Math.min(incomePercent, 100) + '%';
incomeBar.className = 'plan-fact-fill ' + (incomePercent >= 100 ? 'under' : incomePercent > 50 ? 'warning' : 'over');

// Expense progress bar
const expensePercent = planExpense > 0 ? (factExpense / planExpense) * 100 : 0;
const expenseBar = document.getElementById('expenseBar');
expenseBar.style.width = Math.min(expensePercent, 100) + '%';
expenseBar.className = 'plan-fact-fill ' + (expensePercent > 100 ? 'over' : expensePercent > 80 ? 'warning' : 'under');

// B√ºt√ße √ñzeti - Para Birimi Bazƒ±nda
updateCurrencySummary(txList, avgTryRate, avgRubRate);

// Cash Flow g√ºncelle
updateCashFlow();

// Update chart
updateChart();
}

function updateCurrencySummary(txList, tryRate, rubRate) {
const container = document.getElementById('currencySummaryGrid');
const isMonthly = viewMode === 'monthly';

// Her para biriminde orijinal tutarlarƒ± hesapla (i≈ülemler)
const byCurrency = { USD: { income: 0, expense: 0 }, TRY: { income: 0, expense: 0 }, RUB: { income: 0, expense: 0 } };

txList.forEach(t => {
if (byCurrency[t.currency]) {
byCurrency[t.currency][t.type] += t.amount;
}
});

// B√ºt√ße planlarƒ± (USD cinsinden, sonra √ßevrilecek)
const planIncomeUSD = isMonthly
? categories.income.reduce((sum, c) => sum + getCategoryMonthlyPlan(c, currentMonth), 0)
: categories.income.reduce((sum, c) => sum + getCategoryYearlyPlan(c), 0);
const planExpenseUSD = isMonthly
? categories.expense.reduce((sum, c) => sum + getCategoryMonthlyPlan(c, currentMonth), 0)
: categories.expense.reduce((sum, c) => sum + getCategoryYearlyPlan(c), 0);

// Toplam ger√ßekle≈üen (USD cinsinden)
const factIncomeUSD = txList.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amountUSD, 0);
const factExpenseUSD = txList.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amountUSD, 0);

container.innerHTML = `
<div class="currency-card usd">
<div class="currency-symbol">$</div>
<div class="currency-label">Dolar (USD)</div>
<div class="currency-row" style="color: var(--text-secondary);">
<span>Plan G:</span>
<span>$${planIncomeUSD.toFixed(0)}</span>
</div>
<div class="currency-row income">
<span>Ger√ß. G:</span>
<span>$${factIncomeUSD.toFixed(0)}</span>
</div>
<div class="currency-row" style="color: var(--text-secondary);">
<span>Plan Gd:</span>
<span>$${planExpenseUSD.toFixed(0)}</span>
</div>
<div class="currency-row expense">
<span>Ger√ß. Gd:</span>
<span>$${factExpenseUSD.toFixed(0)}</span>
</div>
<div class="currency-row net ${(factIncomeUSD - factExpenseUSD) >= 0 ? 'positive' : 'negative'}">
<span>Net:</span>
<span>${(factIncomeUSD - factExpenseUSD) >= 0 ? '+' : ''}$${(factIncomeUSD - factExpenseUSD).toFixed(0)}</span>
</div>
</div>
<div class="currency-card try">
<div class="currency-symbol">‚Ç∫</div>
<div class="currency-label">T√ºrk Lirasƒ± (TRY)</div>
<div class="currency-row" style="color: var(--text-secondary);">
<span>Plan G:</span>
<span>‚Ç∫${(planIncomeUSD * tryRate).toFixed(0)}</span>
</div>
<div class="currency-row income">
<span>Ger√ß. G:</span>
<span>‚Ç∫${(factIncomeUSD * tryRate).toFixed(0)}</span>
</div>
<div class="currency-row" style="color: var(--text-secondary);">
<span>Plan Gd:</span>
<span>‚Ç∫${(planExpenseUSD * tryRate).toFixed(0)}</span>
</div>
<div class="currency-row expense">
<span>Ger√ß. Gd:</span>
<span>‚Ç∫${(factExpenseUSD * tryRate).toFixed(0)}</span>
</div>
<div class="currency-row net ${(factIncomeUSD - factExpenseUSD) >= 0 ? 'positive' : 'negative'}">
<span>Net:</span>
<span>${(factIncomeUSD - factExpenseUSD) >= 0 ? '+' : ''}‚Ç∫${((factIncomeUSD - factExpenseUSD) * tryRate).toFixed(0)}</span>
</div>
</div>
<div class="currency-card rub">
<div class="currency-symbol">‚ÇΩ</div>
<div class="currency-label">Ruble (RUB)</div>
<div class="currency-row" style="color: var(--text-secondary);">
<span>Plan G:</span>
<span>‚ÇΩ${(planIncomeUSD * rubRate).toFixed(0)}</span>
</div>
<div class="currency-row income">
<span>Ger√ß. G:</span>
<span>‚ÇΩ${(factIncomeUSD * rubRate).toFixed(0)}</span>
</div>
<div class="currency-row" style="color: var(--text-secondary);">
<span>Plan Gd:</span>
<span>‚ÇΩ${(planExpenseUSD * rubRate).toFixed(0)}</span>
</div>
<div class="currency-row expense">
<span>Ger√ß. Gd:</span>
<span>‚ÇΩ${(factExpenseUSD * rubRate).toFixed(0)}</span>
</div>
<div class="currency-row net ${(factIncomeUSD - factExpenseUSD) >= 0 ? 'positive' : 'negative'}">
<span>Net:</span>
<span>${(factIncomeUSD - factExpenseUSD) >= 0 ? '+' : ''}‚ÇΩ${((factIncomeUSD - factExpenseUSD) * rubRate).toFixed(0)}</span>
</div>
</div>
`;
}

function updateCashFlow() {
const yearTx = getYearTransactions();
const tbody = document.getElementById('cashflowBody');
const tfoot = document.getElementById('cashflowFoot');
const summary = document.getElementById('cashflowSummary');

const today = new Date();
const thisMonth = today.getMonth();

let rows = '';
let totalIncomePlan = 0, totalIncomeActual = 0;
let totalExpensePlan = 0, totalExpenseActual = 0;
let cumulativePlan = 0, cumulativeActual = 0;

// Her ay i√ßin hesapla
for (let i = 0; i < 12; i++) {
const monthTx = yearTx.filter(t => new Date(t.date).getMonth() === i);

const incomePlan = categories.income.reduce((sum, c) => sum + getCategoryMonthlyPlan(c, i), 0);
const incomeActual = monthTx.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amountUSD, 0);

const expensePlan = categories.expense.reduce((sum, c) => sum + getCategoryMonthlyPlan(c, i), 0);
const expenseActual = monthTx.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amountUSD, 0);

const netPlan = incomePlan - expensePlan;
const netActual = incomeActual - expenseActual;

cumulativePlan += netPlan;
cumulativeActual += netActual;

totalIncomePlan += incomePlan;
totalIncomeActual += incomeActual;
totalExpensePlan += expensePlan;
totalExpenseActual += expenseActual;

const isCurrentMonth = (today.getFullYear() === currentYear && i === thisMonth);
const isFutureMonth = (today.getFullYear() === currentYear && i > thisMonth) || (today.getFullYear() < currentYear);

rows += `
<tr class="${isCurrentMonth ? 'current-month' : ''}">
<td>${monthNames[i]}</td>
<td>$${incomePlan.toFixed(0)}</td>
<td class="${incomeActual > 0 ? 'positive' : ''}">${isFutureMonth && incomeActual === 0 ? '-' : '$' + incomeActual.toFixed(0)}</td>
<td>$${expensePlan.toFixed(0)}</td>
<td class="${expenseActual > 0 ? 'negative' : ''}">${isFutureMonth && expenseActual === 0 ? '-' : '$' + expenseActual.toFixed(0)}</td>
<td class="${netPlan >= 0 ? 'positive' : 'negative'}">${netPlan >= 0 ? '+' : ''}$${netPlan.toFixed(0)}</td>
<td class="${netActual >= 0 ? 'positive' : 'negative'}">${isFutureMonth && incomeActual === 0 && expenseActual === 0 ? '-' : (netActual >= 0 ? '+' : '') + '$' + netActual.toFixed(0)}</td>
<td class="${cumulativeActual >= 0 ? 'positive' : 'negative'}">${isFutureMonth && incomeActual === 0 && expenseActual === 0 ? '($' + cumulativePlan.toFixed(0) + ')' : (cumulativeActual >= 0 ? '+' : '') + '$' + cumulativeActual.toFixed(0)}</td>
</tr>
`;
}

tbody.innerHTML = rows;

// Toplam satƒ±rƒ± - getCategoryYearlyPlan kullanarak √∂zet kartlarƒ±yla tutarlƒ± hesaplama
const yearlyIncomePlan = categories.income.reduce((sum, c) => sum + getCategoryYearlyPlan(c), 0);
const yearlyExpensePlan = categories.expense.reduce((sum, c) => sum + getCategoryYearlyPlan(c), 0);
const yearlyNetPlan = yearlyIncomePlan - yearlyExpensePlan;
const totalNetActual = totalIncomeActual - totalExpenseActual;

tfoot.innerHTML = `
<tr>
<td>TOPLAM</td>
<td>$${yearlyIncomePlan.toFixed(0)}</td>
<td class="positive">$${totalIncomeActual.toFixed(0)}</td>
<td>$${yearlyExpensePlan.toFixed(0)}</td>
<td class="negative">$${totalExpenseActual.toFixed(0)}</td>
<td class="${yearlyNetPlan >= 0 ? 'positive' : 'negative'}">${yearlyNetPlan >= 0 ? '+' : ''}$${yearlyNetPlan.toFixed(0)}</td>
<td class="${totalNetActual >= 0 ? 'positive' : 'negative'}">${totalNetActual >= 0 ? '+' : ''}$${totalNetActual.toFixed(0)}</td>
<td class="${totalNetActual >= 0 ? 'positive' : 'negative'}">${totalNetActual >= 0 ? '+' : ''}$${totalNetActual.toFixed(0)}</td>
</tr>
`;

// TRY ve RUB i√ßin ortalama kur
const avgTryRate = monthlyRates.TRY.reduce((a, b) => a + b, 0) / 12;
const avgRubRate = monthlyRates.RUB.reduce((a, b) => a + b, 0) / 12;

// Tasarruf √∂zeti - yƒ±llƒ±k plan deƒüerlerini kullan (√∂zet kartlarƒ±yla tutarlƒ±)
const yearlySavingsPlan = yearlyNetPlan;
const yearlySavingsActual = totalNetActual;
const monthlySavingsPlan = yearlySavingsPlan / 12;
const remainingMonths = 12 - thisMonth - 1;
const projectedSavings = totalNetActual + (remainingMonths * monthlySavingsPlan);

summary.innerHTML = `
<div class="cashflow-card savings">
<div class="cashflow-card-title">üìà Yƒ±llƒ±k Tasarruf Planƒ±</div>
<div class="cashflow-card-value">${yearlySavingsPlan >= 0 ? '+' : ''}$${yearlySavingsPlan.toFixed(0)}</div>
<div class="cashflow-card-sub">‚Ç∫${(yearlySavingsPlan * avgTryRate).toFixed(0)} / ‚ÇΩ${(yearlySavingsPlan * avgRubRate).toFixed(0)}</div>
</div>
<div class="cashflow-card ${yearlySavingsActual >= 0 ? 'savings' : 'spending'}">
<div class="cashflow-card-title">üí∞ Ger√ßekle≈üen Tasarruf</div>
<div class="cashflow-card-value">${yearlySavingsActual >= 0 ? '+' : ''}$${yearlySavingsActual.toFixed(0)}</div>
<div class="cashflow-card-sub">‚Ç∫${(yearlySavingsActual * avgTryRate).toFixed(0)} / ‚ÇΩ${(yearlySavingsActual * avgRubRate).toFixed(0)}</div>
</div>
<div class="cashflow-card savings">
<div class="cashflow-card-title">üéØ Aylƒ±k Tasarruf Hedefi</div>
<div class="cashflow-card-value">${monthlySavingsPlan >= 0 ? '+' : ''}$${monthlySavingsPlan.toFixed(0)}</div>
<div class="cashflow-card-sub">‚Ç∫${(monthlySavingsPlan * avgTryRate).toFixed(0)} / ‚ÇΩ${(monthlySavingsPlan * avgRubRate).toFixed(0)}</div>
</div>
<div class="cashflow-card ${projectedSavings >= 0 ? 'savings' : 'spending'}">
<div class="cashflow-card-title">üîÆ Yƒ±l Sonu Tahmini</div>
<div class="cashflow-card-value">${projectedSavings >= 0 ? '+' : ''}$${projectedSavings.toFixed(0)}</div>
<div class="cashflow-card-sub">‚Ç∫${(projectedSavings * avgTryRate).toFixed(0)} / ‚ÇΩ${(projectedSavings * avgRubRate).toFixed(0)}</div>
</div>
`;
}

function updateChart() {
const ctx = document.getElementById('monthlyChart').getContext('2d');
const yearTx = getYearTransactions();

// Prepare data for each month
const incomeData = [];
const expenseData = [];
const incomePlanData = [];
const expensePlanData = [];

for (let i = 0; i < 12; i++) {
const monthTx = yearTx.filter(t => new Date(t.date).getMonth() === i);

incomeData.push(monthTx.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amountUSD, 0));
expenseData.push(monthTx.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amountUSD, 0));
incomePlanData.push(categories.income.reduce((sum, c) => sum + getCategoryMonthlyPlan(c, i), 0));
expensePlanData.push(categories.expense.reduce((sum, c) => sum + getCategoryMonthlyPlan(c, i), 0));
}

// Destroy existing chart if any
if (monthlyChart) {
monthlyChart.destroy();
}

// Chart title based on view mode
const chartTitle = document.querySelector('.chart-title');
chartTitle.textContent = viewMode === 'monthly' ?
`${monthNamesFull[currentMonth]} - Kategori Daƒüƒ±lƒ±mƒ±` :
'Aylƒ±k B√ºt√ße vs Ger√ßekle≈üen';

const isDark = document.documentElement.classList.contains('dark');
const textColor = isDark ? '#a0aec0' : '#636e72';
const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';

if (viewMode === 'yearly') {
// Bar chart for yearly view - showing monthly breakdown
monthlyChart = new Chart(ctx, {
type: 'bar',
data: {
labels: monthNames,
datasets: [
{
label: 'Gelir Planƒ±',
data: incomePlanData,
backgroundColor: 'rgba(0, 184, 148, 0.3)',
borderColor: '#00b894',
borderWidth: 2,
borderRadius: 4,
order: 2
},
{
label: 'Gelir Ger√ßekle≈üen',
data: incomeData,
backgroundColor: '#00b894',
borderColor: '#00b894',
borderWidth: 0,
borderRadius: 4,
order: 1
},
{
label: 'Gider Planƒ±',
data: expensePlanData,
backgroundColor: 'rgba(225, 112, 85, 0.3)',
borderColor: '#e17055',
borderWidth: 2,
borderRadius: 4,
order: 4
},
{
label: 'Gider Ger√ßekle≈üen',
data: expenseData,
backgroundColor: '#e17055',
borderColor: '#e17055',
borderWidth: 0,
borderRadius: 4,
order: 3
}
]
},
options: {
responsive: true,
maintainAspectRatio: true,
plugins: {
legend: {
position: 'bottom',
labels: {
color: textColor,
font: { size: 10, family: 'Nunito' },
boxWidth: 12,
padding: 8
}
}
},
scales: {
x: {
grid: { display: false },
ticks: { color: textColor, font: { size: 10 } }
},
y: {
grid: { color: gridColor },
ticks: {
color: textColor,
font: { size: 10 },
callback: (v) => '$' + v.toLocaleString()
}
}
}
}
});
} else {
// Doughnut chart for monthly view - showing category breakdown
const monthTx = yearTx.filter(t => new Date(t.date).getMonth() === currentMonth);

const expenseByCategory = [];
const categoryLabels = [];
const categoryColors = [
'#e17055', '#ff7675', '#fd79a8', '#fdcb6e', '#ffeaa7',
'#55efc4', '#00b894', '#74b9ff', '#0984e3', '#a29bfe',
'#6c5ce7', '#b2bec3'
];

categories.expense.forEach((cat, index) => {
const amount = monthTx.filter(t => t.categoryId === cat.id).reduce((sum, t) => sum + t.amountUSD, 0);
if (amount > 0) {
expenseByCategory.push(amount);
categoryLabels.push(cat.name);
}
});

if (expenseByCategory.length === 0) {
expenseByCategory.push(1);
categoryLabels.push('Veri yok');
}

const totalExpense = expenseByCategory.reduce((a, b) => a + b, 0);
const tryRate = getRateForMonth('TRY', currentMonth);

monthlyChart = new Chart(ctx, {
type: 'doughnut',
data: {
labels: categoryLabels,
datasets: [{
data: expenseByCategory,
backgroundColor: categoryColors.slice(0, expenseByCategory.length),
borderWidth: 0,
hoverOffset: 4
}]
},
options: {
responsive: true,
maintainAspectRatio: true,
cutout: '60%',
plugins: {
legend: {
position: 'right',
labels: {
color: textColor,
font: { size: 10, family: 'Nunito' },
boxWidth: 12,
padding: 6,
generateLabels: function(chart) {
const data = chart.data;
if (data.labels.length && data.datasets.length) {
return data.labels.map((label, i) => {
const value = data.datasets[0].data[i];
const percent = totalExpense > 0 ? ((value / totalExpense) * 100).toFixed(0) : 0;
return {
text: `${label} (${percent}%)`,
fillStyle: data.datasets[0].backgroundColor[i],
hidden: false,
index: i
};
});
}
return [];
}
}
},
tooltip: {
callbacks: {
label: function(context) {
const value = context.parsed;
const percent = totalExpense > 0 ? ((value / totalExpense) * 100).toFixed(1) : 0;
const tryValue = value * tryRate;
return `$${value.toFixed(2)} (‚Ç∫${tryValue.toFixed(0)}) - %${percent}`;
}
}
}
}
}
});
}
}

// ==================== BUDGETS ====================
function renderBudgets() {
const yearTx = getYearTransactions();
const isMonthly = viewMode === 'monthly';

['income', 'expense'].forEach(type => {
const container = document.getElementById(`${type}Budgets`);
const cats = categories[type];

if (cats.length === 0) {
container.innerHTML = `
<div class="empty-state">
<i class="fas fa-folder-plus"></i>
<p>${type === 'income' ? 'Gelir' : 'Gider'} kalemi ekleyin</p>
</div>
`;
return;
}

// TRY kuru (aylƒ±k veya yƒ±llƒ±k ortalama)
const tryRate = isMonthly
? getRateForMonth('TRY', currentMonth)
: monthlyRates.TRY.reduce((a, b) => a + b, 0) / 12;

// RUB kuru (aylƒ±k veya yƒ±llƒ±k ortalama)
const rubRate = isMonthly
? getRateForMonth('RUB', currentMonth)
: monthlyRates.RUB.reduce((a, b) => a + b, 0) / 12;

container.innerHTML = cats.map(cat => {
// Plan deƒüeri (aylƒ±k veya yƒ±llƒ±k)
const plan = isMonthly
? getCategoryMonthlyPlan(cat, currentMonth)
: getCategoryYearlyPlan(cat);

// ƒ∞≈ülemler (aylƒ±k veya yƒ±llƒ±k)
const txList = isMonthly
? yearTx.filter(t => t.categoryId === cat.id && new Date(t.date).getMonth() === currentMonth)
: yearTx.filter(t => t.categoryId === cat.id);

const fact = txList.reduce((sum, t) => sum + t.amountUSD, 0);
const diff = type === 'income' ? fact - plan : plan - fact;
const percent = plan > 0 ? (fact / plan) * 100 : 0;

// Orijinal para birimlerinde ger√ßekle≈üen tutarlar
const factByCurrency = { USD: 0, TRY: 0, RUB: 0 };
txList.forEach(t => {
if (factByCurrency[t.currency] !== undefined) {
factByCurrency[t.currency] += t.amount;
}
});

// Orijinal para birimi g√∂sterimi (Ger√ßekle≈üen)
let originalCurrencyHtml = '';
const parts = [];
if (factByCurrency.USD > 0) parts.push(`$${factByCurrency.USD.toFixed(0)}`);
if (factByCurrency.TRY > 0) parts.push(`‚Ç∫${factByCurrency.TRY.toFixed(0)}`);
if (factByCurrency.RUB > 0) parts.push(`‚ÇΩ${factByCurrency.RUB.toFixed(0)}`);
if (parts.length > 0) {
originalCurrencyHtml = `<div class="original-currency">üìå ${parts.join(' + ')}</div>`;
}

// Plan i√ßin orijinal para birimi g√∂sterimi
let planOriginalHtml = '';
const budgetCurrency = getCategoryBudgetCurrency(cat, currentYear);
if (budgetCurrency && budgetCurrency !== 'USD' && plan > 0) {
// B√ºt√ße orijinal para birimindeyse, o para biriminde g√∂ster
// Her ayƒ±n planƒ±nƒ± o ayƒ±n kuruyla √ßevirip topla (tutarlƒ±lƒ±k i√ßin)
let planInOriginal;
if (isMonthly) {
planInOriginal = plan * getRateForMonth(budgetCurrency, currentMonth);
} else {
// Yƒ±llƒ±k i√ßin: her ayƒ±n planƒ±nƒ± o ayƒ±n kuruyla √ßevir ve topla
planInOriginal = 0;
for (let i = 0; i < 12; i++) {
const monthPlan = getCategoryMonthlyPlan(cat, i);
const monthRate = getRateForMonth(budgetCurrency, i);
planInOriginal += monthPlan * monthRate;
}
}
const symbol = currencySymbols[budgetCurrency];
planOriginalHtml = `<div class="original-currency">üìå ${symbol}${planInOriginal.toFixed(0)}</div>`;
}

let barClass = type === 'expense'
? (percent > 100 ? 'over' : percent > 80 ? 'warning' : 'under')
: (percent >= 100 ? 'under' : percent > 50 ? 'warning' : 'over');

const planLabel = isMonthly ? 'Aylƒ±k Plan' : 'Yƒ±llƒ±k Plan';
const subtitle = `${txList.length} i≈ülem`;

// G√ºnl√ºk limit hesaplama (sadece aylƒ±k g√∂r√ºn√ºm, gider ve g√ºnl√ºk takip a√ßƒ±k olanlar i√ßin)
let dailySection = '';
if (isMonthly && type === 'expense' && plan > 0 && cat.dailyTracking) {
const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
const today = new Date();
const currentDay = (today.getFullYear() === currentYear && today.getMonth() === currentMonth)
? today.getDate()
: daysInMonth;

// Orijinal para biriminde plan hesapla
const planOriginal = plan * getRateForMonth(budgetCurrency, currentMonth);
const dailyLimitOriginal = planOriginal / daysInMonth;

const dailyLimit = plan / daysInMonth;
const dailyLimitTRY = dailyLimit * tryRate;
const dailyLimitRUB = dailyLimit * rubRate;

// Bug√ºne kadar olmasƒ± gereken toplam harcama
const expectedSpent = dailyLimit * currentDay;

// G√ºnl√ºk ortalama harcama
const dailyAvgSpent = currentDay > 0 ? fact / currentDay : 0;
const dailyAvgSpentTRY = dailyAvgSpent * tryRate;
const dailyAvgSpentRUB = dailyAvgSpent * rubRate;
const dailyAvgSpentOriginal = dailyAvgSpent * getRateForMonth(budgetCurrency, currentMonth);

// Durum: g√ºnl√ºk ortalama, g√ºnl√ºk limitin altƒ±nda mƒ±?
const dailyStatus = dailyAvgSpent <= dailyLimit ? 'positive' : 'negative';
const dailyDiff = dailyLimit - dailyAvgSpent;
const dailyDiffOriginal = dailyLimitOriginal - dailyAvgSpentOriginal;

// Orijinal para birimine g√∂re g√∂sterim formatƒ±
let dailyLimitDisplay, dailyAvgDisplay, dailyDiffDisplay;
const origSymbol = currencySymbols[budgetCurrency] || '$';

if (budgetCurrency === 'TRY') {
dailyLimitDisplay = `${origSymbol}${dailyLimitOriginal.toFixed(0)} <small>(${formatCurrency(dailyLimit)} / ${formatCurrency(dailyLimitRUB, 'RUB')})</small>`;
dailyAvgDisplay = `${origSymbol}${dailyAvgSpentOriginal.toFixed(0)} <small>(${formatCurrency(dailyAvgSpent)} / ${formatCurrency(dailyAvgSpentRUB, 'RUB')})</small>`;
dailyDiffDisplay = `${dailyDiffOriginal >= 0 ? '+' : ''}${origSymbol}${dailyDiffOriginal.toFixed(0)} <small>(${dailyDiff >= 0 ? '+' : ''}${formatCurrency(dailyDiff)} / ${dailyDiff >= 0 ? '+' : ''}${formatCurrency(dailyDiff * rubRate, 'RUB')})</small>`;
} else if (budgetCurrency === 'RUB') {
dailyLimitDisplay = `${origSymbol}${dailyLimitOriginal.toFixed(0)} <small>(${formatCurrency(dailyLimit)} / ${formatCurrency(dailyLimitTRY, 'TRY')})</small>`;
dailyAvgDisplay = `${origSymbol}${dailyAvgSpentOriginal.toFixed(0)} <small>(${formatCurrency(dailyAvgSpent)} / ${formatCurrency(dailyAvgSpentTRY, 'TRY')})</small>`;
dailyDiffDisplay = `${dailyDiffOriginal >= 0 ? '+' : ''}${origSymbol}${dailyDiffOriginal.toFixed(0)} <small>(${dailyDiff >= 0 ? '+' : ''}${formatCurrency(dailyDiff)} / ${dailyDiff >= 0 ? '+' : ''}${formatCurrency(dailyDiff * tryRate, 'TRY')})</small>`;
} else {
// USD - mevcut format
dailyLimitDisplay = `${formatCurrency(dailyLimit)} <small>(${formatCurrency(dailyLimitTRY, 'TRY')} / ${formatCurrency(dailyLimitRUB, 'RUB')})</small>`;
dailyAvgDisplay = `${formatCurrency(dailyAvgSpent)} <small>(${formatCurrency(dailyAvgSpentTRY, 'TRY')} / ${formatCurrency(dailyAvgSpentRUB, 'RUB')})</small>`;
dailyDiffDisplay = `${dailyDiff >= 0 ? '+' : ''}${formatCurrency(dailyDiff)} <small>(${dailyDiff >= 0 ? '+' : ''}${formatCurrency(dailyDiff * tryRate, 'TRY')} / ${dailyDiff >= 0 ? '+' : ''}${formatCurrency(dailyDiff * rubRate, 'RUB')})</small>`;
}

dailySection = `
<div class="daily-budget-info">
<div class="daily-item">
<span class="daily-label">üìÖ G√ºnl√ºk Limit:</span>
<span class="daily-value">${dailyLimitDisplay}</span>
</div>
<div class="daily-item">
<span class="daily-label">üìä G√ºnl√ºk Ortalama:</span>
<span class="daily-value ${dailyStatus}">${dailyAvgDisplay}</span>
</div>
<div class="daily-item">
<span class="daily-label">üìà G√ºnl√ºk Fark:</span>
<span class="daily-value ${dailyStatus}">${dailyDiffDisplay}</span>
</div>
</div>
`;
}

return `
<div class="budget-item">
<div class="budget-header">
<div class="budget-left">
<div class="budget-icon ${type}">
<i class="fas ${cat.icon}"></i>
</div>
<div class="budget-info">
<h3>${cat.name}</h3>
<span>${subtitle}</span>
</div>
</div>
<div class="budget-actions">
<button class="action-btn edit" onclick="openEditBudgetModal(${cat.id})">
<i class="fas fa-pen"></i>
</button>
<button class="action-btn delete" onclick="confirmDelete('category', ${cat.id}, '${type}', '${cat.name}')">
<i class="fas fa-trash"></i>
</button>
</div>
</div>
<div class="budget-stats">
<div class="stat-box">
<div class="stat-label">${planLabel}</div>
<div class="stat-value plan">${formatCurrency(plan)}</div>
<div class="stat-sub">${formatCurrency(plan * tryRate, 'TRY')} / ${formatCurrency(plan * rubRate, 'RUB')}</div>
${planOriginalHtml}
</div>
<div class="stat-box">
<div class="stat-label">Ger√ßekle≈üen</div>
<div class="stat-value fact">${formatCurrency(fact)}</div>
<div class="stat-sub">${formatCurrency(fact * tryRate, 'TRY')} / ${formatCurrency(fact * rubRate, 'RUB')}</div>
${originalCurrencyHtml}
</div>
<div class="stat-box">
<div class="stat-label">Fark</div>
<div class="stat-value diff ${diff >= 0 ? 'positive' : 'negative'}">${diff >= 0 ? '+' : ''}${formatCurrency(diff)}</div>
<div class="stat-sub">${diff >= 0 ? '+' : ''}${formatCurrency(diff * tryRate, 'TRY')} / ${diff >= 0 ? '+' : ''}${formatCurrency(diff * rubRate, 'RUB')}</div>
</div>
</div>
${dailySection}
<div class="plan-fact-bar">
<div class="plan-fact-fill ${barClass}" style="width: ${Math.min(percent, 100)}%"></div>
</div>
</div>
`;
}).join('');
});
}

// ==================== TRANSACTIONS ====================
function renderMonthFilter() {
const container = document.getElementById('monthFilter');
let html = `<div class="month-chip ${selectedMonth === 'all' ? 'active' : ''}" onclick="filterMonth('all')">T√ºm√º</div>`;
for (let i = 0; i < 12; i++) {
html += `<div class="month-chip ${selectedMonth === i ? 'active' : ''}" onclick="filterMonth(${i})">${monthNames[i]}</div>`;
}
container.innerHTML = html;
}

function filterMonth(month) {
selectedMonth = month;
renderMonthFilter();
renderTransactions();
}

// Bilan√ßo alan isimleri ve ikonlarƒ±
const balanceFieldNames = {
cash: 'Nakit (Cash)',
investments: 'Yatƒ±rƒ±mlar (Investments)',
receivables: 'Alacaklar (Receivables)',
credits: 'Krediler (Credits)',
debitCards: 'Kredi Kartlarƒ± (Debit Cards)',
debts: 'Bor√ßlar (Debts)'
};

const balanceFieldIcons = {
cash: 'fa-money-bill-wave',
investments: 'fa-chart-line',
receivables: 'fa-hand-holding-usd',
credits: 'fa-credit-card',
debitCards: 'fa-credit-card',
debts: 'fa-file-invoice-dollar'
};

function renderTransactions() {
const container = document.getElementById('transactionsList');
let yearTx = getYearTransactions();

if (selectedMonth !== 'all') {
yearTx = yearTx.filter(t => new Date(t.date).getMonth() === selectedMonth);
}

if (yearTx.length === 0) {
container.innerHTML = `
<div class="empty-state">
<i class="fas fa-receipt"></i>
<p>Bu d√∂nemde i≈ülem yok</p>
</div>
`;
return;
}

const sorted = [...yearTx].sort((a, b) => new Date(b.date) - new Date(a.date));

container.innerHTML = sorted.map(t => {
const date = new Date(t.date);

// Bilan√ßo i≈ülemi mi kontrol et
if (t.type === 'balance') {
const fieldName = balanceFieldNames[t.balanceField] || t.balanceField;
const fieldIcon = balanceFieldIcons[t.balanceField] || 'fa-wallet';
const isAsset = t.balanceType === 'asset';
const typeClass = isAsset ? 'income' : 'expense';
const typeLabel = isAsset ? 'Varlƒ±k' : 'Y√ºk√ºml√ºl√ºk';

// Orijinal para biriminde g√∂ster
let displayValue = '';
if (t.inputCurrency === 'USD') {
displayValue = formatCurrency(t.newValue);
} else if (t.inputCurrency === 'TRY') {
displayValue = formatCurrencyTRY(t.inputValue);
} else if (t.inputCurrency === 'RUB') {
displayValue = formatCurrencyRUB(t.inputValue);
}

// Fark g√∂sterimi
let diffHtml = '';
if (t.diff !== 0) {
const diffSign = t.diff > 0 ? '+' : '';
diffHtml = `<span style="font-size: 0.75rem; color: ${t.diff > 0 ? 'var(--accent-income)' : 'var(--accent-expense)'};">(${diffSign}${formatCurrency(t.diff)})</span>`;
}

return `
<div class="transaction-item" style="border-left: 3px solid var(--accent-main);">
<div class="transaction-header">
<span class="transaction-category">
<i class="fas ${fieldIcon}" style="color: var(--accent-main);"></i>
<span style="color: var(--accent-main);">üìä</span> ${fieldName}
</span>
<span class="transaction-date">${date.getDate()} ${monthNames[date.getMonth()]}</span>
</div>
<div class="transaction-details">
<span class="transaction-note">${t.note || typeLabel}</span>
<div style="display: flex; align-items: center; gap: 8px;">
<div class="transaction-amounts">
<div class="transaction-amount" style="color: var(--accent-main);">
${displayValue} ${diffHtml}
</div>
${t.inputCurrency !== 'USD' ? `
<div class="transaction-usd">${formatCurrency(t.newValue)}</div>
<div class="transaction-rate">${(t.rateSource || 'monthly') === 'live' ? 'üì°' : 'üìÖ'} @${t.rateAtTime.toFixed(2)}</div>
` : ''}
</div>
<button class="action-btn delete" onclick="confirmDelete('transaction', ${t.id})">
<i class="fas fa-trash"></i>
</button>
</div>
</div>
</div>
`;
}

// Normal gelir/gider i≈ülemi
const cat = [...categories.income, ...categories.expense].find(c => c.id === t.categoryId);
const catName = cat ? cat.name : 'Bilinmeyen';
const catIcon = cat ? cat.icon : 'fa-tag';

return `
<div class="transaction-item">
<div class="transaction-header">
<span class="transaction-category">
<i class="fas ${catIcon}"></i> ${catName}
</span>
<span class="transaction-date">${date.getDate()} ${monthNames[date.getMonth()]}</span>
</div>
<div class="transaction-details">
<span class="transaction-note">${t.note || '-'}</span>
<div style="display: flex; align-items: center; gap: 8px;">
<div class="transaction-amounts">
<div class="transaction-amount ${t.type}">
${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount, t.currency)}
</div>
${t.currency !== 'USD' ? `
<div class="transaction-usd">${formatCurrency(t.amountUSD)}</div>
<div class="transaction-rate">${(t.rateSource || 'monthly') === 'live' ? 'üì°' : 'üìÖ'} @${t.rateAtTime.toFixed(2)}</div>
` : ''}
</div>
<button class="action-btn delete" onclick="confirmDelete('transaction', ${t.id})">
<i class="fas fa-trash"></i>
</button>
</div>
</div>
</div>
`;
}).join('');
}

// ==================== MODALS ====================
function openTransactionModal() {
document.getElementById('transactionModal').classList.add('active');
document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
document.getElementById('transactionAmount').value = '';
document.getElementById('transactionNote').value = '';
selectedCategoryId = null;
selectedCurrency = 'USD';
setTransactionType('income');
renderCategorySelect();
updateCurrencyButtons();
updateCurrentRatesDisplay();
updateLiveRateDisplay();
}


function closeModal(id) {
document.getElementById(id).classList.remove('active');
}

function setTransactionType(type) {
currentTransactionType = type;
document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
document.querySelector(`.type-btn.${type}`).classList.add('active');
selectedCategoryId = null;
renderCategorySelect();
}

function updateCurrencyButtons() {
document.querySelectorAll('.currency-btn').forEach(btn => {
btn.classList.toggle('active', btn.dataset.currency === selectedCurrency);
});
}

function updateCurrentRatesDisplay() {
const txDate = document.getElementById('transactionDate')?.value;
const month = txDate ? new Date(txDate).getMonth() : currentMonth;
const tryRate = getRateForMonth('TRY', month);
const rubRate = getRateForMonth('RUB', month);

document.getElementById('currentRates').innerHTML = `
<span class="rate-chip">${monthNames[month]}: 1$ = ${tryRate.toFixed(2)}‚Ç∫</span>
<span class="rate-chip">${monthNames[month]}: 1$ = ${rubRate.toFixed(2)}‚ÇΩ</span>
`;
}

document.querySelectorAll('.currency-btn').forEach(btn => {
btn.addEventListener('click', (e) => {
e.preventDefault();
selectedCurrency = btn.dataset.currency;
updateCurrencyButtons();
});
});

// Tarih deƒüi≈ütiƒüinde kur g√∂sterimini g√ºncelle
document.getElementById('transactionDate').addEventListener('change', () => {
updateCurrentRatesDisplay();
});

function renderCategorySelect() {
const container = document.getElementById('categorySelectGrid');
const cats = categories[currentTransactionType];

if (cats.length === 0) {
container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--text-secondary); padding: 24px; font-size: 0.9rem;">√ñnce kategori ekleyin ‚Üí</p>';
return;
}

container.innerHTML = cats.map(cat => `
<div class="category-select-item ${selectedCategoryId === cat.id ? 'selected' : ''}"
onclick="selectCategory(${cat.id})">
<i class="fas ${cat.icon}"></i>
<span>${cat.name}</span>
</div>
`).join('');
}

function selectCategory(id) {
selectedCategoryId = id;
renderCategorySelect();
}

async function saveTransaction() {
const amount = parseFloat(document.getElementById('transactionAmount').value);
const note = document.getElementById('transactionNote').value.trim();
const date = document.getElementById('transactionDate').value;

if (!selectedCategoryId) { showToast('Kategori se√ßin'); return; }
if (!amount || amount <= 0) { showToast('Tutar girin'); return; }
if (!date) { showToast('Tarih se√ßin'); return; }

let rateAtTime;
let amountUSD;
let rateSource = 'live'; // 'live' veya 'monthly'

// USD ise kur 1
if (selectedCurrency === 'USD') {
rateAtTime = 1;
amountUSD = amount;
} else {
// √ñnce cache'e bak (modal a√ßƒ±kken zaten √ßekilmi≈ü olmalƒ±)
if (cachedLiveRates[selectedCurrency] && cachedLiveRates.timestamp) {
const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
if (cachedLiveRates.timestamp.getTime() > fiveMinutesAgo) {
rateAtTime = cachedLiveRates[selectedCurrency];
amountUSD = amount / rateAtTime;
rateSource = 'live';
}
}

// Cache'de yoksa veya eskiyse API'den √ßek
if (!rateAtTime) {
const liveRate = await fetchLiveRateForCurrency(selectedCurrency);
if (liveRate) {
rateAtTime = liveRate;
amountUSD = amount / rateAtTime;
rateSource = 'live';
} else {
// Canlƒ± kur alƒ±namazsa aylƒ±k kuru kullan
const txMonth = new Date(date).getMonth();
rateAtTime = getRateForMonth(selectedCurrency, txMonth);
amountUSD = amount / rateAtTime;
rateSource = 'monthly';
}
}
}

const symbol = selectedCurrency === 'TRY' ? '‚Ç∫' : selectedCurrency === 'RUB' ? '‚ÇΩ' : '$';

transactions.push({
id: Date.now(),
type: currentTransactionType,
categoryId: selectedCategoryId,
amount,
currency: selectedCurrency,
amountUSD,
rateAtTime,
rateSource, // Kurun nereden geldiƒüini kaydet
note,
date
});

closeModal('transactionModal');
saveData();
updateAll();

if (selectedCurrency !== 'USD') {
const rateInfo = rateSource === 'live' ? 'üì° Canlƒ±' : 'üìÖ Aylƒ±k';
showToast(`Kaydedildi ‚úì | ${rateInfo} kur: 1$ = ${symbol}${rateAtTime.toFixed(2)}`);
} else {
showToast('Kaydedildi ‚úì');
}
}

// ƒ∞≈ülem tarihinin ayƒ±na g√∂re kuru al
const txMonth = new Date(date).getMonth();
const rateAtTime = getRateForMonth(selectedCurrency, txMonth);
const amountUSD = amount / rateAtTime;

transactions.push({
id: Date.now(),
type: currentTransactionType,
categoryId: selectedCategoryId,
amount,
currency: selectedCurrency,
amountUSD,
rateAtTime,
note,
date
});

closeModal('transactionModal');
saveData();
updateAll();
showToast('Kaydedildi ‚úì');
}

// Belirli bir para birimi i√ßin canlƒ± kur √ßek
async function fetchLiveRateForCurrency(currency) {
try {
// √ñnce cache'e bak (son 5 dakika i√ßinde alƒ±nmƒ±≈üsa)
if (cachedLiveRates[currency] && cachedLiveRates.timestamp) {
const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
if (cachedLiveRates.timestamp.getTime() > fiveMinutesAgo) {
return cachedLiveRates[currency];
}
}

// Frankfurter API
const response = await fetch(`https://api.frankfurter.app/latest?from=USD&to=${currency}`);
if (response.ok) {
const data = await response.json();
if (data.rates && data.rates[currency]) {
cachedLiveRates[currency] = data.rates[currency];
cachedLiveRates.timestamp = new Date();
return data.rates[currency];
}
}

// Yedek API
const backupResponse = await fetch('https://open.er-api.com/v6/latest/USD');
if (backupResponse.ok) {
const backupData = await backupResponse.json();
if (backupData.rates && backupData.rates[currency]) {
cachedLiveRates[currency] = backupData.rates[currency];
cachedLiveRates.timestamp = new Date();
return backupData.rates[currency];
}
}

return null;
} catch (error) {
console.error('Canlƒ± kur alƒ±namadƒ±:', error);
return null;
}
}

// ƒ∞≈ülem modalƒ±nda para birimi se√ßildiƒüinde
async function selectTransactionCurrency(currency) {
selectedCurrency = currency;
updateCurrencyButtons();
await updateLiveRateDisplay();
updateUsdEquivalent();
}

// Canlƒ± kur g√∂sterimini g√ºncelle
async function updateLiveRateDisplay() {
const liveRateBox = document.getElementById('liveRateBox');
const liveRateValue = document.getElementById('liveRateValue');
const liveRateTime = document.getElementById('liveRateTime');

if (selectedCurrency === 'USD') {
liveRateBox.style.display = 'none';
return;
}

liveRateBox.style.display = 'block';
liveRateValue.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Y√ºkleniyor...';
liveRateTime.textContent = '';

const rate = await fetchLiveRateForCurrency(selectedCurrency);

if (rate) {
const symbol = selectedCurrency === 'TRY' ? '‚Ç∫' : '‚ÇΩ';
liveRateValue.textContent = `1$ = ${symbol}${rate.toFixed(4)}`;
liveRateTime.textContent = `Son g√ºncelleme: ${new Date().toLocaleString('tr-TR')}`;
} else {
// Canlƒ± kur alƒ±namazsa aylƒ±k kuru g√∂ster
const txDate = document.getElementById('transactionDate')?.value;
const month = txDate ? new Date(txDate).getMonth() : currentMonth;
const monthlyRate = getRateForMonth(selectedCurrency, month);
const symbol = selectedCurrency === 'TRY' ? '‚Ç∫' : '‚ÇΩ';
liveRateValue.textContent = `1$ = ${symbol}${monthlyRate.toFixed(4)}`;
liveRateTime.textContent = '‚ö†Ô∏è Aylƒ±k kayƒ±tlƒ± kur kullanƒ±lƒ±yor';
}

updateUsdEquivalent();
}

// Tutar girildiƒüinde dolar kar≈üƒ±lƒ±ƒüƒ±nƒ± hesapla
function updateUsdEquivalent() {
const amount = parseFloat(document.getElementById('transactionAmount').value) || 0;
const liveUsdEquivalent = document.getElementById('liveUsdEquivalent');

if (selectedCurrency === 'USD') {
if (liveUsdEquivalent) liveUsdEquivalent.textContent = `$${amount.toLocaleString('tr-TR', { maximumFractionDigits: 2 })}`;
return;
}

const rate = cachedLiveRates[selectedCurrency];
if (rate && rate > 0) {
const usdAmount = amount / rate;
if (liveUsdEquivalent) {
liveUsdEquivalent.textContent = `$${usdAmount.toLocaleString('tr-TR', { maximumFractionDigits: 2 })}`;
}
} else {
// Aylƒ±k kur kullan
const txDate = document.getElementById('transactionDate')?.value;
const month = txDate ? new Date(txDate).getMonth() : currentMonth;
const monthlyRate = getRateForMonth(selectedCurrency, month);
const usdAmount = monthlyRate > 0 ? amount / monthlyRate : 0;
if (liveUsdEquivalent) {
liveUsdEquivalent.textContent = `$${usdAmount.toLocaleString('tr-TR', { maximumFractionDigits: 2 })}`;
}
}
}


function renderMonthlyBudgetGrid(containerId, values = null) {
const container = document.getElementById(containerId);
container.innerHTML = monthNames.map((month, i) => `
<div class="monthly-input">
<label>${month}</label>
<input type="number" id="${containerId}_${i}" value="${values ? (values[i] || 0) : 0}" step="0.01" inputmode="decimal">
</div>
`).join('');
}

function getMonthlyBudgets(containerId) {
const budgets = [];
for (let i = 0; i < 12; i++) {
const input = document.getElementById(`${containerId}_${i}`);
budgets.push(parseFloat(input?.value) || 0);
}
return budgets;
}

function fillEqualMonthly() {
const yearly = parseFloat(document.getElementById('categoryYearlyBudget').value) || 0;
const monthly = yearly / 12;
for (let i = 0; i < 12; i++) {
const input = document.getElementById(`monthlyBudgetGrid_${i}`);
if (input) input.value = monthly.toFixed(2);
}
}

function fillEqualMonthlyEdit() {
const yearly = parseFloat(document.getElementById('editCategoryYearlyBudget').value) || 0;
const monthly = yearly / 12;
for (let i = 0; i < 12; i++) {
const input = document.getElementById(`editMonthlyBudgetGrid_${i}`);
if (input) input.value = monthly.toFixed(2);
}
}

function openCategoryModal(type) {
currentCategoryType = type;
document.getElementById('categoryModalTitle').textContent =
type === 'income' ? 'Yeni Gelir Kalemi' : 'Yeni Gider Kalemi';
document.getElementById('categoryName').value = '';
document.getElementById('categoryYearlyBudget').value = '';
selectedIcon = 'fa-tag';
selectedCategoryCurrency = 'USD';
updateCategoryCurrencyUI();
renderMonthlyBudgetGrid('monthlyBudgetGrid');
renderIconGrid();
document.getElementById('categoryModal').classList.add('active');
}

function setCategoryCurrency(currency) {
selectedCategoryCurrency = currency;
updateCategoryCurrencyUI();
}

function updateCategoryCurrencyUI() {
const symbol = currencySymbols[selectedCategoryCurrency];
document.getElementById('yearlyBudgetLabel').textContent = `Yƒ±llƒ±k B√ºt√ße (${symbol})`;

// Update monthly budget label (keep button)
const monthlyLabel = document.getElementById('monthlyBudgetLabel');
const btn = monthlyLabel.querySelector('button');
monthlyLabel.innerHTML = `Aylƒ±k B√ºt√ßeler (${symbol}) `;
monthlyLabel.appendChild(btn);

// Update currency buttons
document.querySelectorAll('#categoryCurrencyToggle .currency-btn').forEach(btn => {
btn.classList.toggle('active', btn.dataset.currency === selectedCategoryCurrency);
});

// Show rates
updateCategoryRatesDisplay();
}

function updateCategoryRatesDisplay() {
const avgTryRate = monthlyRates.TRY.reduce((a, b) => a + b, 0) / 12;
const avgRubRate = monthlyRates.RUB.reduce((a, b) => a + b, 0) / 12;

document.getElementById('categoryRatesDisplay').innerHTML = `
<span class="rate-chip">Ort: 1$ = ${avgTryRate.toFixed(2)}‚Ç∫</span>
<span class="rate-chip">Ort: 1$ = ${avgRubRate.toFixed(2)}‚ÇΩ</span>
`;
}

function renderIconGrid() {
document.getElementById('iconGrid').innerHTML = icons.map(icon => `
<button class="icon-option ${selectedIcon === icon ? 'selected' : ''}"
onclick="selectIcon('${icon}')">
<i class="fas ${icon}"></i>
</button>
`).join('');
}

function selectIcon(icon) {
selectedIcon = icon;
renderIconGrid();
}

function saveCategory() {
const name = document.getElementById('categoryName').value.trim();
let yearlyBudget = parseFloat(document.getElementById('categoryYearlyBudget').value) || 0;
let monthlyBudgets = getMonthlyBudgets('monthlyBudgetGrid');

if (!name) { showToast('ƒ∞sim girin'); return; }

// Convert to USD if entered in different currency
if (selectedCategoryCurrency !== 'USD') {
const avgRate = selectedCategoryCurrency === 'TRY'
? monthlyRates.TRY.reduce((a, b) => a + b, 0) / 12
: monthlyRates.RUB.reduce((a, b) => a + b, 0) / 12;

yearlyBudget = yearlyBudget / avgRate;
monthlyBudgets = monthlyBudgets.map((val, i) => {
const rate = getRateForMonth(selectedCategoryCurrency, i);
return val / rate;
});
}

categories[currentCategoryType].push({
id: nextCategoryId++,
name,
yearlyBudget,
monthlyBudgets,
icon: selectedIcon
});

closeModal('categoryModal');
saveData();
updateAll();
showToast('Eklendi ‚úì');
}

function openEditBudgetModal(categoryId) {
const cat = [...categories.income, ...categories.expense].find(c => c.id === categoryId);
if (!cat) return;

editingCategoryId = categoryId;

// Mevcut yƒ±l i√ßin b√ºt√ße bilgilerini al
const yearBudget = cat.budgets && cat.budgets[currentYear];
let yearlyBudgetUSD = 0;
let monthlyBudgetsUSD = [];
let savedCurrency = 'USD';

if (yearBudget) {
yearlyBudgetUSD = yearBudget.yearlyBudget || 0;
monthlyBudgetsUSD = yearBudget.monthlyBudgets || [];
savedCurrency = yearBudget.budgetCurrency || 'USD';
} else {
// Eski format desteƒüi (geriye uyumluluk)
yearlyBudgetUSD = cat.yearlyBudget || 0;
monthlyBudgetsUSD = cat.monthlyBudgets || [];
savedCurrency = cat.budgetCurrency || 'USD';
}

selectedEditCategoryCurrency = savedCurrency;
document.getElementById('editCategoryName').value = cat.name;

// Eƒüer kayƒ±tlƒ± para birimi varsa, o para biriminde g√∂ster
if (savedCurrency !== 'USD') {
const avgRate = savedCurrency === 'TRY'
? monthlyRates.TRY.reduce((a, b) => a + b, 0) / 12
: monthlyRates.RUB.reduce((a, b) => a + b, 0) / 12;
document.getElementById('editCategoryYearlyBudget').value = (yearlyBudgetUSD * avgRate).toFixed(2);

const convertedMonthly = monthlyBudgetsUSD.map((val, i) => {
const rate = getRateForMonth(savedCurrency, i);
return val * rate;
});
renderMonthlyBudgetGrid('editMonthlyBudgetGrid', convertedMonthly);
} else {
document.getElementById('editCategoryYearlyBudget').value = yearlyBudgetUSD;
renderMonthlyBudgetGrid('editMonthlyBudgetGrid', monthlyBudgetsUSD);
}

updateEditCategoryCurrencyUI();

// G√ºnl√ºk takip ayarƒ±nƒ± oku
const dailyTracking = cat.dailyTracking !== undefined ? cat.dailyTracking : false;
document.getElementById('editDailyTracking').checked = dailyTracking;
updateDailyTrackingStatus();

// Modal ba≈ülƒ±ƒüƒ±na yƒ±lƒ± ekle
document.querySelector('#editBudgetModal .modal-header h2').textContent = `${currentYear} B√ºt√ßesi D√ºzenle`;
document.getElementById('editBudgetModal').classList.add('active');
}

function updateDailyTrackingStatus() {
const isChecked = document.getElementById('editDailyTracking').checked;
document.getElementById('dailyTrackingStatus').textContent = isChecked ? 'A√ßƒ±k' : 'Kapalƒ±';
document.getElementById('dailyTrackingStatus').style.color = isChecked ? 'var(--accent-main)' : 'var(--text-secondary)';
}

function setEditCategoryCurrency(currency) {
// Get current values in USD
const cat = [...categories.income, ...categories.expense].find(c => c.id === editingCategoryId);
if (!cat) return;

selectedEditCategoryCurrency = currency;
updateEditCategoryCurrencyUI();

// Yƒ±l bazƒ±nda b√ºt√ße bilgilerini al
const yearBudget = cat.budgets && cat.budgets[currentYear];
let yearlyBudgetUSD = 0;
let monthlyBudgetsUSD = [];

if (yearBudget) {
yearlyBudgetUSD = yearBudget.yearlyBudget || 0;
monthlyBudgetsUSD = yearBudget.monthlyBudgets || [];
} else {
// Eski format desteƒüi
yearlyBudgetUSD = cat.yearlyBudget || 0;
monthlyBudgetsUSD = cat.monthlyBudgets || [];
}

// Convert and display in selected currency
if (currency === 'USD') {
document.getElementById('editCategoryYearlyBudget').value = yearlyBudgetUSD.toFixed(2);
renderMonthlyBudgetGrid('editMonthlyBudgetGrid', monthlyBudgetsUSD);
} else {
const avgRate = currency === 'TRY'
? monthlyRates.TRY.reduce((a, b) => a + b, 0) / 12
: monthlyRates.RUB.reduce((a, b) => a + b, 0) / 12;

document.getElementById('editCategoryYearlyBudget').value = (yearlyBudgetUSD * avgRate).toFixed(2);

const convertedMonthly = monthlyBudgetsUSD.map((val, i) => {
const rate = getRateForMonth(currency, i);
return val * rate;
});
renderMonthlyBudgetGrid('editMonthlyBudgetGrid', convertedMonthly);
}
}

function updateEditCategoryCurrencyUI() {
const symbol = currencySymbols[selectedEditCategoryCurrency];
document.getElementById('editYearlyBudgetLabel').textContent = `Yƒ±llƒ±k B√ºt√ße (${symbol})`;

// Update monthly budget label (keep button)
const monthlyLabel = document.getElementById('editMonthlyBudgetLabel');
const btn = monthlyLabel.querySelector('button');
monthlyLabel.innerHTML = `Aylƒ±k B√ºt√ßeler (${symbol}) `;
monthlyLabel.appendChild(btn);

// Update currency buttons
document.querySelectorAll('#editCategoryCurrencyToggle .currency-btn').forEach(btn => {
btn.classList.toggle('active', btn.dataset.currency === selectedEditCategoryCurrency);
});

// Show rates
updateEditCategoryRatesDisplay();
}

function updateEditCategoryRatesDisplay() {
const avgTryRate = monthlyRates.TRY.reduce((a, b) => a + b, 0) / 12;
const avgRubRate = monthlyRates.RUB.reduce((a, b) => a + b, 0) / 12;

document.getElementById('editCategoryRatesDisplay').innerHTML = `
<span class="rate-chip">Ort: 1$ = ${avgTryRate.toFixed(2)}‚Ç∫</span>
<span class="rate-chip">Ort: 1$ = ${avgRubRate.toFixed(2)}‚ÇΩ</span>
`;
}

function updateCategory() {
const name = document.getElementById('editCategoryName').value.trim();
let yearlyBudget = parseFloat(document.getElementById('editCategoryYearlyBudget').value) || 0;
let monthlyBudgets = getMonthlyBudgets('editMonthlyBudgetGrid');

if (!name) { showToast('ƒ∞sim girin'); return; }

// Convert to USD if entered in different currency
if (selectedEditCategoryCurrency !== 'USD') {
const avgRate = selectedEditCategoryCurrency === 'TRY'
? monthlyRates.TRY.reduce((a, b) => a + b, 0) / 12
: monthlyRates.RUB.reduce((a, b) => a + b, 0) / 12;

yearlyBudget = yearlyBudget / avgRate;
monthlyBudgets = monthlyBudgets.map((val, i) => {
const rate = getRateForMonth(selectedEditCategoryCurrency, i);
return val / rate;
});
}

const dailyTracking = document.getElementById('editDailyTracking').checked;

['income', 'expense'].forEach(type => {
const cat = categories[type].find(c => c.id === editingCategoryId);
if (cat) {
cat.name = name;
cat.dailyTracking = dailyTracking; // G√ºnl√ºk takip ayarƒ±
// Yƒ±l bazƒ±nda b√ºt√ße kaydet
if (!cat.budgets) cat.budgets = {};
cat.budgets[currentYear] = {
yearlyBudget: yearlyBudget,
monthlyBudgets: monthlyBudgets,
budgetCurrency: selectedEditCategoryCurrency
};
}
});

closeModal('editBudgetModal');
saveData();
updateAll();
showToast('G√ºncellendi ‚úì');
}

function renderMonthlyRatesGrid(containerId, currency) {
const container = document.getElementById(containerId);
const rates = monthlyRates[currency] || Array(12).fill(currency === 'TRY' ? 38.50 : 96.00);
container.innerHTML = monthNames.map((month, i) => `
<div class="monthly-input">
<label>${month}</label>
<input type="number" id="${containerId}_${i}" value="${rates[i] || 0}" step="0.01" inputmode="decimal">
</div>
`).join('');
}

function getMonthlyRatesFromGrid(containerId) {
const rates = [];
for (let i = 0; i < 12; i++) {
const input = document.getElementById(`${containerId}_${i}`);
rates.push(parseFloat(input?.value) || 0);
}
return rates;
}

function openRatesModal() {
renderMonthlyRatesGrid('monthlyRatesTRY', 'TRY');
renderMonthlyRatesGrid('monthlyRatesRUB', 'RUB');
document.getElementById('ratesModal').classList.add('active');
}

// ==================== DATA MANAGEMENT ====================
function openDataModal() {
const catCount = categories.income.length + categories.expense.length;
const txCount = transactions.length;
document.getElementById('statCategories').textContent = `${catCount} kategori`;
document.getElementById('statTransactions').textContent = `${txCount} i≈ülem`;
document.getElementById('dataModal').classList.add('active');
}

function exportData() {
const data = {
version: 1,
exportDate: new Date().toISOString(),
categories,
transactions,
monthlyRates,
exchangeRates,
nextCategoryId
};

const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = `butce-yedek-${new Date().toISOString().split('T')[0]}.json`;
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(url);
showToast('Veriler indirildi ‚úì');
}

function importData(event) {
const file = event.target.files[0];
if (!file) return;

const reader = new FileReader();
reader.onload = function(e) {
try {
const data = JSON.parse(e.target.result);

// Validate data structure
if (!data.categories || !data.transactions) {
showToast('Ge√ßersiz dosya formatƒ±');
return;
}

// Import data
categories = data.categories || { income: [], expense: [] };
transactions = data.transactions || [];
monthlyRates = data.monthlyRates || {
TRY: Array(12).fill(38.50),
RUB: Array(12).fill(96.00)
};
exchangeRates = data.exchangeRates || { USD: 1, TRY: 38.50, RUB: 96.00 };
nextCategoryId = data.nextCategoryId || 1;

saveData();
closeModal('dataModal');
updateAll();
showToast('Veriler y√ºklendi ‚úì');
} catch (err) {
showToast('Dosya okunamadƒ±');
}
};
reader.readAsText(file);
event.target.value = ''; // Reset input
}

function confirmClearAllData() {
document.getElementById('confirmMessage').textContent = 'T√ºm kategoriler ve i≈ülemler silinecek. Bu i≈ülem geri alƒ±namaz!';
deleteCallback = () => {
categories = { income: [], expense: [] };
transactions = [];
nextCategoryId = 1;
saveData();
closeModal('dataModal');
updateAll();
showToast('Veriler temizlendi');
};
document.getElementById('confirmModal').classList.add('active');
}

// ==================== PDF REPORT ====================
function generatePDFReport() {
const { jsPDF } = window.jspdf;
const doc = new jsPDF();

const isMonthly = viewMode === 'monthly';
const allYearTx = getYearTransactions(); // T√ºm i≈ülemler (bilan√ßo dahil)
const yearTx = allYearTx.filter(t => t.type !== 'balance'); // Sadece gelir/gider
const tryRate = isMonthly
? getRateForMonth('TRY', currentMonth)
: monthlyRates.TRY.reduce((a, b) => a + b, 0) / 12;
const rubRate = isMonthly
? getRateForMonth('RUB', currentMonth)
: monthlyRates.RUB.reduce((a, b) => a + b, 0) / 12;

const pageWidth = doc.internal.pageSize.getWidth();
const pageHeight = doc.internal.pageSize.getHeight();
const margin = 15;
let y = 0;

// T√ºrk√ße karakter d√∂n√º≈ü√ºm√º
const fixTurkish = (text) => {
if (!text) return '';
return text
.replace(/ƒ±/g, 'i')
.replace(/ƒ∞/g, 'I')
.replace(/ƒü/g, 'g')
.replace(/ƒû/g, 'G')
.replace(/√º/g, 'u')
.replace(/√ú/g, 'U')
.replace(/≈ü/g, 's')
.replace(/≈û/g, 'S')
.replace(/√∂/g, 'o')
.replace(/√ñ/g, 'O')
.replace(/√ß/g, 'c')
.replace(/√á/g, 'C');
};

// Renkler
const colors = {
primary: [108, 92, 231],
income: [0, 184, 148],
expense: [225, 112, 85],
text: [45, 52, 54],
textLight: [99, 110, 114],
bg: [248, 245, 241],
white: [255, 255, 255],
warning: [253, 203, 110],
balance: [108, 92, 231]
};

// Helper fonksiyonlar
const drawRect = (x, y, w, h, color, radius = 0) => {
doc.setFillColor(...color);
if (radius > 0) {
doc.roundedRect(x, y, w, h, radius, radius, 'F');
} else {
doc.rect(x, y, w, h, 'F');
}
};

const formatMoney = (val, currency = 'USD') => {
if (currency === 'TRY') return `TL${Math.round(val).toLocaleString('tr-TR')}`;
if (currency === 'RUB') return `RUB${Math.round(val).toLocaleString('ru-RU')}`;
return `$${Math.round(val).toLocaleString('en-US')}`;
};

const addPage = () => {
doc.addPage();
y = margin;
};

const checkPageBreak = (needed = 20) => {
if (y + needed > pageHeight - 20) {
addPage();
return true;
}
return false;
};

// ==================== SAYFA 1: KAPAK ====================
// Gradient arka plan efekti
drawRect(0, 0, pageWidth, 80, colors.primary);

// Dekoratif daireler
doc.setFillColor(255, 255, 255, 0.1);
doc.circle(pageWidth - 20, 20, 40, 'F');
doc.circle(30, 60, 25, 'F');

// Logo/ƒ∞kon
doc.setFontSize(40);
doc.setTextColor(255, 255, 255);
doc.text('$', pageWidth / 2, 40, { align: 'center' });

// Ba≈ülƒ±k
doc.setFontSize(24);
doc.setTextColor(255, 255, 255);
const title = isMonthly
? `${fixTurkish(monthNamesFull[currentMonth])} ${currentYear}`
: `${currentYear} Yili`;
doc.text('BUTCE RAPORU', pageWidth / 2, 55, { align: 'center' });

doc.setFontSize(16);
doc.text(title, pageWidth / 2, 68, { align: 'center' });

y = 95;

// Calculate totals
let planIncome, planExpense, factIncome, factExpense;
const monthTx = isMonthly ? yearTx.filter(t => new Date(t.date).getMonth() === currentMonth) : yearTx;

if (isMonthly) {
planIncome = categories.income.reduce((sum, c) => sum + getCategoryMonthlyPlan(c, currentMonth), 0);
planExpense = categories.expense.reduce((sum, c) => sum + getCategoryMonthlyPlan(c, currentMonth), 0);
factIncome = monthTx.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amountUSD, 0);
factExpense = monthTx.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amountUSD, 0);
} else {
planIncome = categories.income.reduce((sum, c) => sum + getCategoryYearlyPlan(c), 0);
planExpense = categories.expense.reduce((sum, c) => sum + getCategoryYearlyPlan(c), 0);
factIncome = yearTx.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amountUSD, 0);
factExpense = yearTx.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amountUSD, 0);
}

const net = factIncome - factExpense;
const planNet = planIncome - planExpense;

// ==================== √ñZET KARTLARI ====================
const cardWidth = (pageWidth - margin * 2 - 10) / 2;
const cardHeight = 45;

// Gelir Kartƒ±
drawRect(margin, y, cardWidth, cardHeight, [232, 248, 245], 4);
doc.setFontSize(10);
doc.setTextColor(...colors.textLight);
doc.text('GELIR', margin + 8, y + 12);
doc.setFontSize(16);
doc.setTextColor(...colors.income);
doc.text(formatMoney(factIncome), margin + 8, y + 28);
doc.setFontSize(9);
doc.setTextColor(...colors.textLight);
doc.text(`Plan: ${formatMoney(planIncome)}`, margin + 8, y + 38);

// Gider Kartƒ±
drawRect(margin + cardWidth + 10, y, cardWidth, cardHeight, [254, 240, 237], 4);
doc.setFontSize(10);
doc.setTextColor(...colors.textLight);
doc.text('GIDER', margin + cardWidth + 18, y + 12);
doc.setFontSize(16);
doc.setTextColor(...colors.expense);
doc.text(formatMoney(factExpense), margin + cardWidth + 18, y + 28);
doc.setFontSize(9);
doc.setTextColor(...colors.textLight);
doc.text(`Plan: ${formatMoney(planExpense)}`, margin + cardWidth + 18, y + 38);

y += cardHeight + 10;

// Net Durum Kartƒ±
const netColor = net >= 0 ? colors.income : colors.expense;
const netBg = net >= 0 ? [232, 248, 245] : [254, 240, 237];
drawRect(margin, y, pageWidth - margin * 2, 35, netBg, 4);
doc.setFontSize(10);
doc.setTextColor(...colors.textLight);
doc.text('NET DURUM', margin + 8, y + 12);
doc.setFontSize(20);
doc.setTextColor(...netColor);
doc.text(`${net >= 0 ? '+' : ''}${formatMoney(net)}`, margin + 8, y + 28);

// TRY ve RUB kar≈üƒ±lƒ±klarƒ±
doc.setFontSize(10);
doc.setTextColor(...colors.textLight);
doc.text(`= TL${Math.round(net * tryRate).toLocaleString('tr-TR')} | = RUB${Math.round(net * rubRate).toLocaleString('ru-RU')}`, pageWidth - margin - 8, y + 22, { align: 'right' });

y += 50;

// ==================== KURSLAR ====================
doc.setFontSize(10);
doc.setTextColor(...colors.textLight);
doc.text(`Doviz Kurlari: 1$ = TL${tryRate.toFixed(2)} | 1$ = RUB${rubRate.toFixed(2)}`, margin, y);
const dateStr = new Date().toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
doc.text(`Olusturulma: ${dateStr}`, pageWidth - margin, y, { align: 'right' });

y += 15;

// ==================== GELƒ∞R KATEGORƒ∞LERƒ∞ ====================
drawRect(margin, y, pageWidth - margin * 2, 8, colors.income, 2);
doc.setFontSize(11);
doc.setTextColor(255, 255, 255);
doc.text(' GELIR KATEGORILERI', margin, y + 6);
y += 14;

// Tablo ba≈ülƒ±ƒüƒ±
doc.setFontSize(8);
doc.setTextColor(...colors.textLight);
doc.text('Kategori', margin + 5, y);
doc.text('Plan', margin + 70, y);
doc.text('Gerceklesen', margin + 100, y);
doc.text('Fark', margin + 140, y);
doc.text('%', margin + 165, y);
y += 6;

doc.setDrawColor(220, 220, 220);
doc.line(margin, y - 2, pageWidth - margin, y - 2);

categories.income.forEach((cat, idx) => {
checkPageBreak(8);
const plan = isMonthly ? getCategoryMonthlyPlan(cat, currentMonth) : getCategoryYearlyPlan(cat);
const txCat = monthTx.filter(t => t.categoryId === cat.id);
const fact = txCat.reduce((sum, t) => sum + t.amountUSD, 0);
const diff = fact - plan;
const pct = plan > 0 ? ((fact / plan) * 100).toFixed(0) : '-';

if (idx % 2 === 0) {
drawRect(margin, y - 3, pageWidth - margin * 2, 7, [248, 248, 248]);
}

doc.setFontSize(9);
doc.setTextColor(...colors.text);
doc.text(fixTurkish(cat.name.substring(0, 20)), margin + 5, y + 2);
doc.text(formatMoney(plan), margin + 70, y + 2);
doc.text(formatMoney(fact), margin + 100, y + 2);
const diffColor = diff >= 0 ? colors.income : colors.expense;
doc.setTextColor(...diffColor);
doc.text(`${diff >= 0 ? '+' : ''}${formatMoney(diff)}`, margin + 140, y + 2);
doc.setTextColor(...colors.textLight);
doc.text(`${pct}%`, margin + 165, y + 2);
y += 7;
});

y += 10;

// ==================== Gƒ∞DER KATEGORƒ∞LERƒ∞ ====================
checkPageBreak(30);
drawRect(margin, y, pageWidth - margin * 2, 8, colors.expense, 2);
doc.setFontSize(11);
doc.setTextColor(255, 255, 255);
doc.text(' GIDER KATEGORILERI', margin, y + 6);
y += 14;

// Tablo ba≈ülƒ±ƒüƒ±
doc.setFontSize(8);
doc.setTextColor(...colors.textLight);
doc.text('Kategori', margin + 5, y);
doc.text('Plan', margin + 70, y);
doc.text('Gerceklesen', margin + 100, y);
doc.text('Kalan', margin + 140, y);
doc.text('%', margin + 165, y);
y += 6;

doc.setDrawColor(220, 220, 220);
doc.line(margin, y - 2, pageWidth - margin, y - 2);

categories.expense.forEach((cat, idx) => {
checkPageBreak(8);
const plan = isMonthly ? getCategoryMonthlyPlan(cat, currentMonth) : getCategoryYearlyPlan(cat);
const txCat = monthTx.filter(t => t.categoryId === cat.id);
const fact = txCat.reduce((sum, t) => sum + t.amountUSD, 0);
const remaining = plan - fact;
const pct = plan > 0 ? ((fact / plan) * 100).toFixed(0) : '-';

if (idx % 2 === 0) {
drawRect(margin, y - 3, pageWidth - margin * 2, 7, [248, 248, 248]);
}

doc.setFontSize(9);
doc.setTextColor(...colors.text);
doc.text(fixTurkish(cat.name.substring(0, 20)), margin + 5, y + 2);
doc.text(formatMoney(plan), margin + 70, y + 2);
doc.text(formatMoney(fact), margin + 100, y + 2);
const remainingColor = remaining >= 0 ? colors.income : colors.expense;
doc.setTextColor(...remainingColor);
doc.text(`${remaining >= 0 ? '+' : ''}${formatMoney(remaining)}`, margin + 140, y + 2);
const pctColor = parseInt(pct) > 100 ? colors.expense : colors.textLight;
doc.setTextColor(...pctColor);
doc.text(`${pct}%`, margin + 165, y + 2);
y += 7;
});

// ==================== SAYFA 2: Bƒ∞LAN√áO ====================
addPage();

// Bilan√ßo ba≈ülƒ±ƒüƒ±
drawRect(margin, y, pageWidth - margin * 2, 8, colors.primary, 2);
doc.setFontSize(11);
doc.setTextColor(255, 255, 255);
doc.text(' BILANCO (BALANCE SHEET)', margin, y + 6);
y += 18;

// Varlƒ±klar
const getValue = (item) => (typeof item === 'object' && item !== null) ? (item.value || 0) : (item || 0);
const getNote = (item) => (typeof item === 'object' && item !== null) ? (item.note || '') : '';

const cash = getValue(balanceSheet.assets.cash);
const investments = getValue(balanceSheet.assets.investments);
const receivables = getValue(balanceSheet.assets.receivables);
const totalAssets = cash + investments + receivables;

const credits = getValue(balanceSheet.liabilities.credits);
const debitCards = getValue(balanceSheet.liabilities.debitCards);
const debts = getValue(balanceSheet.liabilities.debts);
const totalLiabilities = credits + debitCards + debts;
const equity = totalAssets - totalLiabilities;

// Varlƒ±klar kartƒ±
drawRect(margin, y, (pageWidth - margin * 2 - 10) / 2, 70, [232, 248, 245], 4);
doc.setFontSize(10);
doc.setTextColor(...colors.income);
doc.text('VARLIKLAR (ASSETS)', margin + 8, y + 12);

doc.setFontSize(9);
doc.setTextColor(...colors.text);
doc.text(`Nakit: ${formatMoney(cash)}`, margin + 8, y + 25);
doc.text(`Yatirimlar: ${formatMoney(investments)}`, margin + 8, y + 35);
doc.text(`Alacaklar: ${formatMoney(receivables)}`, margin + 8, y + 45);

doc.setDrawColor(...colors.income);
doc.line(margin + 8, y + 52, margin + 80, y + 52);
doc.setFontSize(11);
doc.setTextColor(...colors.income);
doc.text(`TOPLAM: ${formatMoney(totalAssets)}`, margin + 8, y + 62);

// Y√ºk√ºml√ºl√ºkler kartƒ±
const rightCardX = margin + (pageWidth - margin * 2 - 10) / 2 + 10;
drawRect(rightCardX, y, (pageWidth - margin * 2 - 10) / 2, 70, [254, 240, 237], 4);
doc.setFontSize(10);
doc.setTextColor(...colors.expense);
doc.text('YUKUMLULUKLER (LIABILITIES)', rightCardX + 8, y + 12);

doc.setFontSize(9);
doc.setTextColor(...colors.text);
doc.text(`Krediler: ${formatMoney(credits)}`, rightCardX + 8, y + 25);
doc.text(`Kredi Kartlari: ${formatMoney(debitCards)}`, rightCardX + 8, y + 35);
doc.text(`Borclar: ${formatMoney(debts)}`, rightCardX + 8, y + 45);

doc.setDrawColor(...colors.expense);
doc.line(rightCardX + 8, y + 52, rightCardX + 80, y + 52);
doc.setFontSize(11);
doc.setTextColor(...colors.expense);
doc.text(`TOPLAM: ${formatMoney(totalLiabilities)}`, rightCardX + 8, y + 62);

y += 80;

// Net Varlƒ±k kartƒ±
const eqColor = equity >= 0 ? colors.income : colors.expense;
const eqBg = equity >= 0 ? [232, 248, 245] : [254, 240, 237];
drawRect(margin, y, pageWidth - margin * 2, 30, eqBg, 4);
doc.setFontSize(12);
doc.setTextColor(...colors.textLight);
doc.text('NET VARLIK (EQUITY)', margin + 8, y + 12);
doc.setFontSize(18);
doc.setTextColor(...eqColor);
doc.text(`${equity >= 0 ? '' : '-'}${formatMoney(Math.abs(equity))}`, margin + 8, y + 25);
doc.setFontSize(10);
doc.setTextColor(...colors.textLight);
doc.text(`${formatMoney(totalAssets)} - ${formatMoney(totalLiabilities)}`, pageWidth - margin - 8, y + 20, { align: 'right' });

y += 45;

// ==================== SON ƒ∞≈ûLEMLER ====================
checkPageBreak(40);
drawRect(margin, y, pageWidth - margin * 2, 8, colors.primary, 2);
doc.setFontSize(11);
doc.setTextColor(255, 255, 255);
doc.text(' SON ISLEMLER', margin, y + 6);
y += 14;

// T√ºm i≈ülemler (bilan√ßo dahil)
const allMonthTx = isMonthly ? allYearTx.filter(t => new Date(t.date).getMonth() === currentMonth) : allYearTx;
const recentTx = allMonthTx.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 20);

if (recentTx.length === 0) {
doc.setFontSize(10);
doc.setTextColor(...colors.textLight);
doc.text('Bu donemde islem bulunmuyor.', margin + 5, y + 5);
} else {
recentTx.forEach((tx, idx) => {
checkPageBreak(10);
const date = new Date(tx.date);
const dateStr = `${date.getDate()}/${date.getMonth() + 1}`;

if (idx % 2 === 0) {
drawRect(margin, y - 2, pageWidth - margin * 2, 8, [248, 248, 248]);
}

doc.setFontSize(8);
doc.setTextColor(...colors.textLight);
doc.text(dateStr, margin + 5, y + 3);

// Bilan√ßo i≈ülemi mi kontrol et
if (tx.type === 'balance') {
const fieldName = fixTurkish(balanceFieldNames[tx.balanceField] || tx.balanceField);
doc.setTextColor(...colors.balance);
doc.text(`[Bilanco] ${fieldName.substring(0, 20)}`, margin + 25, y + 3);

if (tx.note) {
doc.setTextColor(...colors.textLight);
doc.text(fixTurkish(tx.note.substring(0, 25)), margin + 95, y + 3);
}

doc.setTextColor(...colors.balance);
doc.text(formatMoney(tx.newValue), pageWidth - margin - 5, y + 3, { align: 'right' });
} else {
// Normal gelir/gider i≈ülemi
const cat = [...categories.income, ...categories.expense].find(c => c.id === tx.categoryId);
const catName = cat ? fixTurkish(cat.name) : 'Bilinmiyor';

doc.setTextColor(...colors.text);
doc.text(catName.substring(0, 20), margin + 25, y + 3);

if (tx.note) {
doc.setTextColor(...colors.textLight);
doc.text(fixTurkish(tx.note.substring(0, 25)), margin + 95, y + 3);
}

const isIncome = tx.type === 'income';
const txColor = isIncome ? colors.income : colors.expense;
doc.setTextColor(...txColor);
doc.text(`${isIncome ? '+' : '-'}${formatMoney(tx.amountUSD)}`, pageWidth - margin - 5, y + 3, { align: 'right' });
}

y += 8;
});
}

// ==================== FOOTER ====================
const totalPages = doc.internal.getNumberOfPages();
for (let i = 1; i <= totalPages; i++) {
doc.setPage(i);
doc.setFontSize(8);
doc.setTextColor(180, 180, 180);
doc.text('Butce Takip Uygulamasi', margin, pageHeight - 10);
doc.text(`Sayfa ${i} / ${totalPages}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
}

// Save
const filename = isMonthly
? `butce-rapor-${currentYear}-${String(currentMonth + 1).padStart(2, '0')}.pdf`
: `butce-rapor-${currentYear}-yillik.pdf`;

doc.save(filename);
showToast('PDF raporu olu≈üturuldu ‚úì');
}

// ==================== EXCEL REPORT ====================
function generateExcelReport() {
const isMonthly = viewMode === 'monthly';
const yearTx = getYearTransactions();
const tryRate = isMonthly
? getRateForMonth('TRY', currentMonth)
: monthlyRates.TRY.reduce((a, b) => a + b, 0) / 12;

const wb = XLSX.utils.book_new();

// ===== √ñZET SAYFASI =====
const summaryData = [];
summaryData.push(['B√úT√áE RAPORU']);
summaryData.push([isMonthly ? `${monthNamesFull[currentMonth]} ${currentYear}` : `${currentYear} Yƒ±lƒ±`]);
summaryData.push([`Olu≈üturulma: ${new Date().toLocaleDateString('tr-TR')}`]);
summaryData.push([]);

// Hesaplamalar
let planIncome, planExpense, factIncome, factExpense;
if (isMonthly) {
const monthTx = yearTx.filter(t => new Date(t.date).getMonth() === currentMonth);
planIncome = categories.income.reduce((sum, c) => sum + getCategoryMonthlyPlan(c, currentMonth), 0);
planExpense = categories.expense.reduce((sum, c) => sum + getCategoryMonthlyPlan(c, currentMonth), 0);
factIncome = monthTx.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amountUSD, 0);
factExpense = monthTx.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amountUSD, 0);
} else {
planIncome = categories.income.reduce((sum, c) => sum + getCategoryYearlyPlan(c), 0);
planExpense = categories.expense.reduce((sum, c) => sum + getCategoryYearlyPlan(c), 0);
factIncome = yearTx.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amountUSD, 0);
factExpense = yearTx.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amountUSD, 0);
}
const net = factIncome - factExpense;

summaryData.push(['√ñZET', 'Plan ($)', 'Plan (‚Ç∫)', 'Ger√ßekle≈üen ($)', 'Ger√ßekle≈üen (‚Ç∫)', 'Fark ($)', 'Fark (‚Ç∫)']);
summaryData.push(['Gelir', planIncome.toFixed(2), (planIncome * tryRate).toFixed(2), factIncome.toFixed(2), (factIncome * tryRate).toFixed(2), (factIncome - planIncome).toFixed(2), ((factIncome - planIncome) * tryRate).toFixed(2)]);
summaryData.push(['Gider', planExpense.toFixed(2), (planExpense * tryRate).toFixed(2), factExpense.toFixed(2), (factExpense * tryRate).toFixed(2), (planExpense - factExpense).toFixed(2), ((planExpense - factExpense) * tryRate).toFixed(2)]);
summaryData.push(['Net', '', '', net.toFixed(2), (net * tryRate).toFixed(2), '', '']);

const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
XLSX.utils.book_append_sheet(wb, wsSummary, '√ñzet');

// ===== GELƒ∞R KALEMLERƒ∞ SAYFASI =====
const incomeData = [];
incomeData.push(['GELƒ∞R KALEMLERƒ∞']);
incomeData.push([]);
incomeData.push(['Kategori', 'Plan ($)', 'Plan (‚Ç∫)', 'Ger√ßekle≈üen ($)', 'Ger√ßekle≈üen (‚Ç∫)', 'Fark ($)', 'Fark (‚Ç∫)', 'ƒ∞≈ülem Sayƒ±sƒ±']);

categories.income.forEach(cat => {
const plan = isMonthly ? getCategoryMonthlyPlan(cat, currentMonth) : getCategoryYearlyPlan(cat);
const txList = isMonthly
? yearTx.filter(t => t.categoryId === cat.id && new Date(t.date).getMonth() === currentMonth)
: yearTx.filter(t => t.categoryId === cat.id);
const fact = txList.reduce((sum, t) => sum + t.amountUSD, 0);
const diff = fact - plan;

incomeData.push([
cat.name,
plan.toFixed(2),
(plan * tryRate).toFixed(2),
fact.toFixed(2),
(fact * tryRate).toFixed(2),
diff.toFixed(2),
(diff * tryRate).toFixed(2),
txList.length
]);
});

const wsIncome = XLSX.utils.aoa_to_sheet(incomeData);
XLSX.utils.book_append_sheet(wb, wsIncome, 'Gelir Kalemleri');

// ===== Gƒ∞DER KALEMLERƒ∞ SAYFASI =====
const expenseData = [];
expenseData.push(['Gƒ∞DER KALEMLERƒ∞']);
expenseData.push([]);

if (isMonthly) {
const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
expenseData.push(['Kategori', 'Aylƒ±k Plan ($)', 'Aylƒ±k Plan (‚Ç∫)', 'G√ºnl√ºk Limit ($)', 'G√ºnl√ºk Limit (‚Ç∫)', 'Ger√ßekle≈üen ($)', 'Ger√ßekle≈üen (‚Ç∫)', 'Fark ($)', 'Fark (‚Ç∫)', 'ƒ∞≈ülem Sayƒ±sƒ±']);

categories.expense.forEach(cat => {
const plan = getCategoryMonthlyPlan(cat, currentMonth);
const dailyLimit = plan / daysInMonth;
const txList = yearTx.filter(t => t.categoryId === cat.id && new Date(t.date).getMonth() === currentMonth);
const fact = txList.reduce((sum, t) => sum + t.amountUSD, 0);
const diff = plan - fact;

expenseData.push([
cat.name,
plan.toFixed(2),
(plan * tryRate).toFixed(2),
dailyLimit.toFixed(2),
(dailyLimit * tryRate).toFixed(2),
fact.toFixed(2),
(fact * tryRate).toFixed(2),
diff.toFixed(2),
(diff * tryRate).toFixed(2),
txList.length
]);
});
} else {
expenseData.push(['Kategori', 'Plan ($)', 'Plan (‚Ç∫)', 'Ger√ßekle≈üen ($)', 'Ger√ßekle≈üen (‚Ç∫)', 'Fark ($)', 'Fark (‚Ç∫)', 'ƒ∞≈ülem Sayƒ±sƒ±']);

categories.expense.forEach(cat => {
const plan = getCategoryYearlyPlan(cat);
const txList = yearTx.filter(t => t.categoryId === cat.id);
const fact = txList.reduce((sum, t) => sum + t.amountUSD, 0);
const diff = plan - fact;

expenseData.push([
cat.name,
plan.toFixed(2),
(plan * tryRate).toFixed(2),
fact.toFixed(2),
(fact * tryRate).toFixed(2),
diff.toFixed(2),
(diff * tryRate).toFixed(2),
txList.length
]);
});
}

const wsExpense = XLSX.utils.aoa_to_sheet(expenseData);
XLSX.utils.book_append_sheet(wb, wsExpense, 'Gider Kalemleri');

// ===== ƒ∞≈ûLEMLER SAYFASI =====
const txData = [];
txData.push(['ƒ∞≈ûLEMLER']);
txData.push([]);
txData.push(['Tarih', 'T√ºr', 'Kategori', 'Tutar ($)', 'Tutar (‚Ç∫)', 'Orijinal Tutar', 'Para Birimi', 'Kur', 'Not']);

const txList = isMonthly
? yearTx.filter(t => new Date(t.date).getMonth() === currentMonth)
: yearTx;

txList.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(tx => {
const cat = [...categories.income, ...categories.expense].find(c => c.id === tx.categoryId);
const catName = cat ? cat.name : 'Bilinmiyor';
const txTryRate = getRateForMonth('TRY', new Date(tx.date).getMonth());

txData.push([
new Date(tx.date).toLocaleDateString('tr-TR'),
tx.type === 'income' ? 'Gelir' : 'Gider',
catName,
tx.amountUSD.toFixed(2),
(tx.amountUSD * txTryRate).toFixed(2),
tx.amount.toFixed(2),
tx.currency,
tx.rateAtTime?.toFixed(2) || '-',
tx.note || ''
]);
});

const wsTx = XLSX.utils.aoa_to_sheet(txData);
XLSX.utils.book_append_sheet(wb, wsTx, 'ƒ∞≈ülemler');

// ===== AYLIK B√úT√áELER SAYFASI =====
const monthlyBudgetData = [];
monthlyBudgetData.push(['AYLIK B√úT√áELER (USD)']);
monthlyBudgetData.push([]);
monthlyBudgetData.push(['Kategori', 'T√ºr', 'Oca', '≈ûub', 'Mar', 'Nis', 'May', 'Haz', 'Tem', 'Aƒüu', 'Eyl', 'Eki', 'Kas', 'Ara', 'Yƒ±llƒ±k Toplam']);

[...categories.income, ...categories.expense].forEach(cat => {
const type = categories.income.includes(cat) ? 'Gelir' : 'Gider';
const row = [cat.name, type];
for (let i = 0; i < 12; i++) {
row.push(getCategoryMonthlyPlan(cat, i).toFixed(2));
}
row.push(getCategoryYearlyPlan(cat).toFixed(2));
monthlyBudgetData.push(row);
});

const wsMonthlyBudget = XLSX.utils.aoa_to_sheet(monthlyBudgetData);
XLSX.utils.book_append_sheet(wb, wsMonthlyBudget, 'Aylƒ±k B√ºt√ßeler');

// ===== KURLAR SAYFASI =====
const ratesData = [];
ratesData.push(['D√ñVƒ∞Z KURLARI (1 USD = ?)']);
ratesData.push([]);
ratesData.push(['Ay', 'TRY', 'RUB']);
for (let i = 0; i < 12; i++) {
ratesData.push([monthNamesFull[i], monthlyRates.TRY[i].toFixed(2), monthlyRates.RUB[i].toFixed(2)]);
}

const wsRates = XLSX.utils.aoa_to_sheet(ratesData);
XLSX.utils.book_append_sheet(wb, wsRates, 'Kurlar');

// Dosyayƒ± kaydet
const filename = isMonthly
? `butce-${currentYear}-${String(currentMonth + 1).padStart(2, '0')}.xlsx`
: `butce-${currentYear}-yillik.xlsx`;

XLSX.writeFile(wb, filename);
showToast('Excel olu≈üturuldu ‚úì');
}

function saveRates() {
const tryRates = getMonthlyRatesFromGrid('monthlyRatesTRY');
const rubRates = getMonthlyRatesFromGrid('monthlyRatesRUB');

// Validate all rates
const hasInvalidTRY = tryRates.some(r => !r || r <= 0);
const hasInvalidRUB = rubRates.some(r => !r || r <= 0);

if (hasInvalidTRY || hasInvalidRUB) {
showToast('T√ºm kurlarƒ± ge√ßerli girin');
return;
}

monthlyRates.TRY = tryRates;
monthlyRates.RUB = rubRates;

// Geriye uyumluluk i√ßin mevcut ay kurunu da g√ºncelle
exchangeRates.TRY = tryRates[currentMonth];
exchangeRates.RUB = rubRates[currentMonth];

closeModal('ratesModal');
saveData();
updateCurrentRatesDisplay();
showToast('Kurlar g√ºncellendi ‚úì');
}


// ==================== OTOMATIK KUR G√úNCELLEME ====================
let cachedLiveRates = { TRY: null, RUB: null, timestamp: null };

async function fetchCurrentRates() {
const icon = document.getElementById('fetchRateIcon');
const display = document.getElementById('currentRateDisplay');

// Animasyon ba≈ülat
icon.classList.add('fa-spin');

try {
// Frankfurter API - √ºcretsiz ve CORS destekli
const response = await fetch('https://api.frankfurter.app/latest?from=USD&to=TRY,RUB');

if (!response.ok) {
throw new Error('API yanƒ±t vermedi');
}

const data = await response.json();

if (data.rates && data.rates.TRY && data.rates.RUB) {
cachedLiveRates.TRY = data.rates.TRY;
cachedLiveRates.RUB = data.rates.RUB;
cachedLiveRates.timestamp = new Date();

// G√∂sterimi g√ºncelle
document.getElementById('liveRateTRY').textContent = data.rates.TRY.toFixed(4);
document.getElementById('liveRateRUB').textContent = data.rates.RUB.toFixed(4);
document.getElementById('rateUpdateTime').textContent =
`Son g√ºncelleme: ${cachedLiveRates.timestamp.toLocaleString('tr-TR')}`;

display.style.display = 'block';
showToast('G√ºncel kurlar alƒ±ndƒ± ‚úì');
} else {
throw new Error('Kur verisi alƒ±namadƒ±');
}
} catch (error) {
console.error('Kur API hatasƒ±:', error);

// Yedek API dene - ExchangeRate API
try {
const backupResponse = await fetch('https://open.er-api.com/v6/latest/USD');
const backupData = await backupResponse.json();

if (backupData.rates && backupData.rates.TRY && backupData.rates.RUB) {
cachedLiveRates.TRY = backupData.rates.TRY;
cachedLiveRates.RUB = backupData.rates.RUB;
cachedLiveRates.timestamp = new Date();

document.getElementById('liveRateTRY').textContent = backupData.rates.TRY.toFixed(4);
document.getElementById('liveRateRUB').textContent = backupData.rates.RUB.toFixed(4);
document.getElementById('rateUpdateTime').textContent =
`Son g√ºncelleme: ${cachedLiveRates.timestamp.toLocaleString('tr-TR')}`;

display.style.display = 'block';
showToast('G√ºncel kurlar alƒ±ndƒ± ‚úì');
} else {
throw new Error('Yedek API de √ßalƒ±≈ümadƒ±');
}
} catch (backupError) {
showToast('Kurlar alƒ±namadƒ±, internet baƒülantƒ±nƒ±zƒ± kontrol edin');
}
} finally {
icon.classList.remove('fa-spin');
}
}

function fillAllMonthsWithCurrent() {
if (!cachedLiveRates.TRY || !cachedLiveRates.RUB) {
showToast('√ñnce "G√ºncel Kurlarƒ± Al" butonuna tƒ±klayƒ±n');
return;
}

// T√ºm aylara g√ºncel kuru uygula
const tryInputs = document.querySelectorAll('#monthlyRatesTRY input');
const rubInputs = document.querySelectorAll('#monthlyRatesRUB input');

tryInputs.forEach(input => {
input.value = cachedLiveRates.TRY.toFixed(2);
});

rubInputs.forEach(input => {
input.value = cachedLiveRates.RUB.toFixed(2);
});

showToast('T√ºm aylara g√ºncel kur uygulandƒ± ‚úì');
}

function fillCurrentMonthWithLiveRate() {
if (!cachedLiveRates.TRY || !cachedLiveRates.RUB) {
return;
}

const tryInputs = document.querySelectorAll('#monthlyRatesTRY input');
const rubInputs = document.querySelectorAll('#monthlyRatesRUB input');

// Sadece mevcut ayƒ± g√ºncelle
if (tryInputs[currentMonth]) {
tryInputs[currentMonth].value = cachedLiveRates.TRY.toFixed(2);
}
if (rubInputs[currentMonth]) {
rubInputs[currentMonth].value = cachedLiveRates.RUB.toFixed(2);
}
}

// ==================== DELETE ====================
function confirmDelete(type, id, categoryType, name) {
const message = document.getElementById('confirmMessage');

if (type === 'category') {
const count = transactions.filter(t => t.categoryId === id).length;
message.textContent = count > 0
? `"${name}" ve ${count} i≈ülem silinecek.`
: `"${name}" silinecek.`;
deleteCallback = () => deleteCategory(id, categoryType);
} else {
message.textContent = 'Bu i≈ülem silinecek.';
deleteCallback = () => deleteTransaction(id);
}

document.getElementById('confirmModal').classList.add('active');
}

function closeConfirm() {
document.getElementById('confirmModal').classList.remove('active');
deleteCallback = null;
}

document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
if (deleteCallback) {
deleteCallback();
closeConfirm();
}
});

function deleteCategory(id, type) {
categories[type] = categories[type].filter(c => c.id !== id);
transactions = transactions.filter(t => t.categoryId !== id);
saveData();
updateAll();
showToast('Silindi');
}

function deleteTransaction(id) {
transactions = transactions.filter(t => t.id !== id);
saveData();
updateAll();
showToast('Silindi');
}

// ==================== INSTALL BANNER ====================
function showInstallBanner() {
document.getElementById('installBanner').classList.add('show');
}

function hideInstallBanner() {
document.getElementById('installBanner').classList.remove('show');
}

// ==================== TOAST ====================
function showToast(message) {
const existing = document.querySelector('.toast');
if (existing) existing.remove();

const toast = document.createElement('div');
toast.className = 'toast';
toast.textContent = message;
document.body.appendChild(toast);

setTimeout(() => {
toast.style.opacity = '0';
toast.style.transition = 'opacity 0.3s';
setTimeout(() => toast.remove(), 300);
}, 2000);
}

// ==================== UPDATE ALL ====================
function updateAll() {
updateSummary();
renderBudgets();
renderMonthFilter();
renderTransactions();
updateBalanceSheet();
}

// ==================== BALANCE SHEET ====================
let editingBalanceField = null;
let selectedBalanceCurrency = 'USD';

function openBalanceModal(field) {
editingBalanceField = field;
selectedBalanceCurrency = 'USD';

// Mevcut deƒüeri ve notu al
let currentValue = 0;
let currentNote = '';
let item;

if (['cash', 'investments', 'receivables'].includes(field)) {
item = balanceSheet.assets[field];
} else {
item = balanceSheet.liabilities[field];
}

// Eski format (sadece sayƒ±) veya yeni format (object) desteƒüi
if (typeof item === 'object' && item !== null) {
currentValue = item.value || 0;
currentNote = item.note || '';
} else {
currentValue = item || 0;
}

document.getElementById('balanceModalTitle').textContent = balanceFieldNames[field];
document.getElementById('balanceValue').value = currentValue.toFixed(2);
document.getElementById('balanceNote').value = currentNote;
updateBalanceCurrencyUI();
document.getElementById('balanceModal').classList.add('active');
}

function setBalanceCurrency(currency) {
// Mevcut deƒüeri USD olarak al
let currentValueUSD = parseFloat(document.getElementById('balanceValue').value) || 0;

// Eƒüer mevcut para birimi USD deƒüilse, √∂nce USD'ye √ßevir
if (selectedBalanceCurrency !== 'USD') {
const oldRate = getCurrentMonthRate(selectedBalanceCurrency);
currentValueUSD = currentValueUSD / oldRate;
}

// Yeni para birimine √ßevir
selectedBalanceCurrency = currency;
if (currency !== 'USD') {
const newRate = getCurrentMonthRate(currency);
document.getElementById('balanceValue').value = (currentValueUSD * newRate).toFixed(2);
} else {
document.getElementById('balanceValue').value = currentValueUSD.toFixed(2);
}

updateBalanceCurrencyUI();
}

function getCurrentMonthRate(currency) {
// G√ºnl√ºk kur - mevcut ayƒ±n kurunu kullan
if (currency === 'USD') return 1;
return getRateForMonth(currency, currentMonth);
}

function updateBalanceCurrencyUI() {
const symbol = currencySymbols[selectedBalanceCurrency];
document.getElementById('balanceValueLabel').textContent = `Deƒüer (${symbol})`;

document.querySelectorAll('#balanceCurrencyToggle .currency-btn').forEach(btn => {
btn.classList.toggle('active', btn.dataset.currency === selectedBalanceCurrency);
});

// G√ºnl√ºk kuru g√∂ster (mevcut ay)
const tryRate = getCurrentMonthRate('TRY');
const rubRate = getCurrentMonthRate('RUB');
document.getElementById('balanceRatesDisplay').innerHTML = `
<span class="rate-chip">${monthNames[currentMonth]}: 1$ = ${tryRate.toFixed(2)}‚Ç∫</span>
<span class="rate-chip">${monthNames[currentMonth]}: 1$ = ${rubRate.toFixed(2)}‚ÇΩ</span>
`;
}

function saveBalanceValue() {
const inputValue = parseFloat(document.getElementById('balanceValue').value) || 0;
const note = document.getElementById('balanceNote').value.trim();
const inputCurrency = selectedBalanceCurrency;
const rate = getCurrentMonthRate(inputCurrency);

// USD'ye √ßevir - g√ºnl√ºk kur kullan
let valueUSD = inputValue;
if (inputCurrency !== 'USD') {
valueUSD = inputValue / rate;
}

// Eski deƒüeri al (fark hesabƒ± i√ßin)
let oldValueUSD = 0;
const isAsset = ['cash', 'investments', 'receivables'].includes(editingBalanceField);
if (isAsset) {
const oldItem = balanceSheet.assets[editingBalanceField];
oldValueUSD = (typeof oldItem === 'object' && oldItem !== null) ? (oldItem.value || 0) : (oldItem || 0);
} else {
const oldItem = balanceSheet.liabilities[editingBalanceField];
oldValueUSD = (typeof oldItem === 'object' && oldItem !== null) ? (oldItem.value || 0) : (oldItem || 0);
}

// Kaydet - value ve note olarak
const data = { value: valueUSD, note: note };

if (isAsset) {
balanceSheet.assets[editingBalanceField] = data;
} else {
balanceSheet.liabilities[editingBalanceField] = data;
}

// ƒ∞≈ülem kaydƒ± olu≈ütur (bilan√ßo g√ºncellemesi)
const diff = valueUSD - oldValueUSD;
const balanceTransaction = {
id: Date.now(),
type: 'balance', // Yeni tip: bilan√ßo i≈ülemi
balanceField: editingBalanceField,
balanceType: isAsset ? 'asset' : 'liability',
oldValue: oldValueUSD,
newValue: valueUSD,
diff: diff,
inputValue: inputValue,
inputCurrency: inputCurrency,
rateAtTime: rate,
note: note,
date: new Date().toISOString().split('T')[0]
};
transactions.push(balanceTransaction);

closeModal('balanceModal');
saveData();
updateBalanceSheet();
updateAll();
showToast('Kaydedildi ‚úì');
}

function updateBalanceSheet() {
// Helper fonksiyonlar - eski (sayƒ±) veya yeni (object) formatƒ± destekle
const getValue = (item) => {
if (typeof item === 'object' && item !== null) {
return item.value || 0;
}
return item || 0;
};
const getNote = (item) => {
if (typeof item === 'object' && item !== null) {
return item.note || '';
}
return '';
};

// Assets
const cash = getValue(balanceSheet.assets.cash);
const investments = getValue(balanceSheet.assets.investments);
const receivables = getValue(balanceSheet.assets.receivables);
const totalAssets = cash + investments + receivables;

// Liabilities
const credits = getValue(balanceSheet.liabilities.credits);
const debitCards = getValue(balanceSheet.liabilities.debitCards);
const debts = getValue(balanceSheet.liabilities.debts);
const totalLiabilities = credits + debitCards + debts;

// Equity
const totalEquity = totalAssets - totalLiabilities;

// Update UI - Assets (deƒüerler)
document.getElementById('bsCash').textContent = formatCurrency(cash);
document.getElementById('bsInvestments').textContent = formatCurrency(investments);
document.getElementById('bsReceivables').textContent = formatCurrency(receivables);
document.getElementById('bsTotalAssets').textContent = formatCurrency(totalAssets);

// Update UI - Assets (notlar)
document.getElementById('bsCashNote').textContent = getNote(balanceSheet.assets.cash);
document.getElementById('bsInvestmentsNote').textContent = getNote(balanceSheet.assets.investments);
document.getElementById('bsReceivablesNote').textContent = getNote(balanceSheet.assets.receivables);

// Update UI - Liabilities (deƒüerler)
document.getElementById('bsCredits').textContent = formatCurrency(credits);
document.getElementById('bsDebitCards').textContent = formatCurrency(debitCards);
document.getElementById('bsDebts').textContent = formatCurrency(debts);
document.getElementById('bsTotalLiabilities').textContent = formatCurrency(totalLiabilities);

// Update UI - Liabilities (notlar)
document.getElementById('bsCreditsNote').textContent = getNote(balanceSheet.liabilities.credits);
document.getElementById('bsDebitCardsNote').textContent = getNote(balanceSheet.liabilities.debitCards);
document.getElementById('bsDebtsNote').textContent = getNote(balanceSheet.liabilities.debts);

// Update UI - Equity
document.getElementById('eqAssets').textContent = formatCurrency(totalAssets);
document.getElementById('eqLiabilities').textContent = formatCurrency(totalLiabilities);
document.getElementById('bsTotalEquity').textContent = formatCurrency(totalEquity);

// Equity kartƒ±nƒ±n rengini g√ºncelle
const eqResult = document.getElementById('eqResult');
if (totalEquity >= 0) {
eqResult.style.background = 'rgba(255,255,255,0.25)';
} else {
eqResult.style.background = 'rgba(255,100,100,0.4)';
}
}

// ==================== INIT ====================
// Firebase listener'ƒ± ba≈ülat - bu veriyi y√ºkleyecek ve deƒüi≈üiklikleri dinleyecek
initFirebaseListener();

document.getElementById('yearDisplay').textContent = currentYear;
document.getElementById('monthDisplay').textContent = monthNamesFull[currentMonth];

// ƒ∞lk UI g√ºncelleme (Firebase verisi gelene kadar bo≈ü g√∂r√ºnecek)
updateAll();

// Show install banner for iOS Safari
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
const isStandalone = window.navigator.standalone === true;
if (isIOS && !isStandalone) {
setTimeout(showInstallBanner, 2000);
}
</script>
</body>
</html>
